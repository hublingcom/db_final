<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NPS Mirror Intelligence v3</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+KR:wght@300;400;500;600&family=IBM+Plex+Mono:wght@400;500&family=Sora:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<link rel="stylesheet" href="nps_style_v3.css">
</head>
<body>

<!-- ══ SIDEBAR ══ -->
<aside id="sidebar">
  <div class="sb-logo">
    <div class="sb-logo-mark">NPS</div>
    <div class="sb-logo-text">
      <div class="sb-brand">Mirror Intelligence</div>
      <div class="sb-version">v3.0 · 국민연금 분석</div>
    </div>
  </div>

  <nav class="sb-nav">
    <div class="sb-section-label">분석</div>
    <button class="sb-item active" data-page="p-dash">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
      대시보드
    </button>
    <button class="sb-item" data-page="p-domestic">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg>
      국내주식
    </button>
    <button class="sb-item" data-page="p-foreign">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
      미국주식
    </button>
    <div class="sb-section-label">도구</div>
    <button class="sb-item" data-page="p-date">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
      날짜 예측·검증
    </button>
    <button class="sb-item" data-page="p-sim">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
      투자 시뮬레이터
    </button>
    <div class="sb-section-label">모델</div>
    <button class="sb-item" data-page="p-model">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
      모델 성능
    </button>
    <button class="sb-item" data-page="p-sector">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg>
      섹터 베타
    </button>
    <button class="sb-item" data-page="p-data">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>
      전체 데이터
    </button>
  </nav>

  <div class="sb-footer">
    <div class="sb-live-dot"></div>
    <span id="sb-time">--:--:--</span>
    <span class="sb-model-tag">Y_opt_D · α=0.915</span>
  </div>
</aside>

<!-- ══ MAIN ══ -->
<div id="app-wrap">

<!-- ══════════ PAGE: DASHBOARD ══════════ -->
<section class="page active" id="p-dash">
  <div class="page-header">
    <div>
      <h1 class="page-title">대시보드</h1>
      <p class="page-sub">NPS 포트폴리오 미러링 · 국민연금 공시 데이터 기반 장기+단기 신호 결합</p>
    </div>
    <div class="info-pill">Final = 0.915 × Y_opt_D + 0.085 × Z</div>
  </div>

  <div class="kpi-grid" id="dash-kpi"></div>

  <div class="card-grid g2 mt16">
    <div class="card">
      <div class="card-hd">연도별 포트폴리오 수익률 vs 벤치마크</div>
      <div class="chart-box h280"><canvas id="c-dash-perf"></canvas></div>
    </div>
    <div class="card">
      <div class="card-hd">국내 Top-10 수익률 (2023년)</div>
      <div class="chart-box h280"><canvas id="c-dash-top10d"></canvas></div>
    </div>
  </div>

  <div class="card-grid g2 mt16">
    <div class="card">
      <div class="card-hd">모델 공식 요약</div>
      <div class="formula-box">
        <div class="formula-row">
          <span class="formula-label">국내 Y_opt</span>
          <code>0.688×mom + 0.240×trend + 0.030×value + 0.029×dart + 0.007×vol + 0.006×wgt</code>
        </div>
        <div class="formula-row">
          <span class="formula-label">해외 Y_opt_D</span>
          <code>-0.852×value - 0.420×stake - 0.235×trend - 0.171×sec - 0.445×bulk</code>
        </div>
        <div class="formula-row highlight">
          <span class="formula-label">국내 Final</span>
          <code>0.852 × Y_opt + 0.148 × Z_score_norm</code>
        </div>
        <div class="formula-row highlight">
          <span class="formula-label">해외 Final</span>
          <code>0.915 × Y_opt_D + 0.085 × Z_score_norm</code>
        </div>
        <div class="formula-row">
          <span class="formula-label">섹터 베타</span>
          <code>β = 0.2317 × IC + 0.4024 · (IC &lt; 0 → β = 0.20)</code>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-hd">해외 Top-10 수익률 (2023년)</div>
      <div class="chart-box h280"><canvas id="c-dash-top10f"></canvas></div>
    </div>
  </div>
</section>

<!-- ══════════ PAGE: DOMESTIC ══════════ -->
<section class="page" id="p-domestic">
  <div class="page-header">
    <div>
      <h1 class="page-title">국내주식 분석</h1>
      <p class="page-sub">국내 상위 종목 스코어 · 수익률 · NPS 보유 비중</p>
    </div>
  </div>

  <div class="ctrl-bar">
    <div class="ctrl-group">
      <label>기준 연도</label>
      <select id="dom-year" onchange="renderDomestic()">
        <option value="2021">2021</option>
        <option value="2022">2022</option>
        <option value="2023">2023</option>
        <option value="2024" selected>2024</option>
      </select>
    </div>
    <div class="ctrl-group">
      <label>상위 N종목: <b id="dom-n-val">20</b></label>
      <input type="range" id="dom-n" min="5" max="50" value="20" oninput="document.getElementById('dom-n-val').textContent=this.value;renderDomestic()">
    </div>
    <div class="ctrl-group">
      <label>정렬</label>
      <select id="dom-sort" onchange="renderDomestic()">
        <option value="Final_Score">최종 스코어</option>
        <option value="Y_opt">Y_opt</option>
        <option value="Z_score_norm">Z-스코어</option>
        <option value="연간수익률(r_t)">연간 수익률</option>
        <option value="weight">NPS 비중</option>
      </select>
    </div>
    <div class="ctrl-group">
      <label>섹터</label>
      <select id="dom-sector" onchange="renderDomestic()">
        <option value="all">전체</option>
      </select>
    </div>
  </div>

  <div class="kpi-grid" id="dom-kpi"></div>

  <div class="card-grid g2 mt16">
    <div class="card">
      <div class="card-hd">Y_opt vs Z-score 산점도</div>
      <div class="chart-box h280"><canvas id="c-dom-scatter"></canvas></div>
    </div>
    <div class="card">
      <div class="card-hd">Top N 수익률 분포</div>
      <div class="chart-box h280"><canvas id="c-dom-ret"></canvas></div>
    </div>
  </div>

  <div class="card mt16">
    <div class="card-hd" id="dom-tbl-title">2024년 Top 20 국내주식</div>
    <div class="tbl-wrap">
      <table id="t-domestic">
        <thead><tr>
          <th>#</th><th>종목명</th><th>코드</th>
          <th>Final Score</th><th>Y_opt</th><th>Z-score</th>
          <th>NPS 비중%</th><th>연간수익률</th><th>3M 모멘텀</th><th>변동성</th><th>DART</th>
        </tr></thead>
        <tbody id="tbody-domestic"></tbody>
      </table>
    </div>
  </div>
</section>

<!-- ══════════ PAGE: FOREIGN ══════════ -->
<section class="page" id="p-foreign">
  <div class="page-header">
    <div>
      <h1 class="page-title">미국주식 분석</h1>
      <p class="page-sub">Y_opt_D 공식 · 섹터 베타 가중 모델 (Final = 0.915×Y + 0.085×Z)</p>
    </div>
    <div class="info-pill">IC 안정성 std=0.057 · LOYO CV 검증</div>
  </div>

  <div class="ctrl-bar">
    <div class="ctrl-group">
      <label>기준 연도</label>
      <select id="fgn-year" onchange="renderForeign()">
        <option value="2021">2021</option>
        <option value="2022">2022</option>
        <option value="2023" selected>2023</option>
      </select>
    </div>
    <div class="ctrl-group">
      <label>상위 N종목: <b id="fgn-n-val">15</b></label>
      <input type="range" id="fgn-n" min="3" max="30" value="15" oninput="document.getElementById('fgn-n-val').textContent=this.value;renderForeign()">
    </div>
    <div class="ctrl-group">
      <label>정렬</label>
      <select id="fgn-sort" onchange="renderForeign()">
        <option value="final_score_new">Final Score(신)</option>
        <option value="final_score">Final Score(구)</option>
        <option value="Y_opt_score">Y_opt_D</option>
        <option value="Z_score_norm">Z-score</option>
        <option value="actual_return">실제 수익률</option>
      </select>
    </div>
  </div>

  <div class="kpi-grid" id="fgn-kpi"></div>

  <div class="card-grid g2 mt16">
    <div class="card">
      <div class="card-hd">섹터별 평균 Final Score</div>
      <div class="chart-box h280"><canvas id="c-fgn-sector"></canvas></div>
    </div>
    <div class="card">
      <div class="card-hd">Y_opt_D vs 실제 수익률 (IC 검증)</div>
      <div class="chart-box h280"><canvas id="c-fgn-scatter"></canvas></div>
    </div>
  </div>

  <div class="card mt16">
    <div class="card-hd" id="fgn-tbl-title">2023년 Top 15 해외주식</div>
    <div class="tbl-wrap">
      <table id="t-foreign">
        <thead><tr>
          <th>#</th><th>종목명</th><th>티커</th>
          <th>Final(신)</th><th>Y_opt_D</th><th>Z-score</th>
          <th>NPS 비중%</th><th>stake</th><th>trend</th><th>sec_score</th><th>실제 수익률</th>
        </tr></thead>
        <tbody id="tbody-foreign"></tbody>
      </table>
    </div>
  </div>

  <div class="card mt16">
    <div class="card-hd">연도별 IC 추이 (모델 검증)</div>
    <div class="chart-box h240"><canvas id="c-fgn-ic"></canvas></div>
  </div>
</section>

<!-- ══════════ PAGE: DATE PREDICTION ══════════ -->
<section class="page" id="p-date">
  <div class="page-header">
    <div>
      <h1 class="page-title">날짜 예측 · 검증</h1>
      <p class="page-sub">날짜 입력 → 데이터 내 날짜면 실제 비교 · 미래 날짜면 예측 생성 · 장 운영시간(9:00~15:30)엔 실시간 연동</p>
    </div>
  </div>

  <div class="alert-box">
    ⚠️ 실시간 주가는 Yahoo Finance API 연동 (장 운영시간 자동 활성화). 투자 의사결정에 직접 사용 금지.
  </div>

  <div class="card mt16">
    <div class="card-hd">📅 날짜 & 포트폴리오 설정</div>
    <div class="ctrl-bar" style="flex-wrap:wrap;gap:12px;padding:0">
      <div class="ctrl-group">
        <label>투자 기준일</label>
        <input type="date" id="date-from" value="2023-01-01">
      </div>
      <div class="ctrl-group">
        <label>시장</label>
        <select id="date-market">
          <option value="domestic">국내 (KOSPI)</option>
          <option value="foreign">미국 (NYSE/NASDAQ)</option>
        </select>
      </div>
      <div class="ctrl-group">
        <label>Top N종목</label>
        <input type="number" id="date-topn" value="10" min="1" max="50" style="width:80px">
      </div>
      <div class="ctrl-group">
        <label>투자 금액 (만원)</label>
        <input type="number" id="date-amt" value="1000" min="10" step="100" style="width:120px">
      </div>
      <button class="btn-primary" onclick="runDateForecast()">🔮 예측 실행</button>
    </div>
  </div>

  <div class="kpi-grid mt16" id="date-kpi"></div>

  <div class="card-grid g2 mt16">
    <div class="card">
      <div class="card-hd">예측 수익률 분포</div>
      <div class="chart-box h260"><canvas id="c-date-bar"></canvas></div>
    </div>
    <div class="card">
      <div class="card-hd">포트폴리오 배분</div>
      <div class="chart-box h260"><canvas id="c-date-pie"></canvas></div>
    </div>
  </div>

  <div class="card mt16">
    <div class="card-hd">
      포트폴리오 상세
      <span class="badge" id="date-mode-badge">대기</span>
    </div>
    <div class="tbl-wrap">
      <table id="t-date">
        <thead><tr>
          <th>#</th><th>종목명</th><th>티커</th>
          <th>스코어</th><th>배분 비중</th><th>투자금(만원)</th>
          <th>예측 수익률</th><th>예상 손익(만원)</th><th>상태</th>
        </tr></thead>
        <tbody id="tbody-date"></tbody>
      </table>
    </div>
  </div>
</section>

<!-- ══════════ PAGE: SIMULATOR ══════════ -->
<section class="page" id="p-sim">
  <div class="page-header">
    <div>
      <h1 class="page-title">투자 시뮬레이터</h1>
      <p class="page-sub">실제 수익률 기반 백테스트 · 투자 금액 직접 입력</p>
    </div>
  </div>

  <div class="ctrl-bar">
    <div class="ctrl-group">
      <label>투자 연도</label>
      <select id="sim-year" onchange="renderSim()">
        <option value="2021">2021년 국내</option>
        <option value="2022">2022년 국내</option>
        <option value="2023" selected>2023년 국내</option>
        <option value="fgn2021">2021년 해외</option>
        <option value="fgn2022">2022년 해외</option>
        <option value="fgn2023">2023년 해외</option>
      </select>
    </div>
    <div class="ctrl-group">
      <label>투자 금액 (만원)</label>
      <input type="number" id="sim-amt" value="1000" min="100" max="1000000" step="100" oninput="renderSim()">
    </div>
    <div class="ctrl-group">
      <label>Top N: <b id="sim-n-val">10</b></label>
      <input type="range" id="sim-n" min="1" max="30" value="10" oninput="document.getElementById('sim-n-val').textContent=this.value;renderSim()">
    </div>
    <div class="ctrl-group">
      <label>배분 방식</label>
      <select id="sim-weight" onchange="renderSim()">
        <option value="equal">균등 배분</option>
        <option value="score">스코어 비례</option>
        <option value="nps">NPS 비중 비례</option>
      </select>
    </div>
  </div>

  <div class="kpi-grid" id="sim-kpi"></div>

  <div class="card-grid g2 mt16">
    <div class="card">
      <div class="card-hd">포트폴리오 구성 (배분 비중)</div>
      <div class="chart-box h280"><canvas id="c-sim-pie"></canvas></div>
    </div>
    <div class="card">
      <div class="card-hd">종목별 수익률</div>
      <div class="chart-box h280"><canvas id="c-sim-bar"></canvas></div>
    </div>
  </div>

  <div class="card mt16">
    <div class="card-hd" id="sim-tbl-title">포트폴리오 결과</div>
    <div class="tbl-wrap">
      <table>
        <thead><tr>
          <th>#</th><th>종목명</th><th>스코어</th>
          <th>배분 비중%</th><th>투자금(만원)</th><th>수익률</th><th>손익(만원)</th><th>평가금(만원)</th>
        </tr></thead>
        <tbody id="tbody-sim"></tbody>
      </table>
    </div>
  </div>
</section>

<!-- ══════════ PAGE: MODEL PERFORMANCE ══════════ -->
<section class="page" id="p-model">
  <div class="page-header">
    <div>
      <h1 class="page-title">모델 성능 분석</h1>
      <p class="page-sub">LOYO Cross-Validation · IC 분석 · 국내/해외 모델 비교</p>
    </div>
  </div>

  <div class="kpi-grid" id="model-kpi"></div>

  <div class="card-grid g2 mt16">
    <div class="card">
      <div class="card-hd">연도별 IC (Spearman) — 국내</div>
      <div class="chart-box h280"><canvas id="c-model-ic-dom"></canvas></div>
    </div>
    <div class="card">
      <div class="card-hd">연도별 IC (Spearman) — 해외</div>
      <div class="chart-box h280"><canvas id="c-model-ic-fgn"></canvas></div>
    </div>
  </div>

  <div class="card-grid g2 mt16">
    <div class="card">
      <div class="card-hd">Top-N별 평균 수익률 (국내 LOYO)</div>
      <div class="chart-box h260"><canvas id="c-model-topn"></canvas></div>
    </div>
    <div class="card">
      <div class="card-hd">알파 민감도 분석 (해외 Y:Z 비율)</div>
      <div class="chart-box h260"><canvas id="c-model-alpha"></canvas></div>
    </div>
  </div>

  <div class="card mt16">
    <div class="card-hd">모델 버전별 성능 비교</div>
    <div class="tbl-wrap">
      <table id="t-model-compare">
        <thead><tr>
          <th>모델</th><th>대상</th><th>2021 IC</th><th>2022 IC</th><th>2023 IC</th><th>평균 IC</th>
          <th>2021 Top30</th><th>2022 Top30</th><th>2023 Top30</th><th>평균 Top30</th>
        </tr></thead>
        <tbody id="tbody-model"></tbody>
      </table>
    </div>
  </div>
</section>

<!-- ══════════ PAGE: SECTOR BETA ══════════ -->
<section class="page" id="p-sector">
  <div class="page-header">
    <div>
      <h1 class="page-title">섹터 베타 분석</h1>
      <p class="page-sub">β = 0.2317 × IC + 0.4024 · IC &lt; 0 → β = 0.20 (최솟값)</p>
    </div>
  </div>

  <div class="ctrl-bar">
    <div class="ctrl-group">
      <label>시장</label>
      <select id="sec-market" onchange="renderSector()">
        <option value="domestic">국내</option>
        <option value="foreign">해외</option>
      </select>
    </div>
  </div>

  <div class="card-grid g2 mt16">
    <div class="card">
      <div class="card-hd">섹터별 평균 β</div>
      <div class="chart-box h320"><canvas id="c-sec-beta"></canvas></div>
    </div>
    <div class="card">
      <div class="card-hd">섹터별 평균 IC</div>
      <div class="chart-box h320"><canvas id="c-sec-ic"></canvas></div>
    </div>
  </div>

  <div class="card mt16">
    <div class="card-hd" id="sec-tbl-title">섹터 베타 상세</div>
    <div class="tbl-wrap">
      <table id="t-sector">
        <thead><tr>
          <th>섹터</th><th>종목수</th>
          <th>2021 β</th><th>2022 β</th><th>2023 β</th><th>평균 β</th>
          <th>2021 IC</th><th>2022 IC</th><th>2023 IC</th><th>평균 IC</th>
          <th>Top-K 수익률</th>
        </tr></thead>
        <tbody id="tbody-sector"></tbody>
      </table>
    </div>
  </div>
</section>

<!-- ══════════ PAGE: ALL DATA ══════════ -->
<section class="page" id="p-data">
  <div class="page-header">
    <div>
      <h1 class="page-title">전체 데이터 뷰어</h1>
      <p class="page-sub">모든 원본 데이터 · 검색 · 필터</p>
    </div>
  </div>

  <div class="ctrl-bar">
    <div class="ctrl-group">
      <label>데이터셋</label>
      <select id="data-ds" onchange="renderDataViewer()">
        <option value="domestic">국내주식 (y_score_real_final)</option>
        <option value="foreign">해외주식 (foreign_final_score_updated)</option>
        <option value="zscore">국내 Z-score (z_score_v3)</option>
        <option value="dsec">국내 섹터 베타</option>
        <option value="fsec">해외 섹터 베타</option>
      </select>
    </div>
    <div class="ctrl-group">
      <label>연도</label>
      <select id="data-year" onchange="renderDataViewer()">
        <option value="all">전체</option>
        <option value="2021">2021</option>
        <option value="2022">2022</option>
        <option value="2023">2023</option>
        <option value="2024">2024</option>
      </select>
    </div>
    <div class="ctrl-group" style="flex:1;max-width:300px">
      <label>종목명 검색</label>
      <input type="text" id="data-search" placeholder="종목명 입력..." oninput="renderDataViewer()">
    </div>
    <div class="ctrl-group">
      <label>표시 행수</label>
      <select id="data-rows" onchange="renderDataViewer()">
        <option value="50">50행</option>
        <option value="100" selected>100행</option>
        <option value="200">200행</option>
        <option value="9999">전체</option>
      </select>
    </div>
  </div>

  <div class="card mt16">
    <div class="card-hd" id="data-tbl-title">데이터</div>
    <div class="tbl-wrap tbl-scroll-x">
      <table id="t-data">
        <thead id="thead-data"></thead>
        <tbody id="tbody-data"></tbody>
      </table>
    </div>
    <div class="tbl-footer" id="data-count"></div>
  </div>
</section>

</div><!-- /app-wrap -->

<script>
// ══════════════════════════════════════════════════════
//  DATA
// ══════════════════════════════════════════════════════
// ══════════════════════════════════════════════════════
//  DATA  —  loaded async from /data/*.json
// ══════════════════════════════════════════════════════
const DATA = { domestic:[], foreign:[], zscore:[], fsec_raw:[], fsec:[], dsec:[] };
let _loaded = {};

async function loadData(key, url) {
  if(_loaded[key]) return;
  try {
    const res = await fetch(url);
    const json = await res.json();
    if(key==='domestic_all') {
      DATA.domestic = json;
    } else if(key==='foreign') {
      DATA.foreign = json;
      // compute Y_opt_D score
      const w = [-0.8524,-0.4204,-0.2346,-0.1714,-0.4450];
      const fts = ['value_score','stake_score','trend_score','sec_score','bulk'];
      const years = [...new Set(json.map(r=>+r.year))];
      years.forEach(yr=>{
        const sub = json.filter(r=>+r.year===yr);
        const raws = sub.map(r=>fts.reduce((s,f,i)=>s+w[i]*(+r[f]||0),0));
        const mn=Math.min(...raws), mx=Math.max(...raws);
        sub.forEach((r,i)=>{ r.Y_opt_score = mx>mn ? (raws[i]-mn)/(mx-mn)*100 : 50; });
        sub.forEach(r=>{ r.final_score_new = 0.915*(r.Y_opt_score/100)+0.085*(+r.Z_score_norm||0); });
      });
    } else if(key==='zscore') {
      DATA.zscore = json;
    } else if(key==='fsec') {
      DATA.fsec_raw = json;
      DATA.fsec = json.slice(1).map(r=>({
        sector: r[Object.keys(r)[0]], eng: r['Unnamed: 1'], n: r['Unnamed: 2'],
        b2021:+r['Unnamed: 3']||0, b2022:+r['Unnamed: 4']||0, b2023:+r['Unnamed: 5']||0,
        bavg: +r['Unnamed: 6']||0, ic2021:+r['Unnamed: 7']||0, ic2022:+r['Unnamed: 8']||0,
        ic2023:+r['Unnamed: 9']||0, icavg:+r['Unnamed: 10']||0, topk:+r['Unnamed: 11']||0,
      })).filter(r=>r.sector && typeof r.sector==='string');
    } else if(key==='dsec') {
      DATA.dsec = json;
    }
    _loaded[key] = true;
  } catch(e) { console.error('fetch error', key, e); }
}

async function ensureDomestic(yr) {
  const key = 'dom_'+yr;
  if(!_loaded[key]) {
    await loadData('domestic_all', `data/domestic_${yr}.json`);
    _loaded[key]=true;
    // merge into DATA.domestic (replace same year)
    DATA.domestic = DATA.domestic.filter(r=>+r.year!==+yr);
    const loaded = DATA[`_dom${yr}`] || [];
    // re-fetch properly
  }
}

// Better: load each year into DATA.domestic accumulator
async function loadDomesticYear(yr) {
  const key = `dom${yr}`;
  if(_loaded[key]) return;
  const res  = await fetch(`data/domestic_${yr}.json`);
  const json = await res.json();
  DATA.domestic = DATA.domestic.filter(r=>+r.year!==+yr).concat(json);
  _loaded[key] = true;
}

async function ensureYear(yr, market) {
  if(market==='foreign') {
    if(!_loaded['foreign']) await loadData('foreign','data/foreign.json');
  } else {
    await loadDomesticYear(yr);
  }
}

async function ensureSupport() {
  const tasks = [];
  if(!_loaded['zscore']) tasks.push(loadData('zscore','data/zscore.json'));
  if(!_loaded['fsec'])   tasks.push(loadData('fsec','data/fsec.json'));
  if(!_loaded['dsec'])   tasks.push(loadData('dsec','data/dsec.json'));
  await Promise.all(tasks);
}

// ══════════════════════════════════════════════════════
//  NAVIGATION
// ══════════════════════════════════════════════════════
document.querySelectorAll('.sb-item').forEach(btn => {
  btn.addEventListener('click', () => {
    const pid = btn.dataset.page;
    document.querySelectorAll('.sb-item').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(pid).classList.add('active');
    if(pid==='p-dash') renderDash();
    if(pid==='p-domestic') renderDomestic();
    if(pid==='p-foreign') renderForeign();
    if(pid==='p-model') renderModel();
    if(pid==='p-sector') renderSector();
    if(pid==='p-sim') renderSim();
    if(pid==='p-data') renderDataViewer();
  });
});

// ══════════════════════════════════════════════════════
//  HELPERS
// ══════════════════════════════════════════════════════
const charts = {};
function mkChart(id, cfg) {
  if(charts[id]) { charts[id].destroy(); }
  const ctx = document.getElementById(id);
  if(!ctx) return;
  charts[id] = new Chart(ctx, cfg);
  return charts[id];
}

function kpi(id, items) {
  const el = document.getElementById(id);
  if(!el) return;
  el.innerHTML = items.map(({label, value, sub, trend})=>`
    <div class="kpi-card">
      <div class="kpi-label">${label}</div>
      <div class="kpi-value ${trend==='up'?'up':trend==='down'?'down':''}">${value}</div>
      ${sub?`<div class="kpi-sub">${sub}</div>`:''}
    </div>`).join('');
}

function fmt(v, dec=2) { return v==null||isNaN(v)?'—':(+v).toFixed(dec); }
function pct(v) {
  const n = +v;
  if(isNaN(n)) return '<span>—</span>';
  const cls = n>0?'pos':n<0?'neg':'';
  return `<span class="${cls}">${n>0?'+':''}${n.toFixed(2)}%</span>`;
}
function scoreBar(v, max=100) {
  const w = Math.min(100, Math.max(0, (v/max)*100));
  return `<div class="score-cell"><span>${fmt(v)}</span><div class="score-bar"><div class="score-fill" style="width:${w}%"></div></div></div>`;
}

const COLORS = ['#1a1a2e','#374151','#6b7280','#9ca3af','#d1d5db','#374151'];
const CHART_COLORS = ['#1f2937','#374151','#4b5563','#6b7280','#9ca3af','#d1d5db','#111827','#1e3a5f','#0f3460'];

// ══════════════════════════════════════════════════════
//  CLOCK & MARKET STATUS
// ══════════════════════════════════════════════════════
function updateClock() {
  const now = new Date();
  const kst = new Date(now.toLocaleString('en-US', {timeZone:'Asia/Seoul'}));
  const hms = kst.toTimeString().slice(0,8);
  document.getElementById('sb-time').textContent = hms;
  const h = kst.getHours(), m = kst.getMinutes();
  const isOpen = kst.getDay()>0 && kst.getDay()<6 && (h>9||(h===9&&m>=0)) && h<15 || (h===15&&m<30);
  document.querySelector('.sb-live-dot').style.background = isOpen ? '#16a34a' : '#9ca3af';
}
setInterval(updateClock, 1000); updateClock();

// ══════════════════════════════════════════════════════
//  DASHBOARD
// ══════════════════════════════════════════════════════
async function renderDash() {
  // KPI
  const years = [2021,2022,2023];
  const domPerf = {2021:132.4,2022:22.8,2023:164.7,2024:105.7};
  const fgnPerf = {2021:4.7, 2022:56.3, 2023:36.0};
  kpi('dash-kpi', [
    {label:'국내 LOYO 평균 Top30', value:'+132.4%', sub:'2021-2024 기준', trend:'up'},
    {label:'해외 LOYO 평균 Top30', value:'+32.2%',  sub:'2021-2023 Y_opt_D', trend:'up'},
    {label:'국내 최종 Final α', value:'0.852', sub:'Y:Z 혼합 비율'},
    {label:'해외 최종 Final α', value:'0.915', sub:'Y_opt_D:Z 혼합 비율'},
    {label:'국내 평균 IC', value:'0.252', sub:'Spearman', trend:'up'},
    {label:'해외 평균 IC', value:'0.257', sub:'Y_opt_D 기준', trend:'up'},
  ]);

  // Performance chart
  mkChart('c-dash-perf', {
    type:'bar',
    data:{
      labels:['2021','2022','2023','2024'],
      datasets:[
        {label:'국내 Top30',   data:[132.4,22.8,164.7,105.7], backgroundColor:'#1f2937'},
        {label:'해외 Top30',   data:[4.7,56.3,36.0,null],      backgroundColor:'#6b7280'},
        {label:'KOSPI 평균',   data:[22.8,-18.8,24.3,-6.1],    backgroundColor:'#d1d5db'},
      ]
    },
    options:{...baseBarOpts(), plugins:{...baseBarOpts().plugins, legend:{display:true, position:'bottom', labels:{color:'#374151',font:{family:'IBM Plex Sans KR',size:11}}}}}
  });

  // Domestic top10 2023
  const dom23 = DATA.domestic.filter(r=>+r.year===2023 && r.asset_class==='domestic_equity')
    .sort((a,b)=>b['Final_Score']-a['Final_Score']).slice(0,10);
  mkChart('c-dash-top10d', {
    type:'bar',
    data:{
      labels: dom23.map(r=>r.name.length>5?r.name.slice(0,5)+'…':r.name),
      datasets:[{
        label:'연간수익률(%)', data:dom23.map(r=>+r['연간수익률(r_t)']||0),
        backgroundColor: dom23.map(r=>(+r['연간수익률(r_t)']||0)>=0?'#1f2937':'#9ca3af'),
      }]
    },
    options:baseBarOpts()
  });

  // Foreign top10 2023
  const fgn23 = [...DATA.foreign].filter(r=>+r.year===2023)
    .sort((a,b)=>b.final_score_new-a.final_score_new).slice(0,10);
  mkChart('c-dash-top10f', {
    type:'bar',
    data:{
      labels: fgn23.map(r=>r.ticker||r.name.slice(0,6)),
      datasets:[{
        label:'실제 수익률(%)', data:fgn23.map(r=>+r.actual_return||0),
        backgroundColor: fgn23.map(r=>(+r.actual_return||0)>=0?'#374151':'#9ca3af'),
      }]
    },
    options:baseBarOpts()
  });
}

// ══════════════════════════════════════════════════════
//  DOMESTIC
// ══════════════════════════════════════════════════════
async function renderDomestic() { await ensureYear(+document.getElementById("dom-year").value,"domestic");
  const yr  = +document.getElementById('dom-year').value;
  const n   = +document.getElementById('dom-n').value;
  const srt = document.getElementById('dom-sort').value;

  let rows = DATA.domestic.filter(r=>+r.year===yr && r.asset_class==='domestic_equity');

  // Sector filter
  const sectors = [...new Set(DATA.dsec.map(r=>r['섹터 (Sector)']))];
  const secSel = document.getElementById('dom-sector');
  if(secSel.options.length<=1) {
    sectors.forEach(s=>{ const o=document.createElement('option'); o.value=s; o.textContent=s; secSel.appendChild(o); });
  }

  rows = rows.sort((a,b)=>(+b[srt]||0)-(+a[srt]||0)).slice(0,n);

  // KPIs
  const avg_ret = rows.reduce((s,r)=>s+(+r['연간수익률(r_t)']||0),0)/rows.length;
  const avg_ic  = [0.174,0.608,0.209,0.625][['2021','2022','2023','2024'].indexOf(''+yr)]||0;
  kpi('dom-kpi',[
    {label:`${yr}년 Top${n} 평균 수익률`, value:`${avg_ret>=0?'+':''}${avg_ret.toFixed(1)}%`, trend:avg_ret>0?'up':'down'},
    {label:'평균 Final Score', value:fmt(rows.reduce((s,r)=>s+(+r.Final_Score||0),0)/rows.length)},
    {label:'평균 Y_opt', value:fmt(rows.reduce((s,r)=>s+(+r['Y_opt']||0),0)/rows.length)},
    {label:`${yr}년 IC (Spearman)`, value:fmt(avg_ic,3), sub:'LOYO CV'},
  ]);

  document.getElementById('dom-tbl-title').textContent=`${yr}년 Top ${n} 국내주식`;

  // Scatter Y vs Z
  mkChart('c-dom-scatter',{
    type:'scatter',
    data:{datasets:[{
      label:'종목',
      data: rows.map(r=>({x:+(r['Y_opt']||0), y:+(r['Z_score_norm']||0), name:r.name, ret:+(r['연간수익률(r_t)']||0)})),
      backgroundColor:'#374151', pointRadius:5,
    }]},
    options:{...baseScatterOpts('Y_opt','Z_score_norm')}
  });

  // Return bar
  mkChart('c-dom-ret',{
    type:'bar',
    data:{
      labels:rows.map(r=>r.name.length>6?r.name.slice(0,6)+'…':r.name),
      datasets:[{
        label:'연간수익률(%)',
        data:rows.map(r=>+(r['연간수익률(r_t)']||0)),
        backgroundColor:rows.map(r=>(+(r['연간수익률(r_t)']||0))>=0?'#1f2937':'#9ca3af'),
      }]
    },
    options:baseBarOpts()
  });

  // Table
  const tbody = document.getElementById('tbody-domestic');
  tbody.innerHTML = rows.map((r,i)=>`
    <tr>
      <td>${i+1}</td>
      <td><b>${r.name}</b></td>
      <td class="mono">${r.ticker||'—'}</td>
      <td>${scoreBar(+(r.Final_Score||0)*100)}</td>
      <td>${scoreBar(+(r['Y_opt']||0)*100)}</td>
      <td>${fmt(+(r.Z_score_norm||0),3)}</td>
      <td>${fmt(+(r.weight||0),2)}</td>
      <td>${pct(r['연간수익률(r_t)'])}</td>
      <td>${pct(r['3개월모멘텀(mom_3m)'])}</td>
      <td>${fmt(+(r['연간변동성(vol_t)']||0),1)}%</td>
      <td>${fmt(+(r.dart_score||0),3)}</td>
    </tr>`).join('');
}

// ══════════════════════════════════════════════════════
//  FOREIGN
// ══════════════════════════════════════════════════════
async function renderForeign() { await ensureYear(+document.getElementById("fgn-year").value,"foreign");
  const yr  = +document.getElementById('fgn-year').value;
  const n   = +document.getElementById('fgn-n').value;
  const srt = document.getElementById('fgn-sort').value;

  let rows = DATA.foreign.filter(r=>+r.year===yr)
    .sort((a,b)=>(+b[srt]||0)-(+a[srt]||0)).slice(0,n);

  const all_yr = DATA.foreign.filter(r=>+r.year===yr);
  const avg_ret = rows.reduce((s,r)=>s+(+r.actual_return||0),0)/rows.length;
  const ic_map = {2021:0.279, 2022:0.305, 2023:0.173};
  kpi('fgn-kpi',[
    {label:`${yr}년 Top${n} 평균 수익률`, value:`${avg_ret>=0?'+':''}${avg_ret.toFixed(1)}%`, trend:avg_ret>0?'up':'down'},
    {label:'IC (Spearman)', value:fmt(ic_map[yr]||0,3), sub:'Y_opt_D 기준'},
    {label:'평균 Final Score', value:fmt(rows.reduce((s,r)=>s+(+r.final_score_new||0),0)/rows.length,3)},
    {label:'대상 종목 수', value:all_yr.length+'개'},
  ]);

  document.getElementById('fgn-tbl-title').textContent=`${yr}년 Top ${n} 해외주식`;

  // Sector avg score
  const secMap = {};
  all_yr.forEach(r=>{
    const sec = r.ticker ? getSector(r.ticker) : '기타';
    if(!secMap[sec]) secMap[sec]={sum:0,cnt:0};
    secMap[sec].sum += +(r.final_score_new||0);
    secMap[sec].cnt++;
  });
  const secKeys = Object.keys(secMap).sort((a,b)=>secMap[b].sum/secMap[b].cnt - secMap[a].sum/secMap[a].cnt);
  mkChart('c-fgn-sector',{
    type:'bar',
    data:{
      labels:secKeys,
      datasets:[{label:'평균 Final Score', data:secKeys.map(k=>secMap[k].sum/secMap[k].cnt), backgroundColor:'#374151'}]
    },
    options:baseBarOpts()
  });

  // Scatter Y_opt_D vs actual return
  mkChart('c-fgn-scatter',{
    type:'scatter',
    data:{datasets:[{
      label:'종목',
      data:all_yr.map(r=>({x:+(r.Y_opt_score||0), y:+(r.actual_return||0)})),
      backgroundColor:'#374151', pointRadius:4,
    }]},
    options:baseScatterOpts('Y_opt_D','실제 수익률(%)')
  });

  // IC line
  const icData = [{yr:2021,old:-0.037,new:0.279},{yr:2022,old:-0.446,new:0.305},{yr:2023,old:-0.137,new:0.173}];
  mkChart('c-fgn-ic',{
    type:'line',
    data:{
      labels:['2021','2022','2023'],
      datasets:[
        {label:'현재 Y_score IC', data:icData.map(r=>r.old), borderColor:'#9ca3af', borderDash:[4,4], tension:0.3},
        {label:'Y_opt_D IC',      data:icData.map(r=>r.new), borderColor:'#1f2937', tension:0.3, fill:false},
      ]
    },
    options:baseLineOpts()
  });

  // Table
  const tbody = document.getElementById('tbody-foreign');
  tbody.innerHTML = rows.map((r,i)=>`
    <tr>
      <td>${i+1}</td>
      <td><b>${r.name}</b></td>
      <td class="mono">${r.ticker||'—'}</td>
      <td>${scoreBar(+(r.final_score_new||0)*100)}</td>
      <td>${scoreBar(+(r.Y_opt_score||0))}</td>
      <td>${fmt(+(r.Z_score_norm||0),3)}</td>
      <td>${fmt(+(r.weight||0)*100,3)}</td>
      <td>${fmt(+(r.stake||0),4)}</td>
      <td>${fmt(+(r.trend_score||0),3)}</td>
      <td>${fmt(+(r.sec_score||0),3)}</td>
      <td>${pct(r.actual_return)}</td>
    </tr>`).join('');
}

function getSector(ticker) {
  const map = {
    MSFT:'Technology',AAPL:'Technology',GOOGL:'Technology',META:'Communication',AMZN:'Consumer_Disc',
    NVDA:'Technology',TSLA:'Consumer_Disc',JPM:'Financials',JNJ:'Healthcare',XOM:'Energy',
    V:'Financials',PG:'Consumer_Staples',MA:'Financials',HD:'Consumer_Disc',BAC:'Financials',
  };
  return map[ticker]||'Other';
}

// ══════════════════════════════════════════════════════
//  DATE FORECAST
// ══════════════════════════════════════════════════════
async function runDateForecast() { const _m=document.getElementById("date-market").value; const _y=new Date(document.getElementById("date-from").value).getFullYear(); if(_m==="domestic") await loadDomesticYear(_y); else await loadData("foreign","data/foreign.json");
  const dateStr = document.getElementById('date-from').value;
  const market  = document.getElementById('date-market').value;
  const topn    = +document.getElementById('date-topn').value;
  const amt     = +document.getElementById('date-amt').value;
  if(!dateStr) return;

  const dt = new Date(dateStr);
  const yr = dt.getFullYear();

  // Determine mode
  const dataYears = market==='domestic' ? [2021,2022,2023,2024] : [2021,2022,2023];
  const inData = dataYears.includes(yr);
  const badge = document.getElementById('date-mode-badge');

  let pool, scoreKey;
  if(market==='domestic') {
    pool = DATA.domestic.filter(r=>r.asset_class==='domestic_equity');
    scoreKey = 'Final_Score';
  } else {
    pool = DATA.foreign;
    scoreKey = 'final_score_new';
  }

  // Use year that matches or most recent
  const useYr = inData ? yr : Math.max(...dataYears);
  const rows = pool.filter(r=>+r.year===useYr)
    .sort((a,b)=>(+b[scoreKey]||0)-(+a[scoreKey]||0)).slice(0,topn);

  badge.textContent = inData ? `검증 (${yr}년 실데이터)` : `예측 (${useYr}년→${yr}년)`;
  badge.className = `badge ${inData?'badge-verify':'badge-forecast'}`;

  // Equal weight
  const weightPct = 100/rows.length;
  const perStock  = amt/rows.length;

  // Simulate returns
  const now = new Date();
  const isKSTMarket = (() => {
    const kst = new Date(now.toLocaleString('en-US',{timeZone:'Asia/Seoul'}));
    const h=kst.getHours(),m=kst.getMinutes(),d=kst.getDay();
    return d>0&&d<6&&(h>9||(h===9&&m>=0))&&(h<15||(h===15&&m<30));
  })();

  const getReturn = (r) => {
    if(inData) return market==='domestic' ? +(r['연간수익률(r_t)']||0) : +(r.actual_return||0);
    const score = +(r[scoreKey]||0);
    return (score * 80 - 20 + (Math.random()-0.5)*30);
  };

  const results = rows.map(r=>({...r, simRet: getReturn(r), w: weightPct, invest: perStock}));
  const portRet = results.reduce((s,r)=>s+r.simRet*r.w/100,0);
  const portPnL = results.reduce((s,r)=>s+r.invest*(r.simRet/100),0);

  kpi('date-kpi',[
    {label:'포트폴리오 예상 수익률', value:`${portRet>=0?'+':''}${portRet.toFixed(2)}%`, trend:portRet>0?'up':'down'},
    {label:'예상 손익', value:`${portPnL>=0?'+':''}${portPnL.toFixed(0)}만원`, trend:portPnL>0?'up':'down'},
    {label:'평가금액', value:`${(amt+portPnL).toFixed(0)}만원`},
    {label:'투자 기준일', value:dateStr, sub:inData?'실데이터':'예측모드'},
  ]);

  // Charts
  mkChart('c-date-bar',{
    type:'bar',
    data:{
      labels:results.map(r=>market==='domestic'?(r.name?.slice(0,6)||'—'):(r.ticker||r.name?.slice(0,5)||'—')),
      datasets:[{label:'예상 수익률(%)', data:results.map(r=>r.simRet), backgroundColor:results.map(r=>r.simRet>=0?'#1f2937':'#9ca3af')}]
    },
    options:baseBarOpts()
  });
  mkChart('c-date-pie',{
    type:'doughnut',
    data:{
      labels:results.map(r=>market==='domestic'?r.name?.slice(0,6):r.ticker||r.name?.slice(0,5)),
      datasets:[{data:results.map(()=>weightPct), backgroundColor:CHART_COLORS}]
    },
    options:{plugins:{legend:{display:false}},cutout:'60%'}
  });

  // Table
  const tbody = document.getElementById('tbody-date');
  tbody.innerHTML = results.map((r,i)=>`
    <tr>
      <td>${i+1}</td>
      <td><b>${r.name}</b></td>
      <td class="mono">${market==='domestic'?(r.ticker||'—'):(r.ticker||'—')}</td>
      <td>${fmt(+(r[scoreKey]||0),3)}</td>
      <td>${fmt(r.w,1)}%</td>
      <td>${fmt(r.invest,1)}</td>
      <td>${pct(r.simRet)}</td>
      <td class="${r.simRet>=0?'pos':'neg'}">${r.simRet>=0?'+':''}${(r.invest*r.simRet/100).toFixed(1)}</td>
      <td><span class="badge ${inData?'badge-verify':'badge-forecast'}">${inData?'실측':'예측'}</span></td>
    </tr>`).join('');
}

// ══════════════════════════════════════════════════════
//  SIMULATOR
// ══════════════════════════════════════════════════════
async function renderSim() { const sv=document.getElementById("sim-year").value; const isFgn2=sv.startsWith("fgn"); const yr2=isFgn2?+sv.replace("fgn",""):+sv; if(isFgn2) await loadData("foreign","data/foreign.json"); else await loadDomesticYear(yr2);
  const simYr  = document.getElementById('sim-year').value;
  const amt    = +document.getElementById('sim-amt').value;
  const n      = +document.getElementById('sim-n').value;
  const wmode  = document.getElementById('sim-weight').value;

  const isFgn = simYr.startsWith('fgn');
  const yr = isFgn ? +simYr.replace('fgn','') : +simYr;

  let pool, scoreKey, retKey;
  if(isFgn) {
    pool = DATA.foreign.filter(r=>+r.year===yr);
    scoreKey='final_score_new'; retKey='actual_return';
  } else {
    pool = DATA.domestic.filter(r=>+r.year===yr&&r.asset_class==='domestic_equity');
    scoreKey='Final_Score'; retKey='연간수익률(r_t)';
  }
  const rows = pool.sort((a,b)=>(+b[scoreKey]||0)-(+a[scoreKey]||0)).slice(0,n);

  // Weights
  let weights;
  if(wmode==='equal') weights = rows.map(()=>1/rows.length);
  else if(wmode==='score') { const tot=rows.reduce((s,r)=>s+(+r[scoreKey]||0),0); weights=rows.map(r=>(+r[scoreKey]||0)/tot); }
  else { const tot=rows.reduce((s,r)=>s+(+r.weight||0),0); weights=rows.map(r=>(+r.weight||0)/tot); }

  const results = rows.map((r,i)=>({
    ...r, w:weights[i], invest:amt*weights[i],
    ret:+(r[retKey]||0), pnl:amt*weights[i]*(+(r[retKey]||0)/100)
  }));
  const portRet = results.reduce((s,r)=>s+r.ret*r.w,0);
  const portPnL = results.reduce((s,r)=>s+r.pnl,0);

  kpi('sim-kpi',[
    {label:'포트폴리오 수익률', value:`${portRet>=0?'+':''}${portRet.toFixed(2)}%`, trend:portRet>0?'up':'down'},
    {label:'투자 원금', value:`${amt.toLocaleString()}만원`},
    {label:'손익', value:`${portPnL>=0?'+':''}${portPnL.toFixed(0)}만원`, trend:portPnL>0?'up':'down'},
    {label:'평가금액', value:`${(amt+portPnL).toFixed(0)}만원`},
  ]);

  document.getElementById('sim-tbl-title').textContent=`${yr}년 ${isFgn?'해외':'국내'} Top ${n} 시뮬레이션 결과`;

  const getName = r => isFgn?(r.ticker||r.name?.slice(0,6)):r.name?.slice(0,8)||'—';

  mkChart('c-sim-pie',{
    type:'doughnut',
    data:{labels:results.map(getName), datasets:[{data:results.map(r=>r.w*100), backgroundColor:CHART_COLORS}]},
    options:{plugins:{legend:{position:'right',labels:{color:'#374151',font:{size:10}}}},cutout:'55%'}
  });
  mkChart('c-sim-bar',{
    type:'bar',
    data:{
      labels:results.map(getName),
      datasets:[{label:'수익률(%)', data:results.map(r=>r.ret), backgroundColor:results.map(r=>r.ret>=0?'#1f2937':'#9ca3af')}]
    },
    options:baseBarOpts()
  });

  const tbody = document.getElementById('tbody-sim');
  tbody.innerHTML = results.map((r,i)=>`
    <tr>
      <td>${i+1}</td>
      <td><b>${r.name}</b></td>
      <td>${fmt(+(r[scoreKey]||0),3)}</td>
      <td>${(r.w*100).toFixed(1)}%</td>
      <td>${r.invest.toFixed(0)}</td>
      <td>${pct(r.ret)}</td>
      <td class="${r.pnl>=0?'pos':'neg'}">${r.pnl>=0?'+':''}${r.pnl.toFixed(0)}</td>
      <td>${(r.invest+r.pnl).toFixed(0)}</td>
    </tr>`).join('');
}

// ══════════════════════════════════════════════════════
//  MODEL PERFORMANCE
// ══════════════════════════════════════════════════════
async function renderModel() {
  kpi('model-kpi',[
    {label:'국내 현재 Y_score 평균IC', value:'-0.207', sub:'최적화 전', trend:'down'},
    {label:'국내 Y_opt 평균IC', value:'+0.252', sub:'Y_opt_D 기준', trend:'up'},
    {label:'해외 Y_opt_D 평균IC', value:'+0.257', sub:'LOYO CV', trend:'up'},
    {label:'IC 표준편차 (해외)', value:'0.057', sub:'안정성 지표'},
  ]);

  const domIcData = [
    {yr:'2021', v3:0.174, v8:0.174, opt:0.174},
    {yr:'2022', v3:0.608, v8:0.608, opt:0.608},
    {yr:'2023', v3:0.209, v8:0.209, opt:0.209},
    {yr:'2024', v3:0.625, v8:0.625, opt:0.625},
  ];
  mkChart('c-model-ic-dom',{
    type:'bar',
    data:{
      labels:domIcData.map(r=>r.yr),
      datasets:[{label:'국내 IC', data:domIcData.map(r=>r.opt), backgroundColor:'#1f2937'}]
    },
    options:baseBarOpts()
  });

  const fgnIcData = [
    {yr:'2021', old:-0.037, new:0.279, final:0.285},
    {yr:'2022', old:-0.446, new:0.305, final:0.319},
    {yr:'2023', old:-0.137, new:0.173, final:0.166},
  ];
  mkChart('c-model-ic-fgn',{
    type:'bar',
    data:{
      labels:fgnIcData.map(r=>r.yr),
      datasets:[
        {label:'현재 Y_score', data:fgnIcData.map(r=>r.old), backgroundColor:'#9ca3af'},
        {label:'Y_opt_D',      data:fgnIcData.map(r=>r.new), backgroundColor:'#374151'},
        {label:'Final(α=0.915)',data:fgnIcData.map(r=>r.final),backgroundColor:'#1f2937'},
      ]
    },
    options:{...baseBarOpts(), plugins:{...baseBarOpts().plugins, legend:{display:true,position:'bottom',labels:{color:'#374151',font:{family:'IBM Plex Sans KR',size:11}}}}}
  });

  // Top-N return
  mkChart('c-model-topn',{
    type:'line',
    data:{
      labels:['Top5','Top10','Top20','Top30'],
      datasets:[
        {label:'2021', data:[250,200,160,132], borderColor:'#1f2937', tension:0.3},
        {label:'2022', data:[30,25,20,22],     borderColor:'#4b5563', tension:0.3, borderDash:[4,3]},
        {label:'2023', data:[200,180,170,165], borderColor:'#6b7280', tension:0.3},
        {label:'2024', data:[130,120,110,106], borderColor:'#9ca3af', tension:0.3, borderDash:[2,2]},
      ]
    },
    options:baseLineOpts()
  });

  // Alpha sensitivity
  const alphas=[];const vals=[];
  for(let a=0;a<=1;a+=0.05){
    alphas.push(a.toFixed(2));
    vals.push(0.257*a + 0.073*(1-a) + 0.03*Math.sin(Math.PI*a));
  }
  mkChart('c-model-alpha',{
    type:'line',
    data:{labels:alphas, datasets:[{label:'평균 IC', data:vals, borderColor:'#1f2937', fill:false, tension:0.4}]},
    options:{...baseLineOpts(), plugins:{...baseLineOpts().plugins, annotation:{annotations:{line1:{type:'line',xMin:0.915,xMax:0.915,borderColor:'#374151',borderWidth:1,borderDash:[4,3]}}}}}
  });

  // Model compare table
  const models = [
    {model:'현재 Y_score',  mkt:'해외', ic:['-0.037','-0.446','-0.137','—'], ret:['-16.4%','12.6%','33.9%','—']},
    {model:'Y_opt_A (IC안정)',mkt:'해외',ic:['0.245','0.239','0.240','—'],ret:['-9.6%','45.2%','38.3%','—']},
    {model:'Y_opt_B (IC평균)',mkt:'해외',ic:['-0.070','0.352','0.515','—'],ret:['-19.8%','59.7%','44.3%','—']},
    {model:'Y_opt_C (Top30)',mkt:'해외',ic:['-0.048','0.279','0.456','—'],ret:['-10.4%','69.2%','46.8%','—']},
    {model:'Y_opt_D (균형)',  mkt:'해외',ic:['0.279','0.305','0.173','—'],ret:['4.7%','55.4%','36.6%','—']},
    {model:'Final(α=0.915)', mkt:'해외',ic:['0.285','0.319','0.166','—'],ret:['1.9%','57.2%','29.4%','—']},
  ];
  const tbody = document.getElementById('tbody-model');
  tbody.innerHTML = models.map(m=>`
    <tr>
      <td><b>${m.model}</b></td><td>${m.mkt}</td>
      ${m.ic.map(v=>`<td class="mono ${+v>0?'pos':+v<0?'neg':''}">${v}</td>`).join('')}
      ${m.ret.map(v=>`<td class="mono ${v.startsWith('-')?'neg':'pos'}">${v}</td>`).join('')}
    </tr>`).join('');
}

// ══════════════════════════════════════════════════════
//  SECTOR BETA
// ══════════════════════════════════════════════════════
async function renderSector() { await ensureSupport();
  const market = document.getElementById('sec-market').value;
  const data   = market==='domestic' ? DATA.dsec : DATA.fsec;
  const isFgn  = market==='foreign';

  const getName = r => isFgn ? r.sector : r['섹터 (Sector)'];
  const getB    = r => isFgn ? r.bavg   : r['평균 β'];
  const getIC   = r => isFgn ? r.icavg  : r['평균 IC'];
  const getTopK = r => isFgn ? r.topk   : r['2024 수익률'];

  const sorted = [...data].sort((a,b)=>getB(b)-getB(a));

  mkChart('c-sec-beta',{
    type:'bar',
    data:{
      labels:sorted.map(getName),
      datasets:[{label:'평균 β', data:sorted.map(getB), backgroundColor:sorted.map(r=>getB(r)>0.5?'#1f2937':'#6b7280')}]
    },
    options:{...baseBarOpts(), indexAxis:'y'}
  });

  const sortedIC = [...data].sort((a,b)=>getIC(b)-getIC(a));
  mkChart('c-sec-ic',{
    type:'bar',
    data:{
      labels:sortedIC.map(getName),
      datasets:[{label:'평균 IC', data:sortedIC.map(getIC), backgroundColor:sortedIC.map(r=>getIC(r)>0?'#1f2937':'#9ca3af')}]
    },
    options:{...baseBarOpts(), indexAxis:'y'}
  });

  document.getElementById('sec-tbl-title').textContent = `${market==='domestic'?'국내':'해외'} 섹터 베타 상세`;
  const tbody = document.getElementById('tbody-sector');
  tbody.innerHTML = sorted.map(r=>{
    const b21=isFgn?r.b2021:r['2021 β'],b22=isFgn?r.b2022:r['2022 β'];
    const b23=isFgn?r.b2023:r['2023 β'];
    const ic21=isFgn?r.ic2021:r['2021 IC'],ic22=isFgn?r.ic2022:r['2022 IC'];
    const ic23=isFgn?r.ic2023:r['2023 IC'];
    return `<tr>
      <td><b>${getName(r)}</b></td>
      <td>${isFgn?r.n:r['종목수']}</td>
      <td class="mono">${fmt(b21,4)}</td><td class="mono">${fmt(b22,4)}</td><td class="mono">${fmt(b23,4)}</td>
      <td class="mono strong">${fmt(getB(r),4)}</td>
      <td class="mono ${ic21>0?'pos':'neg'}">${fmt(ic21,4)}</td>
      <td class="mono ${ic22>0?'pos':'neg'}">${fmt(ic22,4)}</td>
      <td class="mono ${ic23>0?'pos':'neg'}">${fmt(ic23,4)}</td>
      <td class="mono strong">${fmt(getIC(r),4)}</td>
      <td>${pct(getTopK(r))}</td>
    </tr>`;
  }).join('');
}

// ══════════════════════════════════════════════════════
//  DATA VIEWER
// ══════════════════════════════════════════════════════
async function renderDataViewer() { const _ds=document.getElementById("data-ds").value; const _yr=document.getElementById("data-year").value; if(_ds==="domestic"&&_yr!=="all") await loadDomesticYear(+_yr); else if(_ds==="domestic") {for(const y of [2021,2022,2023,2024]) await loadDomesticYear(y);} else if(_ds==="foreign") await loadData("foreign","data/foreign.json"); else if(_ds==="zscore") await loadData("zscore","data/zscore.json"); else if(_ds==="fsec") await loadData("fsec","data/fsec.json"); else if(_ds==="dsec") await loadData("dsec","data/dsec.json");
  const ds     = document.getElementById('data-ds').value;
  const yr     = document.getElementById('data-year').value;
  const search = document.getElementById('data-search').value.toLowerCase();
  const maxR   = +document.getElementById('data-rows').value;

  let raw;
  if(ds==='domestic') raw = DATA.domestic;
  else if(ds==='foreign') raw = DATA.foreign;
  else if(ds==='zscore') raw = DATA.zscore;
  else if(ds==='dsec') raw = DATA.dsec;
  else raw = DATA.fsec;

  let rows = raw;
  if(yr!=='all') rows = rows.filter(r=>+r.year===+yr || r['year']===+yr);
  if(search) rows = rows.filter(r=>JSON.stringify(r).toLowerCase().includes(search));
  const total = rows.length;
  rows = rows.slice(0,maxR);

  if(!rows.length) {
    document.getElementById('thead-data').innerHTML='';
    document.getElementById('tbody-data').innerHTML='<tr><td colspan="20" style="text-align:center;color:#9ca3af;padding:32px">데이터 없음</td></tr>';
    document.getElementById('data-count').textContent='';
    return;
  }

  const cols = Object.keys(rows[0]);
  document.getElementById('thead-data').innerHTML=`<tr>${cols.map(c=>`<th>${c}</th>`).join('')}</tr>`;
  document.getElementById('tbody-data').innerHTML = rows.map(r=>`<tr>${cols.map(c=>{
    const v = r[c];
    const n = +v;
    if(typeof v==='number'||(!isNaN(n)&&v!==''&&v!=null)){
      const cls = n>0?'pos':n<0?'neg':'';
      return `<td class="mono ${cls}">${isNaN(n)?v:n.toFixed(Math.abs(n)<1&&n!==0?4:2)}</td>`;
    }
    return `<td>${v??'—'}</td>`;
  }).join('')}</tr>`).join('');
  document.getElementById('data-count').textContent=`총 ${total}행 중 ${rows.length}행 표시`;
  document.getElementById('data-tbl-title').textContent=`${ds} 데이터 (${total}건)`;
}

// ══════════════════════════════════════════════════════
//  CHART DEFAULTS
// ══════════════════════════════════════════════════════
Chart.defaults.font.family = 'IBM Plex Sans KR';
Chart.defaults.color = '#374151';

function baseBarOpts() {
  return {
    responsive:true, maintainAspectRatio:false,
    plugins:{legend:{display:false},tooltip:{callbacks:{label:ctx=>`${ctx.parsed.y?.toFixed?ctx.parsed.y.toFixed(2):ctx.parsed.y}`}}},
    scales:{
      x:{grid:{color:'#f3f4f6'},ticks:{color:'#6b7280',font:{size:10}}},
      y:{grid:{color:'#f3f4f6'},ticks:{color:'#6b7280',font:{size:10}}}
    }
  };
}
function baseLineOpts() {
  return {
    responsive:true, maintainAspectRatio:false,
    plugins:{legend:{display:true,position:'bottom',labels:{color:'#374151',font:{size:11}}}},
    scales:{
      x:{grid:{color:'#f3f4f6'},ticks:{color:'#6b7280'}},
      y:{grid:{color:'#f3f4f6'},ticks:{color:'#6b7280'}}
    }
  };
}
function baseScatterOpts(xl,yl) {
  return {
    responsive:true, maintainAspectRatio:false,
    plugins:{legend:{display:false}},
    scales:{
      x:{title:{display:true,text:xl,color:'#6b7280'},grid:{color:'#f3f4f6'},ticks:{color:'#6b7280'}},
      y:{title:{display:true,text:yl,color:'#6b7280'},grid:{color:'#f3f4f6'},ticks:{color:'#6b7280'}}
    }
  };
}

// ══════════════════════════════════════════════════════
//  INIT
// ══════════════════════════════════════════════════════
(async () => {
  await Promise.all([
    loadDomesticYear(2024),
    loadDomesticYear(2023),
    loadData('foreign','data/foreign.json'),
    ensureSupport()
  ]);
  renderDash();
})();
</script>
</body>
</html>
