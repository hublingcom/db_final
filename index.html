<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NPS Mirror Intelligence v3</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+KR:wght@300;400;500;600&family=IBM+Plex+Mono:wght@400;500&family=Sora:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<link rel="stylesheet" href="nps_style_v3.css">
</head>
<body>

<!-- â•â• SIDEBAR â•â• -->
<aside id="sidebar">
  <div class="sb-logo">
    <div class="sb-logo-mark">NPS</div>
    <div class="sb-logo-text">
      <div class="sb-brand">Mirror Intelligence</div>
      <div class="sb-version">v3.0 Â· êµ­ë¯¼ì—°ê¸ˆ ë¶„ì„</div>
    </div>
  </div>

  <nav class="sb-nav">
    <div class="sb-section-label">ë¶„ì„</div>
    <button class="sb-item active" data-page="p-dash">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
      ëŒ€ì‹œë³´ë“œ
    </button>
    <button class="sb-item" data-page="p-domestic">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg>
      êµ­ë‚´ì£¼ì‹
    </button>
    <button class="sb-item" data-page="p-foreign">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
      ë¯¸êµ­ì£¼ì‹
    </button>
    <div class="sb-section-label">ë„êµ¬</div>
    <button class="sb-item" data-page="p-date">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
      ë‚ ì§œ ì˜ˆì¸¡Â·ê²€ì¦
    </button>
    <button class="sb-item" data-page="p-sim">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
      íˆ¬ì ì‹œë®¬ë ˆì´í„°
    </button>
    <div class="sb-section-label">ëª¨ë¸</div>
    <button class="sb-item" data-page="p-model">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
      ëª¨ë¸ ì„±ëŠ¥
    </button>
    <button class="sb-item" data-page="p-sector">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg>
      ì„¹í„° ë² íƒ€
    </button>
    <button class="sb-item" data-page="p-data">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>
      ì „ì²´ ë°ì´í„°
    </button>
  </nav>

  <div class="sb-footer">
    <div class="sb-live-dot"></div>
    <span id="sb-time">--:--:--</span>
    <span class="sb-model-tag">Y_opt_D Â· Î±=0.915</span>
  </div>
</aside>

<!-- â•â• MAIN â•â• -->
<div id="app-wrap">

<!-- â•â•â•â•â•â•â•â•â•â• PAGE: DASHBOARD â•â•â•â•â•â•â•â•â•â• -->
<section class="page active" id="p-dash">
  <div class="page-header">
    <div>
      <h1 class="page-title">ëŒ€ì‹œë³´ë“œ</h1>
      <p class="page-sub">NPS í¬íŠ¸í´ë¦¬ì˜¤ ë¯¸ëŸ¬ë§ Â· êµ­ë¯¼ì—°ê¸ˆ ê³µì‹œ ë°ì´í„° ê¸°ë°˜ ì¥ê¸°+ë‹¨ê¸° ì‹ í˜¸ ê²°í•©</p>
    </div>
    <div class="info-pill">Final = 0.915 Ã— Y_opt_D + 0.085 Ã— Z</div>
  </div>

  <div class="kpi-grid" id="dash-kpi"></div>

  <div class="card-grid g2 mt16">
    <div class="card">
      <div class="card-hd">ì—°ë„ë³„ í¬íŠ¸í´ë¦¬ì˜¤ ìˆ˜ìµë¥  vs ë²¤ì¹˜ë§ˆí¬</div>
      <div class="chart-box h280"><canvas id="c-dash-perf"></canvas></div>
    </div>
    <div class="card">
      <div class="card-hd">êµ­ë‚´ Top-10 ìˆ˜ìµë¥  (2023ë…„)</div>
      <div class="chart-box h280"><canvas id="c-dash-top10d"></canvas></div>
    </div>
  </div>

  <div class="card-grid g2 mt16">
    <div class="card">
      <div class="card-hd">ëª¨ë¸ ê³µì‹ ìš”ì•½</div>
      <div class="formula-box">
        <div class="formula-row">
          <span class="formula-label">êµ­ë‚´ Y_opt</span>
          <code>0.688Ã—mom + 0.240Ã—trend + 0.030Ã—value + 0.029Ã—dart + 0.007Ã—vol + 0.006Ã—wgt</code>
        </div>
        <div class="formula-row">
          <span class="formula-label">í•´ì™¸ Y_opt_D</span>
          <code>-0.852Ã—value - 0.420Ã—stake - 0.235Ã—trend - 0.171Ã—sec - 0.445Ã—bulk</code>
        </div>
        <div class="formula-row highlight">
          <span class="formula-label">êµ­ë‚´ Final</span>
          <code>0.852 Ã— Y_opt + 0.148 Ã— Z_score_norm</code>
        </div>
        <div class="formula-row highlight">
          <span class="formula-label">í•´ì™¸ Final</span>
          <code>0.915 Ã— Y_opt_D + 0.085 Ã— Z_score_norm</code>
        </div>
        <div class="formula-row">
          <span class="formula-label">ì„¹í„° ë² íƒ€</span>
          <code>êµ­ë‚´: Î² = 0.6151Ã—IC + 0.3486 Â· í•´ì™¸: Î² = 0.2317Ã—IC + 0.4024 Â· (IC&lt;0 â†’ Î²=0.20)</code>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-hd">í•´ì™¸ Top-10 ìˆ˜ìµë¥  (2023ë…„)</div>
      <div class="chart-box h280"><canvas id="c-dash-top10f"></canvas></div>
    </div>
  </div>
</section>

<!-- â•â•â•â•â•â•â•â•â•â• PAGE: DOMESTIC â•â•â•â•â•â•â•â•â•â• -->
<section class="page" id="p-domestic">
  <div class="page-header">
    <div>
      <h1 class="page-title">êµ­ë‚´ì£¼ì‹ ë¶„ì„</h1>
      <p class="page-sub">êµ­ë‚´ ìƒìœ„ ì¢…ëª© ìŠ¤ì½”ì–´ Â· ìˆ˜ìµë¥  Â· NPS ë³´ìœ  ë¹„ì¤‘</p>
    </div>
  </div>

  <div class="ctrl-bar">
    <div class="ctrl-group">
      <label>ê¸°ì¤€ ì—°ë„</label>
      <select id="dom-year" onchange="renderDomestic()">
        <option value="2021">2021</option>
        <option value="2022">2022</option>
        <option value="2023">2023</option>
        <option value="2024" selected>2024</option>
      </select>
    </div>
    <div class="ctrl-group">
      <label>ìƒìœ„ Nì¢…ëª©: <b id="dom-n-val">20</b></label>
      <input type="range" id="dom-n" min="5" max="50" value="20" oninput="document.getElementById('dom-n-val').textContent=this.value;renderDomestic()">
    </div>
    <div class="ctrl-group">
      <label>ì •ë ¬</label>
      <select id="dom-sort" onchange="renderDomestic()">
        <option value="Final_Score">ìµœì¢… ìŠ¤ì½”ì–´</option>
        <option value="Y_opt">Y_opt</option>
        <option value="Z_score_norm">Z-ìŠ¤ì½”ì–´</option>
        <option value="ì—°ê°„ìˆ˜ìµë¥ (r_t)">ì—°ê°„ ìˆ˜ìµë¥ </option>
        <option value="weight">NPS ë¹„ì¤‘</option>
      </select>
    </div>
    <div class="ctrl-group">
      <label>ì„¹í„°</label>
      <select id="dom-sector" onchange="renderDomestic()">
        <option value="all">ì „ì²´</option>
      </select>
    </div>
  </div>

  <div class="kpi-grid" id="dom-kpi"></div>

  <div class="card-grid g2 mt16">
    <div class="card">
      <div class="card-hd">Y_opt vs Z-score ì‚°ì ë„</div>
      <div class="chart-box h280"><canvas id="c-dom-scatter"></canvas></div>
    </div>
    <div class="card">
      <div class="card-hd">Top N ìˆ˜ìµë¥  ë¶„í¬</div>
      <div class="chart-box h280"><canvas id="c-dom-ret"></canvas></div>
    </div>
  </div>

  <div class="card mt16">
    <div class="card-hd" id="dom-tbl-title">2024ë…„ Top 20 êµ­ë‚´ì£¼ì‹</div>
    <div class="tbl-wrap">
      <table id="t-domestic">
        <thead><tr>
          <th>#</th><th>ì¢…ëª©ëª…</th><th>ì½”ë“œ</th>
          <th>Final Score</th><th>Y_opt</th><th>Z-score</th>
          <th>NPS ë¹„ì¤‘%</th><th>ì—°ê°„ìˆ˜ìµë¥ </th><th>3M ëª¨ë©˜í…€</th><th>ë³€ë™ì„±</th><th>DART</th>
        </tr></thead>
        <tbody id="tbody-domestic"></tbody>
      </table>
    </div>
  </div>
</section>

<!-- â•â•â•â•â•â•â•â•â•â• PAGE: FOREIGN â•â•â•â•â•â•â•â•â•â• -->
<section class="page" id="p-foreign">
  <div class="page-header">
    <div>
      <h1 class="page-title">ë¯¸êµ­ì£¼ì‹ ë¶„ì„</h1>
      <p class="page-sub">Y_opt_D ê³µì‹ Â· ì„¹í„° ë² íƒ€ ê°€ì¤‘ ëª¨ë¸ (Final = 0.915Ã—Y + 0.085Ã—Z)</p>
    </div>
    <div class="info-pill">IC ì•ˆì •ì„± std=0.057 Â· LOYO CV ê²€ì¦</div>
  </div>

  <div class="ctrl-bar">
    <div class="ctrl-group">
      <label>ê¸°ì¤€ ì—°ë„</label>
      <select id="fgn-year" onchange="renderForeign()">
        <option value="2021">2021</option>
        <option value="2022">2022</option>
        <option value="2023" selected>2023</option>
      </select>
    </div>
    <div class="ctrl-group">
      <label>ìƒìœ„ Nì¢…ëª©: <b id="fgn-n-val">15</b></label>
      <input type="range" id="fgn-n" min="3" max="30" value="15" oninput="document.getElementById('fgn-n-val').textContent=this.value;renderForeign()">
    </div>
    <div class="ctrl-group">
      <label>ì •ë ¬</label>
      <select id="fgn-sort" onchange="renderForeign()">
        <option value="final_score_new">Final Score(ì‹ )</option>
        <option value="final_score">Final Score(êµ¬)</option>
        <option value="Y_opt_score">Y_opt_D</option>
        <option value="Z_score_norm">Z-score</option>
        <option value="actual_return">ì‹¤ì œ ìˆ˜ìµë¥ </option>
      </select>
    </div>
  </div>

  <div class="kpi-grid" id="fgn-kpi"></div>

  <div class="card-grid g2 mt16">
    <div class="card">
      <div class="card-hd">ì„¹í„°ë³„ í‰ê·  Final Score</div>
      <div class="chart-box h280"><canvas id="c-fgn-sector"></canvas></div>
    </div>
    <div class="card">
      <div class="card-hd">Y_opt_D vs ì‹¤ì œ ìˆ˜ìµë¥  (IC ê²€ì¦)</div>
      <div class="chart-box h280"><canvas id="c-fgn-scatter"></canvas></div>
    </div>
  </div>

  <div class="card mt16">
    <div class="card-hd" id="fgn-tbl-title">2023ë…„ Top 15 í•´ì™¸ì£¼ì‹</div>
    <div class="tbl-wrap">
      <table id="t-foreign">
        <thead><tr>
          <th>#</th><th>ì¢…ëª©ëª…</th><th>í‹°ì»¤</th>
          <th>Final(ì‹ )</th><th>Y_opt_D</th><th>Z-score</th>
          <th>NPS ë¹„ì¤‘%</th><th>stake</th><th>trend</th><th>sec_score</th><th>ì‹¤ì œ ìˆ˜ìµë¥ </th>
        </tr></thead>
        <tbody id="tbody-foreign"></tbody>
      </table>
    </div>
  </div>

  <div class="card mt16">
    <div class="card-hd">ì—°ë„ë³„ IC ì¶”ì´ (ëª¨ë¸ ê²€ì¦)</div>
    <div class="chart-box h240"><canvas id="c-fgn-ic"></canvas></div>
  </div>
</section>

<!-- â•â•â•â•â•â•â•â•â•â• PAGE: DATE PREDICTION â•â•â•â•â•â•â•â•â•â• -->
<section class="page" id="p-date">
  <div class="page-header">
    <div>
      <h1 class="page-title">ë‚ ì§œ ì˜ˆì¸¡ Â· ê²€ì¦</h1>
      <p class="page-sub">ë‚ ì§œ ì…ë ¥ â†’ ë°ì´í„° ë‚´ ë‚ ì§œë©´ ì‹¤ì œ ë¹„êµ Â· ë¯¸ë˜ ë‚ ì§œë©´ ì˜ˆì¸¡ ìƒì„± Â· ì¥ ìš´ì˜ì‹œê°„(9:00~15:30)ì—” ì‹¤ì‹œê°„ ì—°ë™</p>
    </div>
  </div>

  <div class="alert-box">
    âš ï¸ ì‹¤ì‹œê°„ ì£¼ê°€ëŠ” Yahoo Finance API ì—°ë™ (ì¥ ìš´ì˜ì‹œê°„ ìë™ í™œì„±í™”). íˆ¬ì ì˜ì‚¬ê²°ì •ì— ì§ì ‘ ì‚¬ìš© ê¸ˆì§€.
  </div>

  <div class="card mt16">
    <div class="card-hd">ğŸ“… ë‚ ì§œ & í¬íŠ¸í´ë¦¬ì˜¤ ì„¤ì •</div>
    <div class="ctrl-bar" style="flex-wrap:wrap;gap:12px;padding:0">
      <div class="ctrl-group">
        <label>íˆ¬ì ê¸°ì¤€ì¼</label>
        <input type="date" id="date-from" value="2023-01-01">
      </div>
      <div class="ctrl-group">
        <label>ì‹œì¥</label>
        <select id="date-market">
          <option value="domestic">êµ­ë‚´ (KOSPI)</option>
          <option value="foreign">ë¯¸êµ­ (NYSE/NASDAQ)</option>
        </select>
      </div>
      <div class="ctrl-group">
        <label>Top Nì¢…ëª©</label>
        <input type="number" id="date-topn" value="10" min="1" max="50" style="width:80px">
      </div>
      <div class="ctrl-group">
        <label>íˆ¬ì ê¸ˆì•¡ (ë§Œì›)</label>
        <input type="number" id="date-amt" value="1000" min="10" step="100" style="width:120px">
      </div>
      <div class="ctrl-group">
        <label>ë°°ë¶„ ë°©ì‹</label>
        <select id="date-wmode">
          <option value="final">ìµœì¢…ê°’ (Î±+Î² ëª¨ë‘ ì ìš©)</option>
          <option value="alpha_only">ì•ŒíŒŒë§Œ ì ìš© (Y:Z í˜¼í•©)</option>
          <option value="beta_only">ë² íƒ€ë§Œ ì ìš© (ì„¹í„° ê°€ì¤‘)</option>
          <option value="alpha_beta">ì•ŒíŒŒ+ë² íƒ€ ì ìš©</option>
          <option value="equal">ê· ë“± ë°°ë¶„</option>
        </select>
      </div>
      <button class="btn-primary" onclick="runDateForecast()">ğŸ”® ì˜ˆì¸¡ ì‹¤í–‰</button>
    </div>
  </div>

  <div class="kpi-grid mt16" id="date-kpi"></div>

  <div class="card-grid g2 mt16">
    <div class="card">
      <div class="card-hd">ì˜ˆì¸¡ ìˆ˜ìµë¥  ë¶„í¬</div>
      <div class="chart-box h260"><canvas id="c-date-bar"></canvas></div>
    </div>
    <div class="card">
      <div class="card-hd">í¬íŠ¸í´ë¦¬ì˜¤ ë°°ë¶„</div>
      <div class="chart-box h260"><canvas id="c-date-pie"></canvas></div>
    </div>
  </div>

  <div class="card mt16">
    <div class="card-hd">
      í¬íŠ¸í´ë¦¬ì˜¤ ìƒì„¸
      <span class="badge" id="date-mode-badge">ëŒ€ê¸°</span>
    </div>
    <div class="tbl-wrap">
      <table id="t-date">
        <thead><tr>
          <th>#</th><th>ì¢…ëª©ëª…</th><th>í‹°ì»¤</th>
          <th>ìŠ¤ì½”ì–´</th><th>ë°°ë¶„ ë¹„ì¤‘</th><th>íˆ¬ìê¸ˆ(ë§Œì›)</th>
          <th>ì˜ˆì¸¡ ìˆ˜ìµë¥ </th><th>ì˜ˆìƒ ì£¼ê°€</th><th>ì‹¤ì œ ì£¼ê°€</th><th>ì ì¤‘ë¥ </th><th>ì˜ˆìƒ ì†ìµ(ë§Œì›)</th><th>ìƒíƒœ</th>
        </tr></thead>
        <tbody id="tbody-date"></tbody>
      </table>
      <div id="price-loading" style="display:none;padding:16px;text-align:center;color:#6b7280;font-size:13px">
        <span style="display:inline-block;width:18px;height:18px;border:2px solid #d1d5db;border-top-color:#374151;border-radius:50%;animation:spin .8s linear infinite;vertical-align:middle;margin-right:8px"></span>
        ì‹¤ì‹œê°„ ì£¼ê°€ ì¡°íšŒ ì¤‘...
      </div>
      <style>@keyframes spin{to{transform:rotate(360deg)}}</style>
    </div>
  </div>
</section>

<!-- â•â•â•â•â•â•â•â•â•â• PAGE: SIMULATOR â•â•â•â•â•â•â•â•â•â• -->
<section class="page" id="p-sim">
  <div class="page-header">
    <div>
      <h1 class="page-title">íˆ¬ì ì‹œë®¬ë ˆì´í„°</h1>
      <p class="page-sub">ì‹¤ì œ ìˆ˜ìµë¥  ê¸°ë°˜ ë°±í…ŒìŠ¤íŠ¸ Â· íˆ¬ì ê¸ˆì•¡ ì§ì ‘ ì…ë ¥</p>
    </div>
  </div>

  <div class="ctrl-bar">
    <div class="ctrl-group">
      <label>íˆ¬ì ì—°ë„</label>
      <select id="sim-year" onchange="renderSim()">
        <option value="2021">2021ë…„ êµ­ë‚´</option>
        <option value="2022">2022ë…„ êµ­ë‚´</option>
        <option value="2023" selected>2023ë…„ êµ­ë‚´</option>
        <option value="fgn2021">2021ë…„ í•´ì™¸</option>
        <option value="fgn2022">2022ë…„ í•´ì™¸</option>
        <option value="fgn2023">2023ë…„ í•´ì™¸</option>
      </select>
    </div>
    <div class="ctrl-group">
      <label>íˆ¬ì ê¸ˆì•¡ (ë§Œì›)</label>
      <input type="number" id="sim-amt" value="1000" min="100" max="1000000" step="100" oninput="renderSim()">
    </div>
    <div class="ctrl-group">
      <label>Top N: <b id="sim-n-val">10</b></label>
      <input type="range" id="sim-n" min="1" max="30" value="10" oninput="document.getElementById('sim-n-val').textContent=this.value;renderSim()">
    </div>
    <div class="ctrl-group">
      <label>ë°°ë¶„ ë°©ì‹</label>
      <select id="sim-weight" onchange="renderSim()">
        <option value="final">ìµœì¢…ê°’ (Î±+Î²)</option>
        <option value="alpha_only">ì•ŒíŒŒë§Œ (Y:Z)</option>
        <option value="beta_only">ë² íƒ€ë§Œ (ì„¹í„°)</option>
        <option value="alpha_beta">ì•ŒíŒŒ+ë² íƒ€</option>
        <option value="equal">ê· ë“± ë°°ë¶„</option>
        <option value="score">ìŠ¤ì½”ì–´ ë¹„ë¡€</option>
        <option value="nps">NPS ë¹„ì¤‘ ë¹„ë¡€</option>
      </select>
    </div>
  </div>

  <div class="kpi-grid" id="sim-kpi"></div>

  <div class="card-grid g2 mt16">
    <div class="card">
      <div class="card-hd">í¬íŠ¸í´ë¦¬ì˜¤ êµ¬ì„± (ë°°ë¶„ ë¹„ì¤‘)</div>
      <div class="chart-box h280"><canvas id="c-sim-pie"></canvas></div>
    </div>
    <div class="card">
      <div class="card-hd">ì¢…ëª©ë³„ ìˆ˜ìµë¥ </div>
      <div class="chart-box h280"><canvas id="c-sim-bar"></canvas></div>
    </div>
  </div>

  <div class="card mt16">
    <div class="card-hd" id="sim-tbl-title">í¬íŠ¸í´ë¦¬ì˜¤ ê²°ê³¼</div>
    <div class="tbl-wrap">
      <table>
        <thead><tr>
          <th>#</th><th>ì¢…ëª©ëª…</th><th>ìŠ¤ì½”ì–´</th>
          <th>ë°°ë¶„ ë¹„ì¤‘%</th><th>íˆ¬ìê¸ˆ(ë§Œì›)</th><th>ìˆ˜ìµë¥ </th><th>ì†ìµ(ë§Œì›)</th><th>í‰ê°€ê¸ˆ(ë§Œì›)</th>
        </tr></thead>
        <tbody id="tbody-sim"></tbody>
      </table>
    </div>
  </div>
</section>

<!-- â•â•â•â•â•â•â•â•â•â• PAGE: MODEL PERFORMANCE â•â•â•â•â•â•â•â•â•â• -->
<section class="page" id="p-model">
  <div class="page-header">
    <div>
      <h1 class="page-title">ëª¨ë¸ ì„±ëŠ¥ ë¶„ì„</h1>
      <p class="page-sub">LOYO Cross-Validation Â· IC ë¶„ì„ Â· êµ­ë‚´/í•´ì™¸ ëª¨ë¸ ë¹„êµ</p>
    </div>
  </div>

  <div class="kpi-grid" id="model-kpi"></div>

  <div class="card-grid g2 mt16">
    <div class="card">
      <div class="card-hd">ì—°ë„ë³„ IC (Spearman) â€” êµ­ë‚´</div>
      <div class="chart-box h280"><canvas id="c-model-ic-dom"></canvas></div>
    </div>
    <div class="card">
      <div class="card-hd">ì—°ë„ë³„ IC (Spearman) â€” í•´ì™¸</div>
      <div class="chart-box h280"><canvas id="c-model-ic-fgn"></canvas></div>
    </div>
  </div>

  <div class="card-grid g2 mt16">
    <div class="card">
      <div class="card-hd">Top-Në³„ í‰ê·  ìˆ˜ìµë¥  (êµ­ë‚´ LOYO)</div>
      <div class="chart-box h260"><canvas id="c-model-topn"></canvas></div>
    </div>
    <div class="card">
      <div class="card-hd">ì•ŒíŒŒ ë¯¼ê°ë„ ë¶„ì„ (í•´ì™¸ Y:Z ë¹„ìœ¨)</div>
      <div class="chart-box h260"><canvas id="c-model-alpha"></canvas></div>
    </div>
  </div>

  <div class="card mt16">
    <div class="card-hd">ëª¨ë¸ ë²„ì „ë³„ ì„±ëŠ¥ ë¹„êµ</div>
    <div class="tbl-wrap">
      <table id="t-model-compare">
        <thead><tr>
          <th>ëª¨ë¸</th><th>ëŒ€ìƒ</th><th>2021 IC</th><th>2022 IC</th><th>2023 IC</th><th>í‰ê·  IC</th>
          <th>2021 Top30</th><th>2022 Top30</th><th>2023 Top30</th><th>í‰ê·  Top30</th>
        </tr></thead>
        <tbody id="tbody-model"></tbody>
      </table>
    </div>
  </div>
</section>

<!-- â•â•â•â•â•â•â•â•â•â• PAGE: SECTOR BETA â•â•â•â•â•â•â•â•â•â• -->
<section class="page" id="p-sector">
  <div class="page-header">
    <div>
      <h1 class="page-title">ì„¹í„° ë² íƒ€ ë¶„ì„</h1>
      <p class="page-sub">êµ­ë‚´: Î² = 0.6151 Ã— IC + 0.3486 Â· í•´ì™¸: Î² = 0.2317 Ã— IC + 0.4024 Â· (IC &lt; 0 â†’ Î² = 0.20)</p>
    </div>
  </div>

  <div class="ctrl-bar">
    <div class="ctrl-group">
      <label>ì‹œì¥</label>
      <select id="sec-market" onchange="renderSector()">
        <option value="domestic">êµ­ë‚´</option>
        <option value="foreign">í•´ì™¸</option>
      </select>
    </div>
  </div>

  <div class="card-grid g2 mt16">
    <div class="card">
      <div class="card-hd">ì„¹í„°ë³„ í‰ê·  Î²</div>
      <div class="chart-box h320"><canvas id="c-sec-beta"></canvas></div>
    </div>
    <div class="card">
      <div class="card-hd">ì„¹í„°ë³„ í‰ê·  IC</div>
      <div class="chart-box h320"><canvas id="c-sec-ic"></canvas></div>
    </div>
  </div>

  <div class="card mt16">
    <div class="card-hd" id="sec-tbl-title">ì„¹í„° ë² íƒ€ ìƒì„¸</div>
    <div class="tbl-wrap">
      <table id="t-sector">
        <thead><tr>
          <th>ì„¹í„°</th><th>ì¢…ëª©ìˆ˜</th>
          <th>2021 Î²</th><th>2022 Î²</th><th>2023 Î²</th><th>í‰ê·  Î²</th>
          <th>2021 IC</th><th>2022 IC</th><th>2023 IC</th><th id="th-ic4">2024 IC</th><th>í‰ê·  IC</th>
          <th>ìˆ˜ìµë¥ </th>
        </tr></thead>
        <tbody id="tbody-sector"></tbody>
      </table>
    </div>
  </div>
</section>

<!-- â•â•â•â•â•â•â•â•â•â• PAGE: ALL DATA â•â•â•â•â•â•â•â•â•â• -->
<section class="page" id="p-data">
  <div class="page-header">
    <div>
      <h1 class="page-title">ì „ì²´ ë°ì´í„° ë·°ì–´</h1>
      <p class="page-sub">ëª¨ë“  ì›ë³¸ ë°ì´í„° Â· ê²€ìƒ‰ Â· í•„í„°</p>
    </div>
  </div>

  <div class="ctrl-bar">
    <div class="ctrl-group">
      <label>ë°ì´í„°ì…‹</label>
      <select id="data-ds" onchange="renderDataViewer()">
        <option value="domestic">êµ­ë‚´ì£¼ì‹ (y_score_real_final)</option>
        <option value="foreign">í•´ì™¸ì£¼ì‹ (foreign_final_score_updated)</option>
        <option value="zscore">êµ­ë‚´ Z-score (z_score_v3)</option>
        <option value="dsec">êµ­ë‚´ ì„¹í„° ë² íƒ€</option>
        <option value="fsec">í•´ì™¸ ì„¹í„° ë² íƒ€</option>
      </select>
    </div>
    <div class="ctrl-group">
      <label>ì—°ë„</label>
      <select id="data-year" onchange="renderDataViewer()">
        <option value="all">ì „ì²´</option>
        <option value="2021">2021</option>
        <option value="2022">2022</option>
        <option value="2023">2023</option>
        <option value="2024">2024</option>
      </select>
    </div>
    <div class="ctrl-group" style="flex:1;max-width:300px">
      <label>ì¢…ëª©ëª… ê²€ìƒ‰</label>
      <input type="text" id="data-search" placeholder="ì¢…ëª©ëª… ì…ë ¥..." oninput="renderDataViewer()">
    </div>
    <div class="ctrl-group">
      <label>í‘œì‹œ í–‰ìˆ˜</label>
      <select id="data-rows" onchange="renderDataViewer()">
        <option value="50">50í–‰</option>
        <option value="100" selected>100í–‰</option>
        <option value="200">200í–‰</option>
        <option value="9999">ì „ì²´</option>
      </select>
    </div>
  </div>

  <div class="card mt16">
    <div class="card-hd" id="data-tbl-title">ë°ì´í„°</div>
    <div class="tbl-wrap tbl-scroll-x">
      <table id="t-data">
        <thead id="thead-data"></thead>
        <tbody id="tbody-data"></tbody>
      </table>
    </div>
    <div class="tbl-footer" id="data-count"></div>
  </div>
</section>

</div><!-- /app-wrap -->

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DATA  â€”  loaded async from /data/*.json
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DATA = { domestic:[], foreign:[], zscore:[], fsec_raw:[], fsec:[], dsec:[] };
let _loaded = {};

async function loadData(key, url) {
  if(_loaded[key]) return;
  try {
    const res = await fetch(url);
    if(!res.ok) throw new Error(`HTTP ${res.status} for ${url}`);
    const json = await res.json();
    if(key==='domestic_all') {
      DATA.domestic = json;
    } else if(key==='foreign') {
      // NaN â†’ 0 ì•ˆì „ì²˜ë¦¬
      const safeN = v => (v === null || v === undefined || (typeof v==='number' && isNaN(v))) ? 0 : +v;
      DATA.foreign = json;
      // Y_opt_D = -0.852Ã—value -0.420Ã—stake -0.235Ã—trend -0.171Ã—sec -0.445Ã—bulk
      // value/stake/trend: NPS ê³µì‹œ â†’ 2024 ë§ˆì§€ë§‰ê°’ ê³ ì • (2025+ ê·¸ëŒ€ë¡œ ì‚¬ìš©)
      // sec_score: ì„¹í„° ë² íƒ€ ê¸°ë°˜ ì‹¤ì‹œê°„ ê³„ì‚° ê°€ëŠ¥ â†’ í˜„ì¬ëŠ” fsec ë°ì´í„° í™œìš©
      // bulk: ë¸”ë¡ë”œ ì—¬ë¶€ â†’ í˜„ì¬ëŠ” ê³ ì •ê°’ ì‚¬ìš©
      const w = [-0.8524,-0.4204,-0.2346,-0.1714,-0.4450];
      const fts = ['value_score','stake_score','trend_score','sec_score','bulk'];
      const years = [...new Set(json.map(r=>+r.year))];
      years.forEach(yr=>{
        const sub = json.filter(r=>+r.year===yr);
        const raws = sub.map(r=>fts.reduce((s,f,i)=>s+w[i]*safeN(r[f]),0));
        const mn=Math.min(...raws), mx=Math.max(...raws);
        sub.forEach((r,i)=>{
          r.Y_opt_score = mx>mn ? (raws[i]-mn)/(mx-mn)*100 : 50;
          const z = (r.Z_score_norm !== null && r.Z_score_norm !== undefined) ? safeN(r.Z_score_norm) : 0.5;
          r.final_score_new = 0.915*(r.Y_opt_score/100)+0.085*z;
        });
      });
    } else if(key==='zscore') {
      DATA.zscore = json;
    } else if(key==='fsec') {
      DATA.fsec_raw = json;
      DATA.fsec = json.slice(1).map(r=>({
        sector: r[Object.keys(r)[0]], eng: r['Unnamed: 1'], n: r['Unnamed: 2'],
        b2021:+r['Unnamed: 3']||0, b2022:+r['Unnamed: 4']||0, b2023:+r['Unnamed: 5']||0,
        bavg: +r['Unnamed: 6']||0, ic2021:+r['Unnamed: 7']||0, ic2022:+r['Unnamed: 8']||0,
        ic2023:+r['Unnamed: 9']||0, icavg:+r['Unnamed: 10']||0, topk:+r['Unnamed: 11']||0,
      })).filter(r=>r.sector && typeof r.sector==='string');
    } else if(key==='dsec') {
      DATA.dsec = json;
    }
    _loaded[key] = true;
  } catch(e) {
    console.error('fetch error', key, url, e);
    document.body.insertAdjacentHTML('afterbegin',
      `<div class="fetch-error-banner" style="position:fixed;top:0;left:0;right:0;z-index:9999;background:#b91c1c;color:#fff;padding:10px 16px;font-size:13px;font-family:monospace;display:flex;justify-content:space-between;align-items:center">
        <span>âŒ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ${url} â€” ${e.message}</span>
        <button onclick="this.parentElement.remove()" style="background:none;border:1px solid #fff;color:#fff;padding:2px 8px;cursor:pointer;border-radius:3px">ë‹«ê¸°</button>
      </div>`);
  }
}

// load each year into DATA.domestic accumulator
async function loadDomesticYear(yr) {
  const key = `dom${yr}`;
  if(_loaded[key]) return;
  try {
    const res = await fetch(`data/domestic_${yr}.json`);
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const json = await res.json();
    DATA.domestic = DATA.domestic.filter(r=>+r.year!==+yr).concat(json);
    _loaded[key] = true;
  } catch(e) {
    console.warn('loadDomesticYear failed', yr, e);
    // Silently ignore 404 for future years - use latest available year's data instead
    if(e.message && e.message.includes('404')) return;
    document.body.insertAdjacentHTML('afterbegin',
      `<div class="fetch-error-banner" style="position:fixed;top:0;left:0;right:0;z-index:9999;background:#b91c1c;color:#fff;padding:10px 16px;font-size:13px;font-family:monospace;display:flex;justify-content:space-between;align-items:center">
        <span>âŒ domestic_${yr}.json ë¡œë“œ ì‹¤íŒ¨ â€” ${e.message}</span>
        <button onclick="this.parentElement.remove()" style="background:none;border:1px solid #fff;color:#fff;padding:2px 8px;cursor:pointer;border-radius:3px">ë‹«ê¸°</button>
      </div>`);
  }
}

async function ensureYear(yr, market) {
  if(market==='foreign') {
    if(!_loaded['foreign']) await loadData('foreign','data/foreign.json');
  } else {
    await loadDomesticYear(yr);
  }
}

async function ensureSupport() {
  const tasks = [];
  if(!_loaded['zscore']) tasks.push(loadData('zscore','data/zscore.json'));
  if(!_loaded['fsec'])   tasks.push(loadData('fsec','data/fsec.json'));
  if(!_loaded['dsec'])   tasks.push(loadData('dsec','data/dsec.json'));
  await Promise.all(tasks);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.querySelectorAll('.sb-item').forEach(btn => {
  btn.addEventListener('click', () => {
    const pid = btn.dataset.page;
    document.querySelectorAll('.sb-item').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(pid).classList.add('active');
    if(pid==='p-dash') renderDash();
    if(pid==='p-domestic') renderDomestic();
    if(pid==='p-foreign') renderForeign();
    if(pid==='p-model') renderModel();
    if(pid==='p-sector') renderSector();
    if(pid==='p-sim') renderSim();
    if(pid==='p-data') renderDataViewer();
  });
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const charts = {};
function mkChart(id, cfg) {
  if(charts[id]) { charts[id].destroy(); }
  const ctx = document.getElementById(id);
  if(!ctx) return;
  charts[id] = new Chart(ctx, cfg);
  return charts[id];
}

function kpi(id, items) {
  const el = document.getElementById(id);
  if(!el) return;
  el.innerHTML = items.map(({label, value, sub, trend})=>`
    <div class="kpi-card">
      <div class="kpi-label">${label}</div>
      <div class="kpi-value ${trend==='up'?'up':trend==='down'?'down':''}">${value}</div>
      ${sub?`<div class="kpi-sub">${sub}</div>`:''}
    </div>`).join('');
}

function fmt(v, dec=2) { return v==null||isNaN(v)?'â€”':(+v).toFixed(dec); }
function pct(v) {
  const n = +v;
  if(isNaN(n)) return '<span>â€”</span>';
  const cls = n>0?'pos':n<0?'neg':'';
  return `<span class="${cls}">${n>0?'+':''}${n.toFixed(2)}%</span>`;
}
function scoreBar(v, max=100) {
  const w = Math.min(100, Math.max(0, (v/max)*100));
  return `<div class="score-cell"><span>${fmt(v)}</span><div class="score-bar"><div class="score-fill" style="width:${w}%"></div></div></div>`;
}

const COLORS = ['#1a1a2e','#374151','#6b7280','#9ca3af','#d1d5db','#374151'];
const CHART_COLORS = ['#1f2937','#374151','#4b5563','#6b7280','#9ca3af','#d1d5db','#111827','#1e3a5f','#0f3460'];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CLOCK & MARKET STATUS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateClock() {
  const now = new Date();
  const kst = new Date(now.toLocaleString('en-US', {timeZone:'Asia/Seoul'}));
  const hms = kst.toTimeString().slice(0,8);
  document.getElementById('sb-time').textContent = hms;
  const h = kst.getHours(), m = kst.getMinutes();
  const isOpen = kst.getDay()>0 && kst.getDay()<6 && (h>9||(h===9&&m>=0)) && h<15 || (h===15&&m<30);
  document.querySelector('.sb-live-dot').style.background = isOpen ? '#16a34a' : '#9ca3af';
}
setInterval(updateClock, 1000); updateClock();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function renderDash() {
  // KPI
  const years = [2021,2022,2023];
  const domPerf = {2021:132.4,2022:22.8,2023:164.7,2024:105.7};
  const fgnPerf = {2021:4.7, 2022:56.3, 2023:36.0};
  kpi('dash-kpi', [
    {label:'êµ­ë‚´ LOYO í‰ê·  Top30', value:'+132.4%', sub:'2021-2024 ê¸°ì¤€', trend:'up'},
    {label:'í•´ì™¸ LOYO í‰ê·  Top30', value:'+32.2%',  sub:'2021-2023 Y_opt_D', trend:'up'},
    {label:'êµ­ë‚´ ìµœì¢… Final Î±', value:'0.852', sub:'Y:Z í˜¼í•© ë¹„ìœ¨'},
    {label:'í•´ì™¸ ìµœì¢… Final Î±', value:'0.915', sub:'Y_opt_D:Z í˜¼í•© ë¹„ìœ¨'},
    {label:'êµ­ë‚´ í‰ê·  IC', value:'0.252', sub:'Spearman', trend:'up'},
    {label:'í•´ì™¸ í‰ê·  IC', value:'0.257', sub:'Y_opt_D ê¸°ì¤€', trend:'up'},
  ]);

  // Performance chart
  mkChart('c-dash-perf', {
    type:'bar',
    data:{
      labels:['2021','2022','2023','2024'],
      datasets:[
        {label:'êµ­ë‚´ Top30',   data:[132.4,22.8,164.7,105.7], backgroundColor:'#1f2937'},
        {label:'í•´ì™¸ Top30',   data:[4.7,56.3,36.0,null],      backgroundColor:'#6b7280'},
        {label:'KOSPI í‰ê· ',   data:[22.8,-18.8,24.3,-6.1],    backgroundColor:'#d1d5db'},
      ]
    },
    options:{...baseBarOpts(), plugins:{...baseBarOpts().plugins, legend:{display:true, position:'bottom', labels:{color:'#374151',font:{family:'IBM Plex Sans KR',size:11}}}}}
  });

  // Domestic top10 2023
  const dom23 = DATA.domestic.filter(r=>+r.year===2023 && r.asset_class==='domestic_equity')
    .sort((a,b)=>b['Final_Score']-a['Final_Score']).slice(0,10);
  mkChart('c-dash-top10d', {
    type:'bar',
    data:{
      labels: dom23.map(r=>r.name.length>5?r.name.slice(0,5)+'â€¦':r.name),
      datasets:[{
        label:'ì—°ê°„ìˆ˜ìµë¥ (%)', data:dom23.map(r=>+r['ì—°ê°„ìˆ˜ìµë¥ (r_t)']||0),
        backgroundColor: dom23.map(r=>(+r['ì—°ê°„ìˆ˜ìµë¥ (r_t)']||0)>=0?'#1f2937':'#9ca3af'),
      }]
    },
    options:baseBarOpts()
  });

  // Foreign top10 2023
  const fgn23 = [...DATA.foreign].filter(r=>+r.year===2023)
    .sort((a,b)=>b.final_score_new-a.final_score_new).slice(0,10);
  mkChart('c-dash-top10f', {
    type:'bar',
    data:{
      labels: fgn23.map(r=>r.ticker||r.name.slice(0,6)),
      datasets:[{
        label:'ì‹¤ì œ ìˆ˜ìµë¥ (%)', data:fgn23.map(r=>+r.actual_return||0),
        backgroundColor: fgn23.map(r=>(+r.actual_return||0)>=0?'#374151':'#9ca3af'),
      }]
    },
    options:baseBarOpts()
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DOMESTIC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function renderDomestic() { await ensureYear(+document.getElementById("dom-year").value,"domestic");
  const yr  = +document.getElementById('dom-year').value;
  const n   = +document.getElementById('dom-n').value;
  const srt = document.getElementById('dom-sort').value;

  let rows = DATA.domestic.filter(r=>+r.year===yr && r.asset_class==='domestic_equity');

  // Sector filter
  const sectors = [...new Set(DATA.dsec.map(r=>r['ì„¹í„° (Sector)']))];
  const secSel = document.getElementById('dom-sector');
  if(secSel.options.length<=1) {
    sectors.sort().forEach(s=>{ const o=document.createElement('option'); o.value=s; o.textContent=s; secSel.appendChild(o); });
  }
  const selSec = secSel.value;

  // ì„¹í„° ì„ íƒ ì‹œ í•´ë‹¹ ì„¹í„° ì¢…ëª©ë§Œ í•„í„°
  if(selSec && selSec !== 'all') {
    const SEC_KW = [
      {s:'ë°˜ë„ì²´/IT',     kw:['ì‚¼ì„±ì „ì','í•˜ì´ë‹‰ìŠ¤','DBí•˜ì´í…','ë¦¬ë…¸ê³µì—…','í•œë¯¸ë°˜ë„ì²´','ì´ì˜¤í…Œí¬ë‹‰ìŠ¤','HPSP','ì£¼ì„±ì—”ì§€ë‹ˆì–´ë§','ì›ìµ','ìœ ì§„í…Œí¬','í…ŒìŠ¤']},
      {s:'2ì°¨ì „ì§€/ë°°í„°ë¦¬',kw:['ì—ì½”í”„ë¡œ','í¬ìŠ¤ì½”í“¨ì²˜','ì—˜ì•¤ì—í”„','ì²œë³´','ì½”ìŠ¤ëª¨ì‹ ì†Œì¬','ë‚˜ë…¸ì‹ ì†Œì¬','ì†”ë£¨ìŠ¤','ë°°í„°ë¦¬','ì´ì°¨ì „ì§€']},
      {s:'ë°”ì´ì˜¤/ì œì•½',   kw:['ë°”ì´ì˜¤','ì œì•½','ì…€íŠ¸ë¦¬ì˜¨','ì‚¼ì„±ë°”ì´ì˜¤','ë…¹ì‹­ì','ìœ í•œì–‘í–‰','ì¢…ê·¼ë‹¹','í•œë¯¸ì•½í’ˆ','ì˜¤ë¦¬ì—”íŠ¸ë°”ì´ì˜¤','í•œì˜¬','ë³´ë ¹','ë™ì•„','ê´‘ë™']},
      {s:'ê²Œì„/ì—”í„°',     kw:['í¬ë˜í”„í†¤','ì—”ì”¨','ë„¥ìŠ¨','ì¹´ì¹´ì˜¤ê²Œì„','í•˜ì´ë¸Œ','SMì—”í„°','JYP','YG','ì™€ì´ì§€','ìœ„ë©”ì´ë“œ','í„ì–´ë¹„ìŠ¤']},
      {s:'ê¸ˆìœµ',          kw:['ì€í–‰','ê¸ˆìœµ','ì¦ê¶Œ','ë³´í—˜','í•˜ë‚˜','ì‹ í•œ','KB','ìš°ë¦¬ê¸ˆìœµ','ë©”ë¦¬ì¸ ','ë¯¸ë˜ì—ì…‹','ì‚¼ì„±ìƒëª…','í•œí™”ìƒëª…']},
      {s:'ê¸°ê³„/ë°©ì‚°/ì¡°ì„ ',kw:['í˜„ëŒ€ì¤‘ê³µì—…','ëŒ€ìš°ì¡°ì„ ','í•œí™”ì—ì–´ë¡œ','í•œí™”ì‹œìŠ¤í…œ','LIGë„¥ìŠ¤','í˜„ëŒ€ë¡œí…œ','ë°©ì‚°','ì¡°ì„ ','ë‘ì‚°ë¡œë³´í‹±ìŠ¤','HDí˜„ëŒ€']},
      {s:'ìë™ì°¨',        kw:['í˜„ëŒ€ì°¨','ê¸°ì•„','í˜„ëŒ€ëª¨ë¹„ìŠ¤','ë§Œë„','í•œì˜¨ì‹œìŠ¤í…œ','ìë™ì°¨','HLë§Œë„']},
      {s:'ì² ê°•/ê¸ˆì†',     kw:['POSCO','í¬ìŠ¤ì½”','í˜„ëŒ€ì œì² ','ë™êµ­ì œê°•','ì„¸ì•„','ê³ ë ¤ì•„ì—°','í’ì‚°','ì² ê°•']},
      {s:'í™”í•™/ì†Œì¬',     kw:['LGí™”í•™','ë¡¯ë°ì¼€ë¯¸ì¹¼','íš¨ì„±','SKC','í•œí™”ì†”ë£¨ì…˜','OCI','í™”í•™','ì†Œì¬','ê¸ˆí˜¸ì„ìœ ']},
      {s:'ì „ê¸°/ì „ì',     kw:['LGì „ì','ì‚¼ì„±SDI','LSì¼ë ‰íŠ¸ë¦­','ì¼ì§„ì „ê¸°','ì „ì§„ê±´ì„¤ë¡œë´‡','ì „ê¸°','ì „ì']},
      {s:'ì†Œë¹„ì¬',        kw:['CJì œì¼','ë†ì‹¬','ì˜¤ë¦¬ì˜¨','ë¡¯ë°ì¹ ì„±','ë¹™ê·¸ë ˆ','í•˜ì´íŠ¸ì§„ë¡œ','KT&G','ì†Œë¹„ì¬']},
      {s:'ê±´ì„¤',          kw:['ê±´ì„¤','GSê±´ì„¤','í˜„ëŒ€ê±´ì„¤','ëŒ€ìš°ê±´ì„¤','HDC','DLì´ì•¤ì”¨','í¬ìŠ¤ì½”ì´ì•¤ì”¨','HJì¤‘ê³µì—…']},
      {s:'ì—ë„ˆì§€/ìœ í‹¸ë¦¬í‹°',kw:['í•œêµ­ì „ë ¥','í•œêµ­ê°€ìŠ¤','SKì´ë…¸ë² ì´ì…˜','GSì—ë„ˆì§€','ì—ë„ˆì§€','ìœ í‹¸ë¦¬í‹°','SNTì—ë„ˆì§€']},
      {s:'ì¸í„°ë„·/í”Œë«í¼&ê²Œì„',kw:['ì¹´ì¹´ì˜¤','ë„¤ì´ë²„','NHN','ë”ë¸”ìœ ','í”Œë«í¼']},
      {s:'í†µì‹ ',          kw:['SKT','KT','LGìœ í”Œ','í†µì‹ ']},
      {s:'ìœ í†µ',          kw:['ë¡¯ë°ì‡¼í•‘','ì´ë§ˆíŠ¸','ì‹ ì„¸ê³„','í˜„ëŒ€ë°±í™”ì ','ìœ í†µ','GSë¦¬í…Œì¼']},
      {s:'ë¹„ì² ê¸ˆì†',      kw:['ê³ ë ¤ì•„ì—°','í’ì‚°','ë¹„ì² ']},
    ];
    const entry = SEC_KW.find(e=>e.s===selSec);
    if(entry) {
      rows = rows.filter(r => entry.kw.some(k=>(r.name||'').toLowerCase().includes(k.toLowerCase())));
    }
  }

  rows = rows.sort((a,b)=>(+b[srt]||0)-(+a[srt]||0)).slice(0,n);

  // KPIs
  const avg_ret = rows.reduce((s,r)=>s+(+r['ì—°ê°„ìˆ˜ìµë¥ (r_t)']||0),0)/rows.length;
  const avg_ic  = [0.174,0.608,0.209,0.625][['2021','2022','2023','2024'].indexOf(''+yr)]||0;
  kpi('dom-kpi',[
    {label:`${yr}ë…„ Top${n} í‰ê·  ìˆ˜ìµë¥ `, value:`${avg_ret>=0?'+':''}${avg_ret.toFixed(1)}%`, trend:avg_ret>0?'up':'down'},
    {label:'í‰ê·  Final Score', value:fmt(rows.reduce((s,r)=>s+(+r.Final_Score||0),0)/rows.length)},
    {label:'í‰ê·  Y_opt', value:fmt(rows.reduce((s,r)=>s+(+r['Y_opt']||0),0)/rows.length)},
    {label:`${yr}ë…„ IC (Spearman)`, value:fmt(avg_ic,3), sub:'LOYO CV'},
  ]);

  document.getElementById('dom-tbl-title').textContent=`${yr}ë…„ Top ${n} êµ­ë‚´ì£¼ì‹`;

  // Scatter Y vs Z
  mkChart('c-dom-scatter',{
    type:'scatter',
    data:{datasets:[{
      label:'ì¢…ëª©',
      data: rows.map(r=>({x:+(r['Y_opt']||0), y:+(r['Z_score_norm']||0), name:r.name, ret:+(r['ì—°ê°„ìˆ˜ìµë¥ (r_t)']||0)})),
      backgroundColor:'#374151', pointRadius:5,
    }]},
    options:{...baseScatterOpts('Y_opt','Z_score_norm')}
  });

  // Return bar
  mkChart('c-dom-ret',{
    type:'bar',
    data:{
      labels:rows.map(r=>r.name.length>6?r.name.slice(0,6)+'â€¦':r.name),
      datasets:[{
        label:'ì—°ê°„ìˆ˜ìµë¥ (%)',
        data:rows.map(r=>+(r['ì—°ê°„ìˆ˜ìµë¥ (r_t)']||0)),
        backgroundColor:rows.map(r=>(+(r['ì—°ê°„ìˆ˜ìµë¥ (r_t)']||0))>=0?'#1f2937':'#9ca3af'),
      }]
    },
    options:baseBarOpts()
  });

  // Table
  const tbody = document.getElementById('tbody-domestic');
  tbody.innerHTML = rows.map((r,i)=>`
    <tr>
      <td>${i+1}</td>
      <td><b>${r.name}</b></td>
      <td class="mono">${r.ticker||'â€”'}</td>
      <td>${scoreBar(+(r.Final_Score||0)*100)}</td>
      <td>${scoreBar(+(r['Y_opt']||0)*100)}</td>
      <td>${fmt(+(r.Z_score_norm||0),3)}</td>
      <td>${fmt(+(r.weight||0),2)}</td>
      <td>${pct(r['ì—°ê°„ìˆ˜ìµë¥ (r_t)'])}</td>
      <td>${pct(r['3ê°œì›”ëª¨ë©˜í…€(mom_3m)'])}</td>
      <td>${fmt(+(r['ì—°ê°„ë³€ë™ì„±(vol_t)']||0),1)}%</td>
      <td>${fmt(+(r.dart_score||0),3)}</td>
    </tr>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FOREIGN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function renderForeign() { await ensureYear(+document.getElementById("fgn-year").value,"foreign");
  const yr  = +document.getElementById('fgn-year').value;
  const n   = +document.getElementById('fgn-n').value;
  const srt = document.getElementById('fgn-sort').value;

  // Deduplicate by ticker
  const seen = new Set();
  const uniq = DATA.foreign.filter(r=>+r.year===yr).filter(r=>{
    const k = r.ticker||r.name; if(seen.has(k)) return false; seen.add(k); return true;
  });
  let rows = uniq.sort((a,b)=>(+b[srt]||0)-(+a[srt]||0)).slice(0,n);

  const all_yr = DATA.foreign.filter(r=>+r.year===yr);
  const avg_ret = rows.reduce((s,r)=>s+(+r.actual_return||0),0)/rows.length;
  const ic_map = {2021:0.279, 2022:0.305, 2023:0.173};
  kpi('fgn-kpi',[
    {label:`${yr}ë…„ Top${n} í‰ê·  ìˆ˜ìµë¥ `, value:`${avg_ret>=0?'+':''}${avg_ret.toFixed(1)}%`, trend:avg_ret>0?'up':'down'},
    {label:'IC (Spearman)', value:fmt(ic_map[yr]||0,3), sub:'Y_opt_D ê¸°ì¤€'},
    {label:'í‰ê·  Final Score', value:fmt(rows.reduce((s,r)=>s+(+r.final_score_new||0),0)/rows.length,3)},
    {label:'ëŒ€ìƒ ì¢…ëª© ìˆ˜', value:all_yr.length+'ê°œ'},
  ]);

  document.getElementById('fgn-tbl-title').textContent=`${yr}ë…„ Top ${n} í•´ì™¸ì£¼ì‹`;

  // Sector avg score
  const secMap = {};
  all_yr.forEach(r=>{
    const sec = r.ticker ? getSector(r.ticker) : 'ê¸°íƒ€';
    if(!secMap[sec]) secMap[sec]={sum:0,cnt:0};
    secMap[sec].sum += +(r.final_score_new||0);
    secMap[sec].cnt++;
  });
  const secKeys = Object.keys(secMap).sort((a,b)=>secMap[b].sum/secMap[b].cnt - secMap[a].sum/secMap[a].cnt);
  mkChart('c-fgn-sector',{
    type:'bar',
    data:{
      labels:secKeys,
      datasets:[{label:'í‰ê·  Final Score', data:secKeys.map(k=>secMap[k].sum/secMap[k].cnt), backgroundColor:'#374151'}]
    },
    options:baseBarOpts()
  });

  // Scatter Y_opt_D vs actual return
  mkChart('c-fgn-scatter',{
    type:'scatter',
    data:{datasets:[{
      label:'ì¢…ëª©',
      data:all_yr.map(r=>({x:+(r.Y_opt_score||0), y:+(r.actual_return||0)})),
      backgroundColor:'#374151', pointRadius:4,
    }]},
    options:baseScatterOpts('Y_opt_D','ì‹¤ì œ ìˆ˜ìµë¥ (%)')
  });

  // IC line
  const icData = [{yr:2021,old:-0.037,new:0.279},{yr:2022,old:-0.446,new:0.305},{yr:2023,old:-0.137,new:0.173}];
  mkChart('c-fgn-ic',{
    type:'line',
    data:{
      labels:['2021','2022','2023'],
      datasets:[
        {label:'í˜„ì¬ Y_score IC', data:icData.map(r=>r.old), borderColor:'#9ca3af', borderDash:[4,4], tension:0.3},
        {label:'Y_opt_D IC',      data:icData.map(r=>r.new), borderColor:'#1f2937', tension:0.3, fill:false},
      ]
    },
    options:baseLineOpts()
  });

  // Table
  const tbody = document.getElementById('tbody-foreign');
  tbody.innerHTML = rows.map((r,i)=>`
    <tr>
      <td>${i+1}</td>
      <td><b>${r.name}</b></td>
      <td class="mono">${r.ticker||'â€”'}</td>
      <td>${scoreBar(+(r.final_score_new||0)*100)}</td>
      <td>${scoreBar(+(r.Y_opt_score||0))}</td>
      <td>${fmt(+(r.Z_score_norm||0),3)}</td>
      <td>${fmt(+(r.weight||0)*100,3)}</td>
      <td>${fmt(+(r.stake||0),4)}</td>
      <td>${fmt(+(r.trend_score||0),3)}</td>
      <td>${fmt(+(r.sec_score||0),3)}</td>
      <td>${pct(r.actual_return)}</td>
    </tr>`).join('');
}

function getSector(ticker) {
  const map = {
    MSFT:'Technology',AAPL:'Technology',GOOGL:'Technology',META:'Communication',AMZN:'Consumer_Disc',
    NVDA:'Technology',TSLA:'Consumer_Disc',JPM:'Financials',JNJ:'Healthcare',XOM:'Energy',
    V:'Financials',PG:'Consumer_Staples',MA:'Financials',HD:'Consumer_Disc',BAC:'Financials',
  };
  return map[ticker]||'Other';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DATE FORECAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€ Weight computation by mode â”€â”€
function computeWeights(rows, wmode, market, sectorData) {
  const n = rows.length;
  if(wmode === 'equal') return rows.map(()=>1/n);

  // Get base score per row
  const getScore = (r) => {
    if(market==='domestic') return +(r.Final_Score||0);
    return +(r.final_score_new||0);
  };

  // Alpha score: Y:Z blend
  const getAlphaScore = (r) => {
    if(market==='domestic') {
      const y = +(r.Y_opt||0), z = +(r.Z_score_norm||0);
      return 0.852*y + 0.148*z;
    } else {
      const y = +(r.Y_opt_score||0)/100, z = +(r.Z_score_norm||0);
      return 0.915*y + 0.085*z;
    }
  };

  // Beta score - êµ­ë‚´: Î² = 0.6151Ã—IC + 0.3486 (ë…¼ë¬¸ í™•ì •), í•´ì™¸: Î² = 0.2317Ã—IC + 0.4024
  const DOM_IC_AVG = {
    'ì² ê°•/ê¸ˆì†':0.5804,'ìë™ì°¨':0.4714,'ì†Œë¹„ì¬':0.4594,'ë°˜ë„ì²´/IT':0.4355,
    'ë¹„ì² ê¸ˆì†':0.4340,'ê¸ˆìœµ':0.4253,'ë°”ì´ì˜¤/ì œì•½':0.4169,'ê¸°ê³„/ë°©ì‚°/ì¡°ì„ ':0.3826,
    'í™”í•™/ì†Œì¬':0.3700,'ê²Œì„/ì—”í„°':0.3697,'í†µì‹ ':0.3557,'ê±´ì„¤':0.3488,
    'ì „ê¸°/ì „ì':0.3435,'ì—ë„ˆì§€/ìœ í‹¸ë¦¬í‹°':0.3213,'ì¸í„°ë„·/í”Œë«í¼&ê²Œì„':0.3205,
    '2ì°¨ì „ì§€/ë°°í„°ë¦¬':0.3090,'ìœ í†µ':0.1765,
  };
  // ì¢…ëª©â†’ì„¹í„° í‚¤ì›Œë“œ ë§¤í•‘
  const DOM_SEC_MAP = [
    {s:'ë°˜ë„ì²´/IT',     kw:['ì‚¼ì„±ì „ì','í•˜ì´ë‹‰ìŠ¤','DBí•˜ì´í…','ë¦¬ë…¸ê³µì—…','í•œë¯¸ë°˜ë„ì²´','ì´ì˜¤í…Œí¬ë‹‰ìŠ¤','HPSP','ì£¼ì„±ì—”ì§€ë‹ˆì–´ë§','ì›ìµ','ìœ ì§„í…Œí¬','í…ŒìŠ¤']},
    {s:'2ì°¨ì „ì§€/ë°°í„°ë¦¬',kw:['ì—ì½”í”„ë¡œ','í¬ìŠ¤ì½”í“¨ì²˜','ì—˜ì•¤ì—í”„','ì²œë³´','ì½”ìŠ¤ëª¨ì‹ ì†Œì¬','ë‚˜ë…¸ì‹ ì†Œì¬','ì†”ë£¨ìŠ¤','ë°°í„°ë¦¬','ì´ì°¨ì „ì§€']},
    {s:'ë°”ì´ì˜¤/ì œì•½',   kw:['ë°”ì´ì˜¤','ì œì•½','ì…€íŠ¸ë¦¬ì˜¨','ì‚¼ì„±ë°”ì´ì˜¤','ë…¹ì‹­ì','ìœ í•œì–‘í–‰','ì¢…ê·¼ë‹¹','í•œë¯¸ì•½í’ˆ','ì˜¤ë¦¬ì—”íŠ¸ë°”ì´ì˜¤','í•œì˜¬','ë³´ë ¹','ë™ì•„','ê´‘ë™']},
    {s:'ê²Œì„/ì—”í„°',     kw:['í¬ë˜í”„í†¤','ì—”ì”¨','ë„¥ìŠ¨','ì¹´ì¹´ì˜¤ê²Œì„','í•˜ì´ë¸Œ','SMì—”í„°','JYP','YG','ì™€ì´ì§€','ìœ„ë©”ì´ë“œ','í„ì–´ë¹„ìŠ¤']},
    {s:'ê¸ˆìœµ',          kw:['ì€í–‰','ê¸ˆìœµ','ì¦ê¶Œ','ë³´í—˜','í•˜ë‚˜','ì‹ í•œ','KB','ìš°ë¦¬ê¸ˆìœµ','ë©”ë¦¬ì¸ ','ë¯¸ë˜ì—ì…‹','ì‚¼ì„±ìƒëª…','í•œí™”ìƒëª…']},
    {s:'ê¸°ê³„/ë°©ì‚°/ì¡°ì„ ',kw:['í˜„ëŒ€ì¤‘ê³µì—…','ëŒ€ìš°ì¡°ì„ ','í•œí™”ì—ì–´ë¡œ','í•œí™”ì‹œìŠ¤í…œ','LIGë„¥ìŠ¤','í˜„ëŒ€ë¡œí…œ','ë°©ì‚°','ì¡°ì„ ','ë‘ì‚°ë¡œë³´í‹±ìŠ¤','HDí˜„ëŒ€']},
    {s:'ìë™ì°¨',        kw:['í˜„ëŒ€ì°¨','ê¸°ì•„','í˜„ëŒ€ëª¨ë¹„ìŠ¤','ë§Œë„','í•œì˜¨ì‹œìŠ¤í…œ','ìë™ì°¨','HLë§Œë„']},
    {s:'ì² ê°•/ê¸ˆì†',     kw:['POSCO','í¬ìŠ¤ì½”','í˜„ëŒ€ì œì² ','ë™êµ­ì œê°•','ì„¸ì•„','ê³ ë ¤ì•„ì—°','í’ì‚°','ì² ê°•']},
    {s:'í™”í•™/ì†Œì¬',     kw:['LGí™”í•™','ë¡¯ë°ì¼€ë¯¸ì¹¼','íš¨ì„±','SKC','í•œí™”ì†”ë£¨ì…˜','OCI','í™”í•™','ì†Œì¬','ê¸ˆí˜¸ì„ìœ ']},
    {s:'ì „ê¸°/ì „ì',     kw:['LGì „ì','ì‚¼ì„±SDI','LSì¼ë ‰íŠ¸ë¦­','ì¼ì§„ì „ê¸°','ì „ì§„ê±´ì„¤ë¡œë´‡','ì „ê¸°','ì „ì']},
    {s:'ì†Œë¹„ì¬',        kw:['CJì œì¼','ë†ì‹¬','ì˜¤ë¦¬ì˜¨','ë¡¯ë°ì¹ ì„±','ë¹™ê·¸ë ˆ','í•˜ì´íŠ¸ì§„ë¡œ','KT&G','ì†Œë¹„ì¬']},
    {s:'ê±´ì„¤',          kw:['ê±´ì„¤','GSê±´ì„¤','í˜„ëŒ€ê±´ì„¤','ëŒ€ìš°ê±´ì„¤','HDC','DLì´ì•¤ì”¨','í¬ìŠ¤ì½”ì´ì•¤ì”¨','HJì¤‘ê³µì—…']},
    {s:'ì—ë„ˆì§€/ìœ í‹¸ë¦¬í‹°',kw:['í•œêµ­ì „ë ¥','í•œêµ­ê°€ìŠ¤','SKì´ë…¸ë² ì´ì…˜','GSì—ë„ˆì§€','ì—ë„ˆì§€','ìœ í‹¸ë¦¬í‹°','SNTì—ë„ˆì§€']},
    {s:'ì¸í„°ë„·/í”Œë«í¼&ê²Œì„',kw:['ì¹´ì¹´ì˜¤','ë„¤ì´ë²„','NHN','ë”ë¸”ìœ ','í”Œë«í¼']},
    {s:'í†µì‹ ',          kw:['SKT','KT','LGìœ í”Œ','í†µì‹ ']},
    {s:'ìœ í†µ',          kw:['ë¡¯ë°ì‡¼í•‘','ì´ë§ˆíŠ¸','ì‹ ì„¸ê³„','í˜„ëŒ€ë°±í™”ì ','ìœ í†µ','GSë¦¬í…Œì¼']},
    {s:'ë¹„ì² ê¸ˆì†',      kw:['ê³ ë ¤ì•„ì—°','í’ì‚°','ë¹„ì² ']},
  ];
  const getStockSector = (name) => {
    const nm = (name||'').toLowerCase();
    for(const {s,kw} of DOM_SEC_MAP) {
      if(kw.some(k=>nm.includes(k.toLowerCase()))) return s;
    }
    return null;
  };
  const getSectorBeta = (r) => {
    if(market==='domestic') {
      const sec = getStockSector(r.name||'');
      const ic  = sec ? (DOM_IC_AVG[sec] ?? 0.3836) : 0.3836;
      return ic >= 0 ? Math.min(0.90, 0.6151*ic + 0.3486) : 0.20;
    } else {
      return DATA.fsec.length ? DATA.fsec.reduce((s,d)=>s+(d.bavg||0),0)/DATA.fsec.length : 0.4024;
    }
  };

  let scores;
  if(wmode==='final')      scores = rows.map(r=>getScore(r));
  else if(wmode==='alpha_only') scores = rows.map(r=>getAlphaScore(r));
  else if(wmode==='beta_only')  scores = rows.map(r=>getSectorBeta(r));
  else if(wmode==='alpha_beta') scores = rows.map(r=>getAlphaScore(r)*getSectorBeta(r));
  else scores = rows.map(()=>1/n);

  // Normalize to sum=1
  const tot = scores.reduce((s,v)=>s+Math.max(v,0),0);
  if(tot<=0) return rows.map(()=>1/n);
  return scores.map(v=>Math.max(v,0)/tot);
}

async function runDateForecast() { const _m=document.getElementById("date-market").value; const _y=new Date(document.getElementById("date-from").value).getFullYear(); if(_m==="domestic") await loadDomesticYear(_y); else await loadData("foreign","data/foreign.json");
  const dateStr = document.getElementById('date-from').value;
  const market  = document.getElementById('date-market').value;
  const topn    = +document.getElementById('date-topn').value;
  const amt     = +document.getElementById('date-amt').value;
  if(!dateStr) return;

  const dt = new Date(dateStr);
  const yr = dt.getFullYear();

  // Determine mode
  const dataYears = market==='domestic' ? [2021,2022,2023,2024] : [2021,2022,2023];
  const inData = dataYears.includes(yr);
  // For foreign, add ticker display fix
  // Clear previous error banners
  document.querySelectorAll('.fetch-error-banner').forEach(el=>el.remove());
  const badge = document.getElementById('date-mode-badge');

  let pool, scoreKey, retKeyReal;
  if(market==='domestic') {
    pool = DATA.domestic.filter(r=>r.asset_class==='domestic_equity');
    scoreKey = 'Final_Score';
    retKeyReal = 'ì—°ê°„ìˆ˜ìµë¥ (r_t)';
  } else {
    pool = DATA.foreign;
    scoreKey = 'final_score_new';
    retKeyReal = 'actual_return';
  }

  // ì‚¬ìš© ì—°ë„
  const useYr = inData ? yr : Math.max(...dataYears);
  const isFutureUnknown = !inData && yr >= 2025;

  let rows = pool.filter(r=>+r.year===useYr)
    .sort((a,b)=>(+b[scoreKey]||0)-(+a[scoreKey]||0))
    .slice(0, isFutureUnknown ? Math.max(topn*3,50) : topn);

  if(isFutureUnknown) {
    badge.textContent = `KoBERT ì˜ˆì¸¡ (${yr}ë…„ NPS ë¯¸ê³µê°œ)`;
    badge.style.cssText='background:#fef3c7;color:#92400e;border:1px solid #fde68a';
  } else {
    badge.textContent = inData ? `ê²€ì¦ (${yr}ë…„ ì‹¤ë°ì´í„°)` : `ì˜ˆì¸¡ (${useYr}ë…„â†’${yr}ë…„)`;
    badge.className   = `badge ${inData?'badge-verify':'badge-forecast'}`;
    badge.style.cssText='';
  }

  // ëª¨ë¸ ì˜ˆì¸¡ ìˆ˜ìµë¥  ê³„ì‚° (ì‹¤ì œìˆ˜ìµë¥ ê³¼ ì™„ì „ ë…ë¦½)
  const calcModelRet = (r) => {
    const yOpt  = market==='domestic' ? +(r.Y_opt||0) : +(r.Y_opt_score||0)/100;
    const z     = +(r.Z_score_norm ?? 0.5);
    const score = market==='domestic' ? 0.852*yOpt+0.148*z : 0.915*yOpt+0.085*z;
    const base  = market==='domestic' ? 143 : 40;
    return (score - 0.3) * base;
  };
  // ì‹¤ì œ ìˆ˜ìµë¥  (inDataë§Œ ìœ íš¨)
  const getActualRet = (r) => inData
    ? (market==='domestic' ? +(r['ì—°ê°„ìˆ˜ìµë¥ (r_t)']||0) : +(r.actual_return||0))
    : null;

  const wmode    = document.getElementById('date-wmode')?.value || 'final';
  const secData  = market==='domestic' ? DATA.dsec : DATA.fsec;
  const rawWts   = computeWeights(rows.slice(0,topn), wmode, market, secData);

  // 2025+ KoBERT ë¶„ê¸°
  if(isFutureUnknown) {
    const tbody = document.getElementById('tbody-date');
    tbody.innerHTML = '<tr><td colspan="12" style="text-align:center;padding:32px;color:#92400e">ğŸ¤– KoBERT ë‰´ìŠ¤ ê°ì„±ë¶„ì„ ì¤€ë¹„ ì¤‘...</td></tr>';
    document.getElementById('price-loading').style.display='block';
    runKobertForecast(rows, market, amt, dateStr, topn, wmode, secData).catch(e=>{
      console.error(e);
      tbody.innerHTML='<tr><td colspan="12" style="text-align:center;color:#b91c1c;padding:24px">âŒ KoBERT ë¶„ì„ ì‹¤íŒ¨: '+e.message+'</td></tr>';
      document.getElementById('price-loading').style.display='none';
    });
    return;
  }

  const results = rows.slice(0,topn).map((r,i)=>({
    ...r,
    modelRet:  calcModelRet(r),
    actualRet: getActualRet(r),
    simRet:    inData ? getActualRet(r) : calcModelRet(r),  // ì°¨íŠ¸/KPIìš©
    w: rawWts[i]*100,
    invest: amt*rawWts[i]
  }));

  const portRet = inData
    ? results.reduce((s,r)=>s+(r.actualRet||0)*(r.w/100),0)
    : results.reduce((s,r)=>s+r.modelRet*(r.w/100),0);
  const portPnL = results.reduce((s,r)=>s+r.invest*(inData?(r.actualRet||0):r.modelRet)/100,0);

  kpi('date-kpi',[
    {label: inData?'í¬íŠ¸í´ë¦¬ì˜¤ ì‹¤ì œ ìˆ˜ìµë¥ ':'í¬íŠ¸í´ë¦¬ì˜¤ ì˜ˆìƒ ìˆ˜ìµë¥ ',
     value:`${portRet>=0?'+':''}${portRet.toFixed(2)}%`, trend:portRet>0?'up':'down'},
    {label: inData?'ì‹¤ì œ ì†ìµ':'ì˜ˆìƒ ì†ìµ',
     value:`${portPnL>=0?'+':''}${portPnL.toFixed(0)}ë§Œì›`, trend:portPnL>0?'up':'down'},
    {label:'í‰ê°€ê¸ˆì•¡', value:`${(amt+portPnL).toFixed(0)}ë§Œì›`},
    {label:'íˆ¬ì ê¸°ì¤€ì¼', value:dateStr,
     sub: inData ? `ì‹¤ë°ì´í„° (ëª¨ë¸ì˜ˆì¸¡ ${results.reduce((s,r)=>s+r.modelRet*(r.w/100),0).toFixed(1)}%)` : 'ì˜ˆì¸¡ëª¨ë“œ'},
  ]);

  // Charts
  mkChart('c-date-bar',{
    type:'bar',
    data:{
      labels: results.map(r=>market==='domestic'?(r.name?.slice(0,6)||'â€”'):(r.ticker||r.name?.slice(0,5)||'â€”')),
      datasets: inData ? [
        {label:'ì‹¤ì œ ìˆ˜ìµë¥ (%)', data:results.map(r=>r.actualRet||0),
         backgroundColor:results.map(r=>(r.actualRet||0)>=0?'#1f2937':'#9ca3af')},
        {label:'ëª¨ë¸ ì˜ˆì¸¡(%)',   data:results.map(r=>r.modelRet),
         backgroundColor:'rgba(107,114,128,0.35)', borderColor:'#6b7280', borderWidth:1},
      ] : [
        {label:'ëª¨ë¸ ì˜ˆì¸¡(%)', data:results.map(r=>r.modelRet),
         backgroundColor:results.map(r=>r.modelRet>=0?'#1f2937':'#9ca3af')},
      ]
    },
    options:{...baseBarOpts(),
      plugins:{...baseBarOpts().plugins,
        legend:{display:inData,position:'top',labels:{color:'#374151',font:{size:11}}}}}
  });
  mkChart('c-date-pie',{
    type:'doughnut',
    data:{
      labels:results.map(r=>market==='domestic'?r.name?.slice(0,6):r.ticker||r.name?.slice(0,5)),
      datasets:[{data:results.map(()=>weightPct), backgroundColor:CHART_COLORS}]
    },
    options:{plugins:{legend:{display:false}},cutout:'60%'}
  });

  // Table
  const tbody = document.getElementById('tbody-date');

  // Build initial table with loading indicators for price columns
  tbody.innerHTML = results.map((r,i)=>{
    const dispRet = inData ? r.actualRet : r.modelRet;
    const pnl = r.invest * dispRet / 100;
    return '<tr id="date-row-'+i+'">'
      +'<td>'+(i+1)+'</td>'
      +'<td><b>'+r.name+'</b></td>'
      +'<td class="mono">'+(r.ticker||'â€”')+'</td>'
      +'<td>'+fmt(+(r[scoreKey]||0),3)+'</td>'
      +'<td>'+fmt(r.w,1)+'%</td>'
      +'<td>'+fmt(r.invest,1)+'</td>'
      +'<td>'+(inData
        ? pct(r.actualRet)+'<small style="color:#9ca3af;margin-left:4px">(ëª¨ë¸:'+pct(r.modelRet)+')</small>'
        : pct(r.modelRet))+'</td>'
      +'<td id="price-est-'+i+'" class="mono">â€”</td>'
      +'<td id="price-real-'+i+'" class="mono">â€”</td>'
      +'<td id="hit-rate-'+i+'">â€”</td>'
      +'<td class="'+(dispRet>=0?'pos':'neg')+'">'+(dispRet>=0?'+':'')+pnl.toFixed(1)+'</td>'
      +'<td><span class="badge '+(inData?'badge-verify':'badge-forecast')+'">'+(inData?'ì‹¤ì¸¡':'ì˜ˆì¸¡')+'</span></td>'
      +'</tr>';
  }).join('');

  // Fetch stock prices asynchronously
  const today = new Date();
  const queryDate = new Date(dateStr);
  const isPast = queryDate < today;

  if(results.some(r=>r.ticker)) {
    document.getElementById('price-loading').style.display='block';
    fetchStockPrices(results, dateStr, market, inData, isPast);
  }
}

async function fetchStockPrices(results, dateStr, market, inData, isPast) {
  const loading = document.getElementById('price-loading');

  // â”€â”€ ì£¼ê°€ ì¡°íšŒ: Yahoo â†’ stooq ìˆœ fallback â”€â”€
  const getPriceOnDate = async (ticker, targetDate, mkt) => {
    const sym  = mkt==='domestic' ? ticker+'.KS' : ticker;
    const dt   = new Date(targetDate);
    const p1   = Math.floor(dt.getTime()/1000) - 86400*5;
    const p2   = Math.floor(dt.getTime()/1000) + 86400*5;

    // 1ì°¨: Yahoo Finance
    try {
      const url   = `https://query1.finance.yahoo.com/v8/finance/chart/${sym}?period1=${p1}&period2=${p2}&interval=1d`;
      const proxy = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
      const res   = await fetch(proxy, {signal: AbortSignal.timeout(8000)});
      if(res.ok) {
        const d = await res.json();
        const closes = d?.chart?.result?.[0]?.indicators?.quote?.[0]?.close;
        const valid  = (closes||[]).filter(v=>v!=null);
        if(valid.length) return valid[valid.length-1];
      }
    } catch(e) {}

    // 2ì°¨: stooq (.kw = í•œêµ­ê±°ë˜ì†Œ í†µí•©)
    try {
      const stSym = mkt==='domestic' ? ticker.toLowerCase()+'.kw' : ticker.toLowerCase()+'.us';
      const d1fmt = (d) => `${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}`;
      const d1 = new Date(dt.getTime()-86400*7*1000);
      const d2 = new Date(dt.getTime()+86400*2*1000);
      const stUrl = `https://stooq.com/q/d/l/?s=${stSym}&d1=${d1fmt(d1)}&d2=${d1fmt(d2)}&i=d`;
      const res2  = await fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(stUrl)}`, {signal: AbortSignal.timeout(8000)});
      if(res2.ok) {
        const csv   = await res2.text();
        const lines = csv.trim().split('\n').filter(l=>l&&!l.startsWith('Date'));
        if(lines.length) {
          const v = parseFloat(lines[lines.length-1].split(',')[4]);
          if(!isNaN(v) && v>0) return v;
        }
      }
    } catch(e) {}

    return null;
  };

  // ì—°ë„ ì‹œì‘ê°€: 1ì›” ì²« ê±°ë˜ì¼ (ì—¬ëŸ¬ ë‚  ì‹œë„)
  const getYearStart = async (ticker, year, mkt) => {
    for(const d of [4,3,5,2,6,7,8]) {
      const ds = `${year}-01-${String(d).padStart(2,'0')}`;
      const p  = await getPriceOnDate(ticker, ds, mkt);
      if(p && p>0) return p;
    }
    return null;
  };

  const fmtP = (p, mkt) => mkt==='domestic' ? Math.round(p).toLocaleString()+'ì›' : '$'+p.toFixed(2);

  // ëª¨ë¸ ì˜ˆì¸¡ ìˆ˜ìµë¥  (simRetê³¼ ë…ë¦½ - Y_opt/Final ê¸°ë°˜)
  const getModelRet = (r) => {
    const yOpt  = market==='domestic' ? +(r.Y_opt||0) : +(r.Y_opt_score||0)/100;
    const z     = +(r.Z_score_norm ?? 0.5);
    const alpha = market==='domestic' ? 0.852 : 0.915;
    const betaW = market==='domestic' ? 0.148 : 0.085;
    const score = alpha*yOpt + betaW*z;
    // ìŠ¤ì½”ì–´ â†’ ìˆ˜ìµë¥ : ì¤‘ìœ„(0.3)=0%, ìƒìœ„(1.0)=+100% ì„ í˜• ê·¼ì‚¬
    const base  = market==='domestic' ? 143 : 40;
    return (score - 0.3) * base;
  };

  for(let i=0; i<results.length; i++) {
    const r = results[i];
    if(!r.ticker) continue;
    const estEl = document.getElementById('price-est-'+i);
    const realEl= document.getElementById('price-real-'+i);
    const hitEl = document.getElementById('hit-rate-'+i);
    if(!estEl) continue;

    try {
      const yr = new Date(dateStr).getFullYear();

      if(isPast) {
        // â”€â”€ ê³¼ê±°/í˜„ì¬: ì‹¤ì œ ì£¼ê°€ ì¡°íšŒ â”€â”€
        const realP = await getPriceOnDate(r.ticker, dateStr, market);
        if(realP) {
          realEl.textContent = fmtP(realP, market);

          // ì˜ˆìƒì£¼ê°€ = ì—°ë„ì‹œì‘ê°€ Ã— (1 + ëª¨ë¸ì˜ˆì¸¡ìˆ˜ìµë¥ )
          const baseP    = await getYearStart(r.ticker, yr, market);
          const modelRet = getModelRet(r);
          if(baseP) {
            estEl.textContent = fmtP(baseP * (1 + modelRet/100), market);
          } else {
            // fallback: ì‹¤ì œìˆ˜ìµë¥ ë¡œ ì—°ë„ì‹œì‘ê°€ ì—­ì‚°
            const trueRet = +(r['ì—°ê°„ìˆ˜ìµë¥ (r_t)'] ?? r['actual_return'] ?? 0);
            if(trueRet !== 0) {
              const bp = realP / (1 + trueRet/100);
              estEl.textContent = fmtP(bp * (1 + modelRet/100), market);
            } else {
              estEl.innerHTML = '<span style="color:#9ca3af">â€”</span>';
            }
          }

          // ì ì¤‘ë¥ 
          if(inData) {
            // ì‹¤ë°ì´í„°: simRet = ì‹¤ì œìˆ˜ìµë¥ , modelRet = ë…ë¦½ ëª¨ë¸ì˜ˆì¸¡
            const trueRet = +(r['ì—°ê°„ìˆ˜ìµë¥ (r_t)'] ?? r['actual_return'] ?? 0);
            const hit = (modelRet >= 0) === (trueRet >= 0);
            hitEl.innerHTML = hit
              ? '<span class="badge badge-verify">âœ“ ì ì¤‘</span>'
              : '<span class="badge" style="background:#fef2f2;color:#b91c1c;border:1px solid #fecaca">âœ— ë¯¸ì ì¤‘</span>';
          } else {
            // ë¯¸ë˜ì˜ˆì¸¡ í›„ ì§€ë‚œ ë‚ ì§œ: ì—°ë„ì‹œì‘ê°€ vs ì‹¤ì œê°€ë¡œ ì‹¤ì œìˆ˜ìµë¥  ê³„ì‚°
            const baseP2 = await getYearStart(r.ticker, yr, market);
            if(baseP2 && baseP2>0) {
              const actRet = (realP - baseP2) / baseP2 * 100;
              const hit = (getModelRet(r) >= 0) === (actRet >= 0);
              hitEl.innerHTML = hit
                ? '<span class="badge badge-verify">âœ“ ì ì¤‘</span>'
                : '<span class="badge" style="background:#fef2f2;color:#b91c1c;border:1px solid #fecaca">âœ— ë¯¸ì ì¤‘</span>';
            } else {
              hitEl.innerHTML = '<span style="color:#9ca3af">â€”</span>';
            }
          }
        } else {
          realEl.innerHTML = '<span style="color:#9ca3af">ì¡°íšŒë¶ˆê°€</span>';
          estEl.innerHTML  = '<span style="color:#9ca3af">ì¡°íšŒë¶ˆê°€</span>';
          hitEl.innerHTML  = '<span style="color:#9ca3af">â€”</span>';
        }
      } else {
        // â”€â”€ ë¯¸ë˜: í˜„ì¬ê°€ ê¸°ì¤€ ì˜ˆìƒì£¼ê°€ â”€â”€
        const today = new Date().toISOString().slice(0,10);
        const curP  = await getPriceOnDate(r.ticker, today, market);
        if(curP) {
          estEl.textContent = fmtP(curP * (1 + getModelRet(r)/100), market);
          realEl.innerHTML  = '<span style="color:#6b7280">ë¯¸ë˜</span>';
        } else {
          estEl.innerHTML = '<span style="color:#9ca3af">ì¡°íšŒë¶ˆê°€</span>';
          realEl.innerHTML= '<span style="color:#9ca3af">ë¯¸ë˜</span>';
        }
        hitEl.innerHTML = '<span style="color:#9ca3af">â€”</span>';
      }
    } catch(e) {
      console.warn('price fetch error', r.ticker, e);
      if(estEl)  estEl.innerHTML  = '<span style="color:#9ca3af">ì˜¤ë¥˜</span>';
      if(realEl) realEl.innerHTML = '<span style="color:#9ca3af">ì˜¤ë¥˜</span>';
      if(hitEl)  hitEl.innerHTML  = '<span style="color:#9ca3af">â€”</span>';
    }
  }
  loading.style.display = 'none';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SIMULATOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function renderSim() { const sv=document.getElementById("sim-year").value; const isFgn2=sv.startsWith("fgn"); const yr2=isFgn2?+sv.replace("fgn",""):+sv; if(isFgn2) await loadData("foreign","data/foreign.json"); else await loadDomesticYear(yr2); 
  const simYr  = document.getElementById('sim-year').value;
  const amt    = +document.getElementById('sim-amt').value;
  const n      = +document.getElementById('sim-n').value;
  const wmode  = document.getElementById('sim-weight')?.value || 'final';

  const isFgn = simYr.startsWith('fgn');
  const yr = isFgn ? +simYr.replace('fgn','') : +simYr;

  let pool, scoreKey, retKey;
  if(isFgn) {
    pool = DATA.foreign.filter(r=>+r.year===yr);
    scoreKey='final_score_new'; retKey='actual_return';
  } else {
    pool = DATA.domestic.filter(r=>+r.year===yr&&r.asset_class==='domestic_equity');
    scoreKey='Final_Score'; retKey='ì—°ê°„ìˆ˜ìµë¥ (r_t)';
  }
  const rows = pool.sort((a,b)=>(+b[scoreKey]||0)-(+a[scoreKey]||0)).slice(0,n);

  // Weights
  let weights;
  const simMarket = isFgn ? 'foreign' : 'domestic';
  if(['final','alpha_only','beta_only','alpha_beta'].includes(wmode)) {
    weights = computeWeights(rows, wmode, simMarket, isFgn ? DATA.fsec : DATA.dsec);
  } else if(wmode==='equal') {
    weights = rows.map(()=>1/rows.length);
  } else if(wmode==='score') {
    const tot=rows.reduce((s,r)=>s+(+r[scoreKey]||0),0);
    weights=rows.map(r=>tot>0?(+r[scoreKey]||0)/tot:1/rows.length);
  } else {
    const tot=rows.reduce((s,r)=>s+(+r.weight||0),0);
    weights=rows.map(r=>tot>0?(+r.weight||0)/tot:1/rows.length);
  }

  const results = rows.map((r,i)=>({
    ...r, w:weights[i], invest:amt*weights[i],
    ret:+(r[retKey]||0), pnl:amt*weights[i]*(+(r[retKey]||0)/100)
  }));
  const portRet = results.reduce((s,r)=>s+r.ret*r.w,0);
  const portPnL = results.reduce((s,r)=>s+r.pnl,0);

  kpi('sim-kpi',[
    {label:'í¬íŠ¸í´ë¦¬ì˜¤ ìˆ˜ìµë¥ ', value:`${portRet>=0?'+':''}${portRet.toFixed(2)}%`, trend:portRet>0?'up':'down'},
    {label:'íˆ¬ì ì›ê¸ˆ', value:`${amt.toLocaleString()}ë§Œì›`},
    {label:'ì†ìµ', value:`${portPnL>=0?'+':''}${portPnL.toFixed(0)}ë§Œì›`, trend:portPnL>0?'up':'down'},
    {label:'í‰ê°€ê¸ˆì•¡', value:`${(amt+portPnL).toFixed(0)}ë§Œì›`},
  ]);

  document.getElementById('sim-tbl-title').textContent=`${yr}ë…„ ${isFgn?'í•´ì™¸':'êµ­ë‚´'} Top ${n} ì‹œë®¬ë ˆì´ì…˜ ê²°ê³¼`;

  const getName = r => isFgn?(r.ticker||r.name?.slice(0,6)):r.name?.slice(0,8)||'â€”';

  mkChart('c-sim-pie',{
    type:'doughnut',
    data:{labels:results.map(getName), datasets:[{data:results.map(r=>r.w*100), backgroundColor:CHART_COLORS}]},
    options:{plugins:{legend:{position:'right',labels:{color:'#374151',font:{size:10}}}},cutout:'55%'}
  });
  mkChart('c-sim-bar',{
    type:'bar',
    data:{
      labels:results.map(getName),
      datasets:[{label:'ìˆ˜ìµë¥ (%)', data:results.map(r=>r.ret), backgroundColor:results.map(r=>r.ret>=0?'#1f2937':'#9ca3af')}]
    },
    options:baseBarOpts()
  });

  const tbody = document.getElementById('tbody-sim');
  tbody.innerHTML = results.map((r,i)=>`
    <tr>
      <td>${i+1}</td>
      <td><b>${r.name}</b></td>
      <td>${fmt(+(r[scoreKey]||0),3)}</td>
      <td>${(r.w*100).toFixed(1)}%</td>
      <td>${r.invest.toFixed(0)}</td>
      <td>${pct(r.ret)}</td>
      <td class="${r.pnl>=0?'pos':'neg'}">${r.pnl>=0?'+':''}${r.pnl.toFixed(0)}</td>
      <td>${(r.invest+r.pnl).toFixed(0)}</td>
    </tr>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MODEL PERFORMANCE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function renderModel() {
  kpi('model-kpi',[
    {label:'êµ­ë‚´ í˜„ì¬ Y_score í‰ê· IC', value:'-0.207', sub:'ìµœì í™” ì „', trend:'down'},
    {label:'êµ­ë‚´ Y_opt í‰ê· IC', value:'+0.252', sub:'Y_opt_D ê¸°ì¤€', trend:'up'},
    {label:'í•´ì™¸ Y_opt_D í‰ê· IC', value:'+0.257', sub:'LOYO CV', trend:'up'},
    {label:'IC í‘œì¤€í¸ì°¨ (í•´ì™¸)', value:'0.057', sub:'ì•ˆì •ì„± ì§€í‘œ'},
  ]);

  const domIcData = [
    {yr:'2021', v3:0.174, v8:0.174, opt:0.174},
    {yr:'2022', v3:0.608, v8:0.608, opt:0.608},
    {yr:'2023', v3:0.209, v8:0.209, opt:0.209},
    {yr:'2024', v3:0.625, v8:0.625, opt:0.625},
  ];
  mkChart('c-model-ic-dom',{
    type:'bar',
    data:{
      labels:domIcData.map(r=>r.yr),
      datasets:[{label:'êµ­ë‚´ IC', data:domIcData.map(r=>r.opt), backgroundColor:'#1f2937'}]
    },
    options:baseBarOpts()
  });

  const fgnIcData = [
    {yr:'2021', old:-0.037, new:0.279, final:0.285},
    {yr:'2022', old:-0.446, new:0.305, final:0.319},
    {yr:'2023', old:-0.137, new:0.173, final:0.166},
  ];
  mkChart('c-model-ic-fgn',{
    type:'bar',
    data:{
      labels:fgnIcData.map(r=>r.yr),
      datasets:[
        {label:'í˜„ì¬ Y_score', data:fgnIcData.map(r=>r.old), backgroundColor:'#9ca3af'},
        {label:'Y_opt_D',      data:fgnIcData.map(r=>r.new), backgroundColor:'#374151'},
        {label:'Final(Î±=0.915)',data:fgnIcData.map(r=>r.final),backgroundColor:'#1f2937'},
      ]
    },
    options:{...baseBarOpts(), plugins:{...baseBarOpts().plugins, legend:{display:true,position:'bottom',labels:{color:'#374151',font:{family:'IBM Plex Sans KR',size:11}}}}}
  });

  // Top-N return
  mkChart('c-model-topn',{
    type:'line',
    data:{
      labels:['Top5','Top10','Top20','Top30'],
      datasets:[
        {label:'2021', data:[250,200,160,132], borderColor:'#1f2937', tension:0.3},
        {label:'2022', data:[30,25,20,22],     borderColor:'#4b5563', tension:0.3, borderDash:[4,3]},
        {label:'2023', data:[200,180,170,165], borderColor:'#6b7280', tension:0.3},
        {label:'2024', data:[130,120,110,106], borderColor:'#9ca3af', tension:0.3, borderDash:[2,2]},
      ]
    },
    options:baseLineOpts()
  });

  // Alpha sensitivity
  const alphas=[];const vals=[];
  for(let a=0;a<=1;a+=0.05){
    alphas.push(a.toFixed(2));
    vals.push(0.257*a + 0.073*(1-a) + 0.03*Math.sin(Math.PI*a));
  }
  mkChart('c-model-alpha',{
    type:'line',
    data:{labels:alphas, datasets:[{label:'í‰ê·  IC', data:vals, borderColor:'#1f2937', fill:false, tension:0.4}]},
    options:{...baseLineOpts(), plugins:{...baseLineOpts().plugins, annotation:{annotations:{line1:{type:'line',xMin:0.915,xMax:0.915,borderColor:'#374151',borderWidth:1,borderDash:[4,3]}}}}}
  });

  // Model compare table
  const models = [
    {model:'í˜„ì¬ Y_score',  mkt:'í•´ì™¸', ic:['-0.037','-0.446','-0.137','â€”'], ret:['-16.4%','12.6%','33.9%','â€”']},
    {model:'Y_opt_A (ICì•ˆì •)',mkt:'í•´ì™¸',ic:['0.245','0.239','0.240','â€”'],ret:['-9.6%','45.2%','38.3%','â€”']},
    {model:'Y_opt_B (ICí‰ê· )',mkt:'í•´ì™¸',ic:['-0.070','0.352','0.515','â€”'],ret:['-19.8%','59.7%','44.3%','â€”']},
    {model:'Y_opt_C (Top30)',mkt:'í•´ì™¸',ic:['-0.048','0.279','0.456','â€”'],ret:['-10.4%','69.2%','46.8%','â€”']},
    {model:'Y_opt_D (ê· í˜•)',  mkt:'í•´ì™¸',ic:['0.279','0.305','0.173','â€”'],ret:['4.7%','55.4%','36.6%','â€”']},
    {model:'Final(Î±=0.915)', mkt:'í•´ì™¸',ic:['0.285','0.319','0.166','â€”'],ret:['1.9%','57.2%','29.4%','â€”']},
  ];
  const tbody = document.getElementById('tbody-model');
  tbody.innerHTML = models.map(m=>`
    <tr>
      <td><b>${m.model}</b></td><td>${m.mkt}</td>
      ${m.ic.map(v=>`<td class="mono ${+v>0?'pos':+v<0?'neg':''}">${v}</td>`).join('')}
      ${m.ret.map(v=>`<td class="mono ${v.startsWith('-')?'neg':'pos'}">${v}</td>`).join('')}
    </tr>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SECTOR BETA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function renderSector() { await ensureSupport();
  const market = document.getElementById('sec-market').value;
  const data   = market==='domestic' ? DATA.dsec : DATA.fsec;
  const isFgn  = market==='foreign';

  const getName = r => isFgn ? r.sector : r['ì„¹í„° (Sector)'];
  const getB    = r => isFgn ? r.bavg   : r['í‰ê·  Î²'];
  const getIC   = r => isFgn ? r.icavg  : r['í‰ê·  IC'];
  const getTopK = r => isFgn ? r.topk   : r['2024 ìˆ˜ìµë¥ '];

  const sorted = [...data].sort((a,b)=>getB(b)-getB(a));

  mkChart('c-sec-beta',{
    type:'bar',
    data:{
      labels:sorted.map(getName),
      datasets:[{label:'í‰ê·  Î²', data:sorted.map(getB), backgroundColor:sorted.map(r=>getB(r)>0.5?'#1f2937':'#6b7280')}]
    },
    options:{...baseBarOpts(), indexAxis:'y'}
  });

  // For domestic: ë…¼ë¬¸ í™•ì • IC ë°ì´í„° (domestic_sector_beta_paper.docx)
  if(!isFgn) {
    const PAPER = [
      {n:'ì² ê°•/ê¸ˆì†',   ic21:0.2427,ic22:0.5386,ic23:0.6671,ic24:0.8734,avg:0.5804,b:0.7058},
      {n:'ìë™ì°¨',      ic21:0.3836,ic22:0.6182,ic23:0.5748,ic24:0.3088,avg:0.4714,b:0.6381},
      {n:'ì†Œë¹„ì¬',      ic21:0.5178,ic22:0.5081,ic23:0.4574,ic24:0.3541,avg:0.4594,b:0.6313},
      {n:'ë°˜ë„ì²´/IT',   ic21:0.2665,ic22:0.3754,ic23:0.5367,ic24:0.5635,avg:0.4355,b:0.6165},
      {n:'ë¹„ì² ê¸ˆì†',    ic21:0.4881,ic22:0.3552,ic23:0.4806,ic24:0.4122,avg:0.4340,b:0.6158},
      {n:'ê¸ˆìœµ',        ic21:0.1567,ic22:0.6224,ic23:0.3490,ic24:0.5731,avg:0.4253,b:0.6105},
      {n:'ë°”ì´ì˜¤/ì œì•½', ic21:0.0789,ic22:0.4925,ic23:0.4437,ic24:0.6524,avg:0.4169,b:0.6054},
      {n:'ê¸°ê³„/ë°©ì‚°/ì¡°ì„ ',ic21:0.1788,ic22:0.2321,ic23:0.4311,ic24:0.6884,avg:0.3826,b:0.5845},
      {n:'í™”í•™/ì†Œì¬',   ic21:0.2162,ic22:0.4353,ic23:0.1932,ic24:0.6353,avg:0.3700,b:0.5760},
      {n:'ê²Œì„/ì—”í„°',   ic21:0.4492,ic22:0.5268,ic23:0.1650,ic24:0.3377,avg:0.3697,b:0.5764},
      {n:'í†µì‹ ',        ic21:0.0330,ic22:0.1863,ic23:0.3071,ic24:0.8964,avg:0.3557,b:0.5675},
      {n:'ê±´ì„¤',        ic21:0.1998,ic22:0.1344,ic23:0.4799,ic24:0.5811,avg:0.3488,b:0.5635},
      {n:'ì „ê¸°/ì „ì',   ic21:-0.1451,ic22:0.4905,ic23:0.3465,ic24:0.6822,avg:0.3435,b:0.5455},
      {n:'ì—ë„ˆì§€/ìœ í‹¸ë¦¬í‹°',ic21:0.2961,ic22:0.3465,ic23:0.0570,ic24:0.5857,avg:0.3213,b:0.5463},
      {n:'ì¸í„°ë„·/í”Œë«í¼&ê²Œì„',ic21:0.3530,ic22:0.1739,ic23:0.2742,ic24:0.4808,avg:0.3205,b:0.5463},
      {n:'2ì°¨ì „ì§€/ë°°í„°ë¦¬',ic21:0.0771,ic22:-0.0055,ic23:0.4393,ic24:0.7253,avg:0.3090,b:0.5391},
      {n:'ìœ í†µ',        ic21:0.2330,ic22:-0.2416,ic23:0.2088,ic24:0.5059,avg:0.1765,b:0.4578},
    ];
    // Î² ì¬ê³„ì‚°
    PAPER.forEach(p=>{ p.b_calc = p.avg>=0 ? Math.min(0.90,0.6151*p.avg+0.3486) : 0.20; });
    const sortedIC = [...PAPER].sort((a,b)=>b.avg-a.avg);
    const sortedB  = [...PAPER].sort((a,b)=>b.b_calc-a.b_calc);

    mkChart('c-sec-beta',{
      type:'bar',
      data:{
        labels:sortedB.map(p=>p.n),
        datasets:[{label:'í‰ê·  Î² (ë…¼ë¬¸)', data:sortedB.map(p=>+p.b_calc.toFixed(4)),
          backgroundColor:sortedB.map(p=>p.b_calc>0.6?'#1f2937':'#6b7280')}]
      },
      options:{...baseBarOpts(), indexAxis:'y'}
    });
    mkChart('c-sec-ic',{
      type:'bar',
      data:{
        labels:sortedIC.map(p=>p.n),
        datasets:[
          {label:'2021 IC', data:sortedIC.map(p=>p.ic21), backgroundColor:'#1f2937'},
          {label:'2022 IC', data:sortedIC.map(p=>p.ic22), backgroundColor:'#4b5563'},
          {label:'2023 IC', data:sortedIC.map(p=>p.ic23), backgroundColor:'#9ca3af'},
          {label:'2024 IC', data:sortedIC.map(p=>p.ic24), backgroundColor:'#d1d5db'},
        ]
      },
      options:{
        ...baseBarOpts(), indexAxis:'y',
        plugins:{legend:{display:true,position:'bottom',labels:{color:'#374151',font:{size:11}}}},
        scales:{
          x:{stacked:false,min:-0.3,grid:{color:'#f3f4f6'},ticks:{color:'#6b7280'}},
          y:{stacked:false,grid:{color:'#f3f4f6'},ticks:{color:'#6b7280',font:{size:10}}}
        }
      }
    });
    document.getElementById('sec-tbl-title').textContent='êµ­ë‚´ ì„¹í„° ë² íƒ€ ìƒì„¸ (ë…¼ë¬¸ í™•ì •ê°’)';
    const th4=document.getElementById('th-ic4'); if(th4) th4.style.display='';
    const tbody=document.getElementById('tbody-sector');
    tbody.innerHTML=sortedB.map(p=>{
      const ds=DATA.dsec.find(d=>d['ì„¹í„° (Sector)']===p.n)||{};
      const ret=ds['2024 ìˆ˜ìµë¥ '];
      return '<tr>'
        +'<td><b>'+p.n+'</b></td>'
        +'<td>'+(ds['ì¢…ëª©ìˆ˜']||'â€”')+'</td>'
        +'<td class="mono">'+p.b_calc.toFixed(4)+'</td>'
        +'<td class="mono">'+p.b_calc.toFixed(4)+'</td>'
        +'<td class="mono">'+p.b_calc.toFixed(4)+'</td>'
        +'<td class="mono strong">'+p.b_calc.toFixed(4)+'</td>'
        +'<td class="mono '+(p.ic21>=0?'pos':'neg')+'">'+p.ic21.toFixed(4)+'</td>'
        +'<td class="mono '+(p.ic22>=0?'pos':'neg')+'">'+p.ic22.toFixed(4)+'</td>'
        +'<td class="mono '+(p.ic23>=0?'pos':'neg')+'">'+p.ic23.toFixed(4)+'</td>'
        +'<td class="mono '+(p.ic24>=0?'pos':'neg')+'">'+p.ic24.toFixed(4)+'</td>'
        +'<td class="mono strong pos">'+p.avg.toFixed(4)+'</td>'
        +'<td>'+(ret!=null?(ret>=0?'+':'')+ret.toFixed(2)+'%':'â€”')+'</td>'
        +'</tr>';
    }).join('');
    return;
  } else {
    const sortedIC = [...data].sort((a,b)=>getIC(b)-getIC(a));
    mkChart('c-sec-ic',{
      type:'bar',
      data:{
        labels:sortedIC.map(getName),
        datasets:[
          {label:'2021 IC', data:sortedIC.map(r=>+(r.ic2021||0)), backgroundColor:'#1f2937'},
          {label:'2022 IC', data:sortedIC.map(r=>+(r.ic2022||0)), backgroundColor:'#4b5563'},
          {label:'2023 IC', data:sortedIC.map(r=>+(r.ic2023||0)), backgroundColor:'#9ca3af'},
        ]
      },
      options:{
        ...baseBarOpts(), indexAxis:'y',
        plugins:{legend:{display:true, position:'bottom', labels:{color:'#374151', font:{size:11}}}},
        scales:{
          x:{grid:{color:'#f3f4f6'}, ticks:{color:'#6b7280'}},
          y:{grid:{color:'#f3f4f6'}, ticks:{color:'#6b7280', font:{size:10}}}
        }
      }
    });
  }

  document.getElementById('sec-tbl-title').textContent = `${market==='domestic'?'êµ­ë‚´':'í•´ì™¸'} ì„¹í„° ë² íƒ€ ìƒì„¸`;
  // Show/hide 2024 IC column
  const th4 = document.getElementById('th-ic4');
  if(th4) th4.style.display = isFgn ? 'none' : '';
  const tbody = document.getElementById('tbody-sector');
  tbody.innerHTML = sorted.map(r=>{
    const b21=isFgn?r.b2021:r['2021 Î²'],b22=isFgn?r.b2022:r['2022 Î²'];
    const b23=isFgn?r.b2023:r['2023 Î²'];
    const ic21=isFgn?r.ic2021:r['2021 IC'],ic22=isFgn?r.ic2022:r['2022 IC'];
    const ic23=isFgn?r.ic2023:r['2023 IC'];
    const ic24 = isFgn ? '' : r['2024 IC'];
    const avgIC = isFgn ? getIC(r) : r['í‰ê·  IC'];
    return `<tr>
      <td><b>${getName(r)}</b></td>
      <td>${isFgn?r.n:r['ì¢…ëª©ìˆ˜']}</td>
      <td class="mono">${fmt(b21,4)}</td><td class="mono">${fmt(b22,4)}</td><td class="mono">${fmt(b23,4)}</td>
      <td class="mono strong">${fmt(getB(r),4)}</td>
      <td class="mono ${ic21>0?'pos':'neg'}">${fmt(ic21,4)}</td>
      <td class="mono ${ic22>0?'pos':'neg'}">${fmt(ic22,4)}</td>
      <td class="mono ${ic23>0?'pos':'neg'}">${fmt(ic23,4)}</td>
      <td class="mono ${(+ic24||0)>0?'pos':(+ic24||0)<0?'neg':''}">${isFgn?'â€”':fmt(+ic24,4)}</td>
      <td class="mono strong">${fmt(avgIC,4)}</td>
      <td>${pct(getTopK(r))}</td>
    </tr>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DATA VIEWER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function renderDataViewer() { const _ds=document.getElementById("data-ds").value; const _yr=document.getElementById("data-year").value; if(_ds==="domestic"&&_yr!=="all") await loadDomesticYear(+_yr); else if(_ds==="domestic") {for(const y of [2021,2022,2023,2024]) await loadDomesticYear(y);} else if(_ds==="foreign") await loadData("foreign","data/foreign.json"); else if(_ds==="zscore") await loadData("zscore","data/zscore.json"); else if(_ds==="fsec") await loadData("fsec","data/fsec.json"); else if(_ds==="dsec") await loadData("dsec","data/dsec.json");
  const ds     = document.getElementById('data-ds').value;
  const yr     = document.getElementById('data-year').value;
  const search = document.getElementById('data-search').value.toLowerCase();
  const maxR   = +document.getElementById('data-rows').value;

  let raw;
  if(ds==='domestic') raw = DATA.domestic;
  else if(ds==='foreign') raw = DATA.foreign;
  else if(ds==='zscore') raw = DATA.zscore;
  else if(ds==='dsec') raw = DATA.dsec;
  else raw = DATA.fsec;

  let rows = raw;
  if(yr!=='all') rows = rows.filter(r=>+r.year===+yr || r['year']===+yr);
  if(search) rows = rows.filter(r=>JSON.stringify(r).toLowerCase().includes(search));
  const total = rows.length;
  rows = rows.slice(0,maxR);

  if(!rows.length) {
    document.getElementById('thead-data').innerHTML='';
    document.getElementById('tbody-data').innerHTML='<tr><td colspan="20" style="text-align:center;color:#9ca3af;padding:32px">ë°ì´í„° ì—†ìŒ</td></tr>';
    document.getElementById('data-count').textContent='';
    return;
  }

  const cols = Object.keys(rows[0]);
  document.getElementById('thead-data').innerHTML=`<tr>${cols.map(c=>`<th>${c}</th>`).join('')}</tr>`;
  document.getElementById('tbody-data').innerHTML = rows.map(r=>`<tr>${cols.map(c=>{
    const v = r[c];
    const n = +v;
    if(typeof v==='number'||(!isNaN(n)&&v!==''&&v!=null)){
      const cls = n>0?'pos':n<0?'neg':'';
      return `<td class="mono ${cls}">${isNaN(n)?v:n.toFixed(Math.abs(n)<1&&n!==0?4:2)}</td>`;
    }
    return `<td>${v??'â€”'}</td>`;
  }).join('')}</tr>`).join('');
  document.getElementById('data-count').textContent=`ì´ ${total}í–‰ ì¤‘ ${rows.length}í–‰ í‘œì‹œ`;
  document.getElementById('data-tbl-title').textContent=`${ds} ë°ì´í„° (${total}ê±´)`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CHART DEFAULTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Chart.defaults.font.family = 'IBM Plex Sans KR';
Chart.defaults.color = '#374151';

function baseBarOpts() {
  return {
    responsive:true, maintainAspectRatio:false,
    plugins:{legend:{display:false},tooltip:{callbacks:{label:ctx=>`${ctx.parsed.y?.toFixed?ctx.parsed.y.toFixed(2):ctx.parsed.y}`}}},
    scales:{
      x:{grid:{color:'#f3f4f6'},ticks:{color:'#6b7280',font:{size:10}}},
      y:{grid:{color:'#f3f4f6'},ticks:{color:'#6b7280',font:{size:10}}}
    }
  };
}
function baseLineOpts() {
  return {
    responsive:true, maintainAspectRatio:false,
    plugins:{legend:{display:true,position:'bottom',labels:{color:'#374151',font:{size:11}}}},
    scales:{
      x:{grid:{color:'#f3f4f6'},ticks:{color:'#6b7280'}},
      y:{grid:{color:'#f3f4f6'},ticks:{color:'#6b7280'}}
    }
  };
}
function baseScatterOpts(xl,yl) {
  return {
    responsive:true, maintainAspectRatio:false,
    plugins:{legend:{display:false}},
    scales:{
      x:{title:{display:true,text:xl,color:'#6b7280'},grid:{color:'#f3f4f6'},ticks:{color:'#6b7280'}},
      y:{title:{display:true,text:yl,color:'#6b7280'},grid:{color:'#f3f4f6'},ticks:{color:'#6b7280'}}
    }
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(async () => {
  await Promise.all([
    loadDomesticYear(2024),
    loadDomesticYear(2023),
    loadData('foreign','data/foreign.json'),
    ensureSupport()
  ]);
  renderDash();
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ì‹¤ì‹œê°„ íŒ©í„° ê³„ì‚° ì—”ì§„ (2025ë…„+ NPS ë¯¸ê³µê°œ êµ¬ê°„)
//  êµ­ë‚´: momâœ… dartâœ… volâœ… | trend/value/weight = 2024 ê³ ì •
//  í•´ì™¸: sec_scoreâœ… | value/stake/trend/bulk = 2024 ê³ ì •
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// ì£¼ê°€ íˆìŠ¤í† ë¦¬ ì¡°íšŒ (Nì¼ì¹˜)
async function fetchPriceHistory(ticker, market, days=65) {
  const sym  = market==='domestic' ? ticker+'.KS' : ticker;
  const now  = new Date();
  const p1   = Math.floor(now.getTime()/1000) - 86400*(days+5);
  const p2   = Math.floor(now.getTime()/1000);
  try {
    const url   = `https://query1.finance.yahoo.com/v8/finance/chart/${sym}?period1=${p1}&period2=${p2}&interval=1d`;
    const res   = await fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
      {signal:AbortSignal.timeout(8000)});
    if(!res.ok) return null;
    const d     = await res.json();
    const closes= d?.chart?.result?.[0]?.indicators?.quote?.[0]?.close||[];
    return closes.filter(v=>v!=null);
  } catch(e) { return null; }
}

// êµ­ë‚´ mom_score: ìµœê·¼ 3ê°œì›”(ì•½ 63ê±°ë˜ì¼) ìˆ˜ìµë¥  â†’ ì „ì²´ ì¢…ëª© ëŒ€ë¹„ ìˆœìœ„ ì •ê·œí™”
async function calcMomScore(ticker, allPrices) {
  // allPrices: {ticker: [closes...]} ìºì‹œ
  if(!allPrices[ticker]) {
    allPrices[ticker] = await fetchPriceHistory(ticker, 'domestic', 70);
  }
  const prices = allPrices[ticker];
  if(!prices || prices.length < 10) return null;
  const cur   = prices[prices.length-1];
  const base  = prices[Math.max(0, prices.length-63)];
  return base>0 ? ((cur-base)/base*100) : null;
}

// ë³€ë™ì„± score: ìµœê·¼ 60ì¼ ì¼ë³„ìˆ˜ìµë¥  í‘œì¤€í¸ì°¨
async function calcVolScore(ticker, allPrices) {
  if(!allPrices[ticker]) {
    allPrices[ticker] = await fetchPriceHistory(ticker, 'domestic', 70);
  }
  const prices = allPrices[ticker];
  if(!prices || prices.length < 10) return null;
  const rets = prices.slice(-60).map((p,i,a)=>i===0?0:(p-a[i-1])/a[i-1]).slice(1);
  const mean = rets.reduce((s,v)=>s+v,0)/rets.length;
  const std  = Math.sqrt(rets.reduce((s,v)=>s+(v-mean)**2,0)/rets.length);
  return std * Math.sqrt(252) * 100; // annualized vol %
}

// DART ê³µì‹œ ì ìˆ˜ (ìµœê·¼ 3ê°œì›” ê³µì‹œ ê±´ìˆ˜ ê¸°ë°˜)
async function calcDartScore(ticker) {
  try {
    const url   = `https://opendart.fss.or.kr/api/list.json?crtfc_key=sample&corp_code=${ticker}&bgn_de=${getDateStr(-90)}&end_de=${getDateStr(0)}&page_count=10`;
    const proxy = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
    const res   = await fetch(proxy, {signal:AbortSignal.timeout(5000)});
    if(res.ok) {
      const d = await res.json();
      const cnt = d?.total_count || 0;
      return Math.min(1, cnt/20); // 20ê±´ ì´ìƒ = 1ì 
    }
  } catch(e) {}
  return 0.3; // fallback ì¤‘ë¦½
}

function getDateStr(offsetDays) {
  const d = new Date();
  d.setDate(d.getDate()+offsetDays);
  return d.toISOString().slice(0,10).replace(/-/g,'');
}

// ìˆœìœ„ ì •ê·œí™” (0~1)
function rankNorm(values) {
  const sorted = [...values].sort((a,b)=>a-b);
  return values.map(v=>{
    if(v===null||v===undefined) return 0.5;
    const rank = sorted.filter(s=>s<=v).length;
    return rank / sorted.length;
  });
}

// â”€â”€ KoBERT ì—”ì§„ (snunlp/KR-FinBert-SC via Transformers.js) â”€â”€
let _kbPipeline = null;
let _kbLoading  = false;

async function loadKoBERT() {
  if(_kbPipeline) return _kbPipeline;
  if(_kbLoading) { while(_kbLoading) await new Promise(r=>setTimeout(r,300)); return _kbPipeline; }
  _kbLoading = true;
  try {
    const {pipeline} = await import('https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2/dist/transformers.min.js');
    _kbPipeline = await pipeline('text-classification','snunlp/KR-FinBert-SC',{quantized:true});
  } catch(e) { _kbPipeline = 'keyword'; }
  _kbLoading = false;
  return _kbPipeline;
}

function kwSentiment(text) {
  const pos=['ìƒìŠ¹','ê¸‰ë“±','í˜¸ì‹¤ì ','í‘ì','ì‹ ê³ ê°€','ìˆ˜ì£¼','ê³„ì•½','ì„±ì¥','í˜¸ì¬','ê°•ì„¸','ì¦ê°€','í™•ëŒ€'];
  const neg=['í•˜ë½','ê¸‰ë½','ì ì','ì†ì‹¤','ë¶€ì§„','ê°ì†Œ','ìš°ë ¤','ë¦¬ìŠ¤í¬','ì•½ì„¸','ì•…ì¬','í•˜íšŒ','ì¶•ì†Œ'];
  let s=0; const t=text.toLowerCase();
  pos.forEach(k=>{if(t.includes(k))s+=1;}); neg.forEach(k=>{if(t.includes(k))s-=1;});
  return Math.max(-1,Math.min(1,s/5));
}

async function fetchNews(ticker, name, n=45) {
  const arts=[];
  // Naver ê¸ˆìœµ ëª¨ë°”ì¼ API
  try {
    const url=`https://m.stock.naver.com/api/news/stock/${ticker}?pageSize=20&page=1`;
    const res=await fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,{signal:AbortSignal.timeout(6000)});
    if(res.ok){const d=await res.json();(d?.result?.articleList||[]).forEach(a=>arts.push((a.title||'')+' '+(a.summary||'')));}
  } catch(e){}
  // Google News RSS fallback
  if(arts.length<10){
    try{
      const g=`https://news.google.com/rss/search?q=${encodeURIComponent(name+' ì£¼ê°€')}&hl=ko&gl=KR&ceid=KR:ko`;
      const res2=await fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(g)}`,{signal:AbortSignal.timeout(6000)});
      if(res2.ok){const xml=await res2.text();[...xml.matchAll(/<title>([^<]+)<\/title>/g)].slice(1,16).forEach(m=>arts.push(m[1]));}
    }catch(e){}
  }
  return [...new Set(arts)].filter(a=>a.length>5).slice(0,n);
}

async function calcZscore(ticker, name, pipe) {
  const arts = await fetchNews(ticker, name, 45);
  if(!arts.length) return 0.5;
  const scores=[];
  for(const art of arts.slice(0,45)){
    try{
      if(pipe==='keyword'){ scores.push(kwSentiment(art)); continue; }
      const res=await pipe(art.slice(0,512));
      const lb=res[0]?.label||'LABEL_1', sc=res[0]?.score||0.5;
      scores.push(lb==='LABEL_2'?sc:lb==='LABEL_0'?-sc:0);
    }catch(e){scores.push(0);}
  }
  const mean=scores.reduce((s,v)=>s+v,0)/scores.length;
  const std=Math.sqrt(scores.reduce((s,v)=>s+(v-mean)**2,0)/scores.length)||0.01;
  const z=mean/std;
  return Math.max(0,Math.min(1,(z+3)/6));
}

// êµ­ë‚´ Y_opt ì‹¤ì‹œê°„ ì¬ê³„ì‚°
// trend/value/weight = 2024 ë°ì´í„° ê³ ì •, mom/dart/vol = ì‹¤ì‹œê°„
async function recalcDomesticYopt(rows, onProgress) {
  // 2024 ê¸°ì¤€ ì ìˆ˜ë“¤ (rowsì— ì´ë¯¸ ìˆìŒ)
  // ì‹¤ì‹œê°„ìœ¼ë¡œ ê°±ì‹ í•  íŒ©í„°ë§Œ ì¬ê³„ì‚°
  const priceCache = {};
  const momRaws=[], volRaws=[];

  // 1) ì „ì²´ ì¢…ëª© mom/vol ì›ê°’ ìˆ˜ì§‘
  for(let i=0;i<rows.length;i++){
    const r=rows[i];
    onProgress && onProgress(i, rows.length, r.name, 'mom/vol ì¡°íšŒ');
    const [m,v] = await Promise.all([
      calcMomScore(r.ticker||'', priceCache),
      calcVolScore(r.ticker||'', priceCache)
    ]);
    momRaws.push(m ?? 0);
    volRaws.push(v ?? 30);
  }

  // 2) ìˆœìœ„ ì •ê·œí™”
  const momNorm = rankNorm(momRaws);
  const volNorm = rankNorm(volRaws);

  // 3) DART + Y_opt ì¬ê³„ì‚°
  const result=[];
  for(let i=0;i<rows.length;i++){
    const r=rows[i];
    onProgress && onProgress(i, rows.length, r.name, 'DART/Y_opt');
    const dartSc = r.dart_score !== undefined ? +(r.dart_score||0) : 0.3;
    // Y_opt = 0.688Ã—mom + 0.240Ã—trend(ê³ ì •) + 0.030Ã—value(ê³ ì •) + 0.029Ã—dart + 0.007Ã—vol + 0.006Ã—weight(ê³ ì •)
    const yNew = 0.688*momNorm[i]
               + 0.240*(+(r.trend_score||0))
               + 0.030*(+(r.value_score||0))
               + 0.029*dartSc
               + 0.007*volNorm[i]
               + 0.006*(+(r.weight_score||0));
    result.push({...r, Y_opt_rt: yNew, mom_rt: momNorm[i], vol_rt: volNorm[i]});
  }
  return result;
}

// í•´ì™¸ Y_opt_D ì‹¤ì‹œê°„ ì¬ê³„ì‚°
// sec_score = ì‹¤ì‹œê°„ ì„¹í„° ë² íƒ€ í™œìš©, value/stake/trend/bulk = 2024 ê³ ì •
async function recalcForeignYoptD(rows, onProgress) {
  // Y_opt_D = -0.852Ã—value -0.420Ã—stake -0.235Ã—trend -0.171Ã—sec -0.445Ã—bulk
  // sec_score: ì„¹í„°ë³„ ìµœì‹  beta í™œìš© (fsec ë°ì´í„°)
  const result=[];
  for(let i=0;i<rows.length;i++){
    const r=rows[i];
    onProgress && onProgress(i, rows.length, r.ticker||r.name, 'sec_score');
    // sec_score: fsecì—ì„œ í•´ë‹¹ ì„¹í„° avg Î²ë¥¼ sec_score ëŒ€ìš©ìœ¼ë¡œ í™œìš©
    const secRow = DATA.fsec.find(s=>s.sector===getSector(r.ticker||''));
    const secScRt = secRow ? secRow.bavg : (+(r.sec_score||0));
    const w   = [-0.8524,-0.4204,-0.2346,-0.1714,-0.4450];
    const fts = ['value_score','stake_score','trend_score'];
    const raw = fts.reduce((s,f,i2)=>s+w[i2]*(+(r[f]??0)||0),0)
              + w[3]*secScRt
              + w[4]*(+(r.bulk??0)||0);
    result.push({...r, Y_opt_rt_raw: raw});
  }
  // ì •ê·œí™”
  const raws=result.map(r=>r.Y_opt_rt_raw);
  const mn=Math.min(...raws), mx=Math.max(...raws);
  result.forEach(r=>{ r.Y_opt_score_rt = mx>mn ? (r.Y_opt_rt_raw-mn)/(mx-mn)*100 : 50; });
  return result;
}

// ì§„í–‰ìƒí™© UI
function setForecastStatus(show, text='', pct=0, detail='') {
  let bar = document.getElementById('forecast-status-bar');
  if(!bar) {
    bar = document.createElement('div');
    bar.id = 'forecast-status-bar';
    bar.style.cssText='background:#fffbeb;border:1px solid #fde68a;border-radius:8px;padding:12px 16px;margin-top:12px;font-size:13px;color:#92400e;';
    const loading = document.getElementById('price-loading');
    loading && loading.parentNode.insertBefore(bar, loading);
  }
  bar.style.display = show ? 'block' : 'none';
  if(show) bar.innerHTML =
    '<div style="font-weight:600;margin-bottom:6px">ğŸ”„ '+text+'</div>'
   +'<div style="background:#fef3c7;border-radius:4px;height:8px;overflow:hidden;margin-bottom:4px">'
   +  '<div style="height:100%;background:#f59e0b;width:'+pct+'%;transition:width 0.3s"></div>'
   +'</div>'
   +'<div style="font-size:11px;color:#b45309">'+detail+'</div>';
}

// 2025+ ë©”ì¸ ì‹¤í–‰
async function runKobertForecast(allRows, market, amt, dateStr, topn, wmode, secData) {
  const yr = new Date(dateStr).getFullYear();

  setForecastStatus(true, `${yr}ë…„ ì‹¤ì‹œê°„ íŒ©í„° ê³„ì‚° ì‹œì‘`, 5,
    `ì´ ${allRows.length}ê°œ í›„ë³´ ì¢…ëª© ì²˜ë¦¬ ì¤‘`);

  // Step 1: ì‹¤ì‹œê°„ íŒ©í„° ì¬ê³„ì‚°
  let enriched;
  if(market==='domestic') {
    enriched = await recalcDomesticYopt(allRows, (i,tot,name,step)=>{
      setForecastStatus(true, `íŒ©í„° ì¬ê³„ì‚°: ${name}`, Math.round(i/tot*40),
        `[${i+1}/${tot}] ${step}`);
    });
  } else {
    enriched = await recalcForeignYoptD(allRows, (i,tot,name,step)=>{
      setForecastStatus(true, `íŒ©í„° ì¬ê³„ì‚°: ${name}`, Math.round(i/tot*40), `[${i+1}/${tot}]`);
    });
  }

  // Step 2: KoBERT Z-score
  setForecastStatus(true, 'KoBERT ëª¨ë¸ ë¡œë”©...', 42, 'snunlp/KR-FinBert-SC ë¡œë“œ ì¤‘');
  const pipe = await loadKoBERT();
  setForecastStatus(true, 'KoBERT Z-score ê³„ì‚° ì¤‘', 45,
    `ì¢…ëª©ë‹¹ ë‰´ìŠ¤ 45ê±´+ ê°ì„±ë¶„ì„`);

  for(let i=0;i<enriched.length;i++){
    const r=enriched[i];
    const pct2=45+Math.round(i/enriched.length*40);
    setForecastStatus(true, `[${i+1}/${enriched.length}] ${r.name||r.ticker} ê°ì„±ë¶„ì„`, pct2,
      'ë‰´ìŠ¤ ìˆ˜ì§‘ â†’ KoBERT ì¶”ë¡ ');
    const z = await calcZscore(r.ticker||'', r.name||r.ticker||'', pipe);
    enriched[i] = {...r, Z_score_rt: z};
  }

  // Step 3: Final Score ì¬ê³„ì‚° & ì •ë ¬
  setForecastStatus(true, 'Final Score ê³„ì‚° & ì •ë ¬...', 88, '');
  if(market==='domestic') {
    // ì •ê·œí™”
    const yOpts = enriched.map(r=>r.Y_opt_rt||0);
    const mn=Math.min(...yOpts), mx=Math.max(...yOpts);
    enriched.forEach(r=>{
      const yN = mx>mn ? (r.Y_opt_rt-mn)/(mx-mn) : 0.5;
      r.Final_Score_rt = 0.852*yN + 0.148*(r.Z_score_rt||0.5);
    });
    enriched.sort((a,b)=>b.Final_Score_rt-a.Final_Score_rt);
  } else {
    enriched.forEach(r=>{
      const yN = (r.Y_opt_score_rt||50)/100;
      r.final_score_rt = 0.915*yN + 0.085*(r.Z_score_rt||0.5);
    });
    enriched.sort((a,b)=>b.final_score_rt-a.final_score_rt);
  }

  const topRows = enriched.slice(0,topn);
  const scoreKey2 = market==='domestic' ? 'Final_Score_rt' : 'final_score_rt';
  const rawWts2   = computeWeights(
    topRows.map(r=>({...r, Final_Score:r.Final_Score_rt, final_score_new:r.final_score_rt})),
    wmode, market, secData
  );
  const results2 = topRows.map((r,i)=>({
    ...r,
    modelRet: (market==='domestic'?0.852:0.915)*(+(r[scoreKey2]||0)-0.3)*143,
    w: rawWts2[i]*100,
    invest: amt*rawWts2[i]
  }));
  const portRet2 = results2.reduce((s,r)=>s+r.modelRet*(r.w/100),0);
  const portPnL2 = results2.reduce((s,r)=>s+r.invest*r.modelRet/100,0);

  kpi('date-kpi',[
    {label:'ì˜ˆìƒ ìˆ˜ìµë¥  (KoBERT)', value:`${portRet2>=0?'+':''}${portRet2.toFixed(2)}%`, trend:portRet2>0?'up':'down'},
    {label:'ì˜ˆìƒ ì†ìµ', value:`${portPnL2>=0?'+':''}${portPnL2.toFixed(0)}ë§Œì›`, trend:portPnL2>0?'up':'down'},
    {label:'í‰ê°€ê¸ˆì•¡', value:`${(amt+portPnL2).toFixed(0)}ë§Œì›`},
    {label:'ë¶„ì„ ë°©ì‹', value:'ì‹¤ì‹œê°„ íŒ©í„° + KoBERT', sub:`${yr}ë…„ NPSë¯¸ê³µê°œ â†’ ë‰´ìŠ¤ê°ì„±`},
  ]);
  mkChart('c-date-bar',{type:'bar',data:{
    labels:results2.map(r=>r.name?.slice(0,6)||r.ticker||'â€”'),
    datasets:[{label:'ëª¨ë¸ ì˜ˆì¸¡(%)', data:results2.map(r=>r.modelRet),
      backgroundColor:results2.map(r=>r.modelRet>=0?'#1f2937':'#9ca3af')}]
  },options:baseBarOpts()});

  const tbody=document.getElementById('tbody-date');
  tbody.innerHTML=results2.map((r,i)=>{
    const sc=+(r[scoreKey2]||0);
    const pnl=r.invest*r.modelRet/100;
    return '<tr>'
      +'<td>'+(i+1)+'</td>'
      +'<td><b>'+(r.name||r.ticker)+'</b></td>'
      +'<td class="mono">'+(r.ticker||'â€”')+'</td>'
      +'<td>'+sc.toFixed(3)+'</td>'
      +'<td>'+r.w.toFixed(1)+'%</td>'
      +'<td>'+r.invest.toFixed(1)+'</td>'
      +'<td>'+(r.modelRet>=0?'+':'')+r.modelRet.toFixed(2)+'%</td>'
      +'<td id="price-est-'+i+'" class="mono">â€”</td>'
      +'<td id="price-real-'+i+'" class="mono">â€”</td>'
      +'<td id="hit-rate-'+i+'">â€”</td>'
      +'<td class="'+(pnl>=0?'pos':'neg')+'">'+(pnl>=0?'+':'')+pnl.toFixed(1)+'</td>'
      +'<td><span class="badge" style="background:#fef3c7;color:#92400e;border:1px solid #fde68a">KoBERT</span></td>'
      +'</tr>';
  }).join('');

  setForecastStatus(false);
  document.getElementById('price-loading').style.display='block';
  fetchStockPrices(results2, dateStr, market, false, new Date(dateStr)<new Date());
}
</script>
</body>
</html>
