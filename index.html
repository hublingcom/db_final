<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NPS Mirror Intelligence v3</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+KR:wght@300;400;500;600&family=IBM+Plex+Mono:wght@400;500&family=Sora:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<link rel="stylesheet" href="nps_style_v3.css">
</head>
<body>

<!-- ══ SIDEBAR ══ -->
<aside id="sidebar">
  <div class="sb-logo">
    <div class="sb-logo-mark">NPS</div>
    <div class="sb-logo-text">
      <div class="sb-brand">Mirror Intelligence</div>
      <div class="sb-version">v3.0 · 국민연금 분석</div>
    </div>
  </div>

  <nav class="sb-nav">
    <div class="sb-section-label">분석</div>
    <button class="sb-item active" data-page="p-dash">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
      대시보드
    </button>
    <button class="sb-item" data-page="p-domestic">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg>
      국내주식
    </button>
    <button class="sb-item" data-page="p-foreign">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
      미국주식
    </button>
    <div class="sb-section-label">도구</div>
    <button class="sb-item" data-page="p-date">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
      날짜 예측·검증
    </button>
    <button class="sb-item" data-page="p-sim">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
      투자 시뮬레이터
    </button>
    <div class="sb-section-label">모델</div>
    <button class="sb-item" data-page="p-model">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
      모델 성능
    </button>
    <button class="sb-item" data-page="p-sector">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg>
      섹터 베타
    </button>
    <button class="sb-item" data-page="p-data">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>
      전체 데이터
    </button>
  </nav>

  <div class="sb-footer">
    <div class="sb-live-dot"></div>
    <span id="sb-time">--:--:--</span>
    <span class="sb-model-tag">Y_opt_D · α=0.915</span>
  </div>
</aside>

<!-- ══ MAIN ══ -->
<div id="app-wrap">

<!-- ══════════ PAGE: DASHBOARD ══════════ -->
<section class="page active" id="p-dash">
  <div class="page-header">
    <div>
      <h1 class="page-title">대시보드</h1>
      <p class="page-sub">NPS 포트폴리오 미러링 · 국민연금 공시 데이터 기반 장기+단기 신호 결합</p>
    </div>
    <div class="info-pill">Final = 0.915 × Y_opt_D + 0.085 × Z</div>
  </div>

  <div class="kpi-grid" id="dash-kpi"></div>

  <div class="card-grid g2 mt16">
    <div class="card">
      <div class="card-hd">연도별 포트폴리오 수익률 vs 벤치마크</div>
      <div class="chart-box h280"><canvas id="c-dash-perf"></canvas></div>
    </div>
    <div class="card">
      <div class="card-hd">국내 Top-10 수익률 (2023년)</div>
      <div class="chart-box h280"><canvas id="c-dash-top10d"></canvas></div>
    </div>
  </div>

  <div class="card-grid g2 mt16">
    <div class="card">
      <div class="card-hd">모델 공식 요약</div>
      <div class="formula-box">
        <div class="formula-row">
          <span class="formula-label">국내 Y_opt</span>
          <code>0.688×mom + 0.240×trend + 0.030×value + 0.029×dart + 0.007×vol + 0.006×wgt</code>
        </div>
        <div class="formula-row">
          <span class="formula-label">해외 Y_opt_D</span>
          <code>-0.852×value - 0.420×stake - 0.235×trend - 0.171×sec - 0.445×bulk</code>
        </div>
        <div class="formula-row highlight">
          <span class="formula-label">국내 Final</span>
          <code>0.852 × Y_opt + 0.148 × Z_score_norm</code>
        </div>
        <div class="formula-row highlight">
          <span class="formula-label">해외 Final</span>
          <code>0.915 × Y_opt_D + 0.085 × Z_score_norm</code>
        </div>
        <div class="formula-row">
          <span class="formula-label">섹터 베타</span>
          <code>국내: β = 0.6151×IC + 0.3486 · 해외: β = 0.2317×IC + 0.4024 · (IC&lt;0 → β=0.20)</code>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-hd">해외 Top-10 수익률 (2023년)</div>
      <div class="chart-box h280"><canvas id="c-dash-top10f"></canvas></div>
    </div>
  </div>
</section>

<!-- ══════════ PAGE: DOMESTIC ══════════ -->
<section class="page" id="p-domestic">
  <div class="page-header">
    <div>
      <h1 class="page-title">국내주식 분석</h1>
      <p class="page-sub">국내 상위 종목 스코어 · 수익률 · NPS 보유 비중</p>
    </div>
  </div>

  <div class="ctrl-bar">
    <div class="ctrl-group">
      <label>기준 연도</label>
      <select id="dom-year" onchange="renderDomestic()">
        <option value="2021">2021</option>
        <option value="2022">2022</option>
        <option value="2023">2023</option>
        <option value="2024" selected>2024</option>
      </select>
    </div>
    <div class="ctrl-group">
      <label>상위 N종목: <b id="dom-n-val">20</b></label>
      <input type="range" id="dom-n" min="5" max="50" value="20" oninput="document.getElementById('dom-n-val').textContent=this.value;renderDomestic()">
    </div>
    <div class="ctrl-group">
      <label>정렬</label>
      <select id="dom-sort" onchange="renderDomestic()">
        <option value="Final_Score">최종 스코어</option>
        <option value="Y_opt">Y_opt</option>
        <option value="Z_score_norm">Z-스코어</option>
        <option value="연간수익률(r_t)">연간 수익률</option>
        <option value="weight">NPS 비중</option>
      </select>
    </div>
    <div class="ctrl-group">
      <label>섹터</label>
      <select id="dom-sector" onchange="renderDomestic()">
        <option value="all">전체</option>
      </select>
    </div>
  </div>

  <div class="kpi-grid" id="dom-kpi"></div>

  <div class="card-grid g2 mt16">
    <div class="card">
      <div class="card-hd">Y_opt vs Z-score 산점도</div>
      <div class="chart-box h280"><canvas id="c-dom-scatter"></canvas></div>
    </div>
    <div class="card">
      <div class="card-hd">Top N 수익률 분포</div>
      <div class="chart-box h280"><canvas id="c-dom-ret"></canvas></div>
    </div>
  </div>

  <div class="card mt16">
    <div class="card-hd" id="dom-tbl-title">2024년 Top 20 국내주식</div>
    <div class="tbl-wrap">
      <table id="t-domestic">
        <thead><tr>
          <th>#</th><th>종목명</th><th>코드</th>
          <th>Final Score</th><th>Y_opt</th><th>Z-score</th>
          <th>NPS 비중%</th><th>연간수익률</th><th>3M 모멘텀</th><th>변동성</th><th>DART</th>
        </tr></thead>
        <tbody id="tbody-domestic"></tbody>
      </table>
    </div>
  </div>
</section>

<!-- ══════════ PAGE: FOREIGN ══════════ -->
<section class="page" id="p-foreign">
  <div class="page-header">
    <div>
      <h1 class="page-title">미국주식 분석</h1>
      <p class="page-sub">Y_opt_D 공식 · 섹터 베타 가중 모델 (Final = 0.915×Y + 0.085×Z)</p>
    </div>
    <div class="info-pill">IC 안정성 std=0.057 · LOYO CV 검증</div>
  </div>

  <div class="ctrl-bar">
    <div class="ctrl-group">
      <label>기준 연도</label>
      <select id="fgn-year" onchange="renderForeign()">
        <option value="2021">2021</option>
        <option value="2022">2022</option>
        <option value="2023" selected>2023</option>
      </select>
    </div>
    <div class="ctrl-group">
      <label>상위 N종목: <b id="fgn-n-val">15</b></label>
      <input type="range" id="fgn-n" min="3" max="30" value="15" oninput="document.getElementById('fgn-n-val').textContent=this.value;renderForeign()">
    </div>
    <div class="ctrl-group">
      <label>정렬</label>
      <select id="fgn-sort" onchange="renderForeign()">
        <option value="final_score_new">Final Score(신)</option>
        <option value="final_score">Final Score(구)</option>
        <option value="Y_opt_score">Y_opt_D</option>
        <option value="Z_score_norm">Z-score</option>
        <option value="actual_return">실제 수익률</option>
      </select>
    </div>
  </div>

  <div class="kpi-grid" id="fgn-kpi"></div>

  <div class="card-grid g2 mt16">
    <div class="card">
      <div class="card-hd">섹터별 평균 Final Score</div>
      <div class="chart-box h280"><canvas id="c-fgn-sector"></canvas></div>
    </div>
    <div class="card">
      <div class="card-hd">Y_opt_D vs 실제 수익률 (IC 검증)</div>
      <div class="chart-box h280"><canvas id="c-fgn-scatter"></canvas></div>
    </div>
  </div>

  <div class="card mt16">
    <div class="card-hd" id="fgn-tbl-title">2023년 Top 15 해외주식</div>
    <div class="tbl-wrap">
      <table id="t-foreign">
        <thead><tr>
          <th>#</th><th>종목명</th><th>티커</th>
          <th>Final(신)</th><th>Y_opt_D</th><th>Z-score</th>
          <th>NPS 비중%</th><th>stake</th><th>trend</th><th>sec_score</th><th>실제 수익률</th>
        </tr></thead>
        <tbody id="tbody-foreign"></tbody>
      </table>
    </div>
  </div>

  <div class="card mt16">
    <div class="card-hd">연도별 IC 추이 (모델 검증)</div>
    <div class="chart-box h240"><canvas id="c-fgn-ic"></canvas></div>
  </div>
</section>

<!-- ══════════ PAGE: DATE PREDICTION ══════════ -->
<section class="page" id="p-date">
  <div class="page-header">
    <div>
      <h1 class="page-title">날짜 예측 · 검증</h1>
      <p class="page-sub">날짜 입력 → 데이터 내 날짜면 실제 비교 · 미래 날짜면 예측 생성 · 장 운영시간(9:00~15:30)엔 실시간 연동</p>
    </div>
  </div>

  <div class="alert-box">
    ⚠️ 실시간 주가는 Yahoo Finance API 연동 (장 운영시간 자동 활성화). 투자 의사결정에 직접 사용 금지.
  </div>

  <div class="card mt16">
    <div class="card-hd">📅 날짜 & 포트폴리오 설정</div>
    <div class="ctrl-bar" style="flex-wrap:wrap;gap:12px;padding:0">
      <div class="ctrl-group">
        <label>투자 기준일</label>
        <input type="date" id="date-from" value="2023-01-01">
      </div>
      <div class="ctrl-group">
        <label>시장</label>
        <select id="date-market">
          <option value="domestic">국내 (KOSPI)</option>
          <option value="foreign">미국 (NYSE/NASDAQ)</option>
        </select>
      </div>
      <div class="ctrl-group">
        <label>Top N종목</label>
        <input type="number" id="date-topn" value="10" min="1" max="50" style="width:80px">
      </div>
      <div class="ctrl-group">
        <label>투자 금액 (만원)</label>
        <input type="number" id="date-amt" value="1000" min="10" step="100" style="width:120px">
      </div>
      <div class="ctrl-group">
        <label>배분 방식</label>
        <select id="date-wmode">
          <option value="final">최종값 (α+β 모두 적용)</option>
          <option value="alpha_only">알파만 적용 (Y:Z 혼합)</option>
          <option value="beta_only">베타만 적용 (섹터 가중)</option>
          <option value="alpha_beta">알파+베타 적용</option>
          <option value="equal">균등 배분</option>
        </select>
      </div>
      <button class="btn-primary" onclick="runDateForecast()">🔮 예측 실행</button>
    </div>
  </div>

  <div class="kpi-grid mt16" id="date-kpi"></div>

  <div class="card-grid g2 mt16">
    <div class="card">
      <div class="card-hd">예측 수익률 분포</div>
      <div class="chart-box h260"><canvas id="c-date-bar"></canvas></div>
    </div>
    <div class="card">
      <div class="card-hd">포트폴리오 배분</div>
      <div class="chart-box h260"><canvas id="c-date-pie"></canvas></div>
    </div>
  </div>

  <div class="card mt16">
    <div class="card-hd">
      포트폴리오 상세
      <span class="badge" id="date-mode-badge">대기</span>
    </div>
    <div class="tbl-wrap">
      <table id="t-date">
        <thead><tr>
          <th>#</th><th>종목명</th><th>티커</th>
          <th>스코어</th><th>배분 비중</th><th>투자금(만원)</th>
          <th>예측 수익률</th><th>예상 주가</th><th>실제 주가</th><th>적중률</th><th>예상 손익(만원)</th><th>상태</th>
        </tr></thead>
        <tbody id="tbody-date"></tbody>
      </table>
      <div id="price-loading" style="display:none;padding:16px;text-align:center;color:#6b7280;font-size:13px">
        <span style="display:inline-block;width:18px;height:18px;border:2px solid #d1d5db;border-top-color:#374151;border-radius:50%;animation:spin .8s linear infinite;vertical-align:middle;margin-right:8px"></span>
        실시간 주가 조회 중...
      </div>
      <style>@keyframes spin{to{transform:rotate(360deg)}}</style>
    </div>
  </div>
</section>

<!-- ══════════ PAGE: SIMULATOR ══════════ -->
<section class="page" id="p-sim">
  <div class="page-header">
    <div>
      <h1 class="page-title">투자 시뮬레이터</h1>
      <p class="page-sub">실제 수익률 기반 백테스트 · 투자 금액 직접 입력</p>
    </div>
  </div>

  <div class="ctrl-bar">
    <div class="ctrl-group">
      <label>투자 연도</label>
      <select id="sim-year" onchange="renderSim()">
        <option value="2021">2021년 국내</option>
        <option value="2022">2022년 국내</option>
        <option value="2023" selected>2023년 국내</option>
        <option value="fgn2021">2021년 해외</option>
        <option value="fgn2022">2022년 해외</option>
        <option value="fgn2023">2023년 해외</option>
      </select>
    </div>
    <div class="ctrl-group">
      <label>투자 금액 (만원)</label>
      <input type="number" id="sim-amt" value="1000" min="100" max="1000000" step="100" oninput="renderSim()">
    </div>
    <div class="ctrl-group">
      <label>Top N: <b id="sim-n-val">10</b></label>
      <input type="range" id="sim-n" min="1" max="30" value="10" oninput="document.getElementById('sim-n-val').textContent=this.value;renderSim()">
    </div>
    <div class="ctrl-group">
      <label>배분 방식</label>
      <select id="sim-weight" onchange="renderSim()">
        <option value="final">최종값 (α+β)</option>
        <option value="alpha_only">알파만 (Y:Z)</option>
        <option value="beta_only">베타만 (섹터)</option>
        <option value="alpha_beta">알파+베타</option>
        <option value="equal">균등 배분</option>
        <option value="score">스코어 비례</option>
        <option value="nps">NPS 비중 비례</option>
      </select>
    </div>
  </div>

  <div class="kpi-grid" id="sim-kpi"></div>

  <div class="card-grid g2 mt16">
    <div class="card">
      <div class="card-hd">포트폴리오 구성 (배분 비중)</div>
      <div class="chart-box h280"><canvas id="c-sim-pie"></canvas></div>
    </div>
    <div class="card">
      <div class="card-hd">종목별 수익률</div>
      <div class="chart-box h280"><canvas id="c-sim-bar"></canvas></div>
    </div>
  </div>

  <div class="card mt16">
    <div class="card-hd" id="sim-tbl-title">포트폴리오 결과</div>
    <div class="tbl-wrap">
      <table>
        <thead><tr>
          <th>#</th><th>종목명</th><th>스코어</th>
          <th>배분 비중%</th><th>투자금(만원)</th><th>수익률</th><th>손익(만원)</th><th>평가금(만원)</th>
        </tr></thead>
        <tbody id="tbody-sim"></tbody>
      </table>
    </div>
  </div>
</section>

<!-- ══════════ PAGE: MODEL PERFORMANCE ══════════ -->
<section class="page" id="p-model">
  <div class="page-header">
    <div>
      <h1 class="page-title">모델 성능 분석</h1>
      <p class="page-sub">LOYO Cross-Validation · IC 분석 · 국내/해외 모델 비교</p>
    </div>
  </div>

  <div class="kpi-grid" id="model-kpi"></div>

  <div class="card-grid g2 mt16">
    <div class="card">
      <div class="card-hd">연도별 IC (Spearman) — 국내</div>
      <div class="chart-box h280"><canvas id="c-model-ic-dom"></canvas></div>
    </div>
    <div class="card">
      <div class="card-hd">연도별 IC (Spearman) — 해외</div>
      <div class="chart-box h280"><canvas id="c-model-ic-fgn"></canvas></div>
    </div>
  </div>

  <div class="card-grid g2 mt16">
    <div class="card">
      <div class="card-hd">Top-N별 평균 수익률 (국내 LOYO)</div>
      <div class="chart-box h260"><canvas id="c-model-topn"></canvas></div>
    </div>
    <div class="card">
      <div class="card-hd">알파 민감도 분석 (해외 Y:Z 비율)</div>
      <div class="chart-box h260"><canvas id="c-model-alpha"></canvas></div>
    </div>
  </div>

  <div class="card mt16">
    <div class="card-hd">모델 버전별 성능 비교</div>
    <div class="tbl-wrap">
      <table id="t-model-compare">
        <thead><tr>
          <th>모델</th><th>대상</th><th>2021 IC</th><th>2022 IC</th><th>2023 IC</th><th>평균 IC</th>
          <th>2021 Top30</th><th>2022 Top30</th><th>2023 Top30</th><th>평균 Top30</th>
        </tr></thead>
        <tbody id="tbody-model"></tbody>
      </table>
    </div>
  </div>
</section>

<!-- ══════════ PAGE: SECTOR BETA ══════════ -->
<section class="page" id="p-sector">
  <div class="page-header">
    <div>
      <h1 class="page-title">섹터 베타 분석</h1>
      <p class="page-sub">국내: β = 0.6151 × IC + 0.3486 · 해외: β = 0.2317 × IC + 0.4024 · (IC &lt; 0 → β = 0.20)</p>
    </div>
  </div>

  <div class="ctrl-bar">
    <div class="ctrl-group">
      <label>시장</label>
      <select id="sec-market" onchange="renderSector()">
        <option value="domestic">국내</option>
        <option value="foreign">해외</option>
      </select>
    </div>
  </div>

  <div class="card-grid g2 mt16">
    <div class="card">
      <div class="card-hd">섹터별 평균 β</div>
      <div class="chart-box h320"><canvas id="c-sec-beta"></canvas></div>
    </div>
    <div class="card">
      <div class="card-hd">섹터별 평균 IC</div>
      <div class="chart-box h320"><canvas id="c-sec-ic"></canvas></div>
    </div>
  </div>

  <div class="card mt16">
    <div class="card-hd" id="sec-tbl-title">섹터 베타 상세</div>
    <div class="tbl-wrap">
      <table id="t-sector">
        <thead><tr>
          <th>섹터</th><th>종목수</th>
          <th>2021 β</th><th>2022 β</th><th>2023 β</th><th>평균 β</th>
          <th>2021 IC</th><th>2022 IC</th><th>2023 IC</th><th id="th-ic4">2024 IC</th><th>평균 IC</th>
          <th>수익률</th>
        </tr></thead>
        <tbody id="tbody-sector"></tbody>
      </table>
    </div>
  </div>
</section>

<!-- ══════════ PAGE: ALL DATA ══════════ -->
<section class="page" id="p-data">
  <div class="page-header">
    <div>
      <h1 class="page-title">전체 데이터 뷰어</h1>
      <p class="page-sub">모든 원본 데이터 · 검색 · 필터</p>
    </div>
  </div>

  <div class="ctrl-bar">
    <div class="ctrl-group">
      <label>데이터셋</label>
      <select id="data-ds" onchange="renderDataViewer()">
        <option value="domestic">국내주식 (y_score_real_final)</option>
        <option value="foreign">해외주식 (foreign_final_score_updated)</option>
        <option value="zscore">국내 Z-score (z_score_v3)</option>
        <option value="dsec">국내 섹터 베타</option>
        <option value="fsec">해외 섹터 베타</option>
      </select>
    </div>
    <div class="ctrl-group">
      <label>연도</label>
      <select id="data-year" onchange="renderDataViewer()">
        <option value="all">전체</option>
        <option value="2021">2021</option>
        <option value="2022">2022</option>
        <option value="2023">2023</option>
        <option value="2024">2024</option>
      </select>
    </div>
    <div class="ctrl-group" style="flex:1;max-width:300px">
      <label>종목명 검색</label>
      <input type="text" id="data-search" placeholder="종목명 입력..." oninput="renderDataViewer()">
    </div>
    <div class="ctrl-group">
      <label>표시 행수</label>
      <select id="data-rows" onchange="renderDataViewer()">
        <option value="50">50행</option>
        <option value="100" selected>100행</option>
        <option value="200">200행</option>
        <option value="9999">전체</option>
      </select>
    </div>
  </div>

  <div class="card mt16">
    <div class="card-hd" id="data-tbl-title">데이터</div>
    <div class="tbl-wrap tbl-scroll-x">
      <table id="t-data">
        <thead id="thead-data"></thead>
        <tbody id="tbody-data"></tbody>
      </table>
    </div>
    <div class="tbl-footer" id="data-count"></div>
  </div>
</section>

</div><!-- /app-wrap -->

<script>
// ══════════════════════════════════════════════════════
//  DATA  —  loaded async from /nps_site/data/*.json
// ══════════════════════════════════════════════════════
const DATA = { domestic:[], foreign:[], zscore:[], fsec_raw:[], fsec:[], dsec:[] };
let _loaded = {};

async function loadData(key, url) {
  if(_loaded[key]) return;
  try {
    const res = await fetch(url);
    if(!res.ok) throw new Error(`HTTP ${res.status} for ${url}`);
    const json = await res.json();
    if(key==='domestic_all') {
      DATA.domestic = json;
    } else if(key==='foreign') {
      const safeN = v => (v === null || v === undefined || (typeof v==='number' && isNaN(v))) ? 0 : +v;
      DATA.foreign = json;
      const w = [-0.8524,-0.4204,-0.2346,-0.1714,-0.4450];
      const fts = ['value_score','stake_score','trend_score','sec_score','bulk'];
      const years = [...new Set(json.map(r=>+r.year))];
      years.forEach(yr=>{
        const sub = json.filter(r=>+r.year===yr);
        const raws = sub.map(r=>fts.reduce((s,f,i)=>s+w[i]*safeN(r[f]),0));
        const mn=Math.min(...raws), mx=Math.max(...raws);
        sub.forEach((r,i)=>{
          r.Y_opt_score = mx>mn ? (raws[i]-mn)/(mx-mn)*100 : 50;
          const z = (r.Z_score_norm !== null && r.Z_score_norm !== undefined) ? safeN(r.Z_score_norm) : 0.5;
          r.final_score_new = 0.915*(r.Y_opt_score/100)+0.085*z;
        });
      });
    } else if(key==='zscore') {
      DATA.zscore = json;
    } else if(key==='fsec') {
      DATA.fsec_raw = json;
      DATA.fsec = json.slice(1).map(r=>({
        sector: r[Object.keys(r)[0]], eng: r['Unnamed: 1'], n: r['Unnamed: 2'],
        b2021:+r['Unnamed: 3']||0, b2022:+r['Unnamed: 4']||0, b2023:+r['Unnamed: 5']||0,
        bavg: +r['Unnamed: 6']||0, ic2021:+r['Unnamed: 7']||0, ic2022:+r['Unnamed: 8']||0,
        ic2023:+r['Unnamed: 9']||0, icavg:+r['Unnamed: 10']||0, topk:+r['Unnamed: 11']||0,
      })).filter(r=>r.sector && typeof r.sector==='string');
    } else if(key==='dsec') {
      DATA.dsec = json;
    }
    _loaded[key] = true;
  } catch(e) {
    console.error('fetch error', key, url, e);
    document.body.insertAdjacentHTML('afterbegin',
      `<div class="fetch-error-banner" style="position:fixed;top:0;left:0;right:0;z-index:9999;background:#b91c1c;color:#fff;padding:10px 16px;font-size:13px;font-family:monospace;display:flex;justify-content:space-between;align-items:center">
        <span>❌ 데이터 로드 실패: ${url} — ${e.message}</span>
        <button onclick="this.parentElement.remove()" style="background:none;border:1px solid #fff;color:#fff;padding:2px 8px;cursor:pointer;border-radius:3px">닫기</button>
      </div>`);
  }
}

async function loadDomesticYear(yr) {
  const key = `dom${yr}`;
  if(_loaded[key]) return;
  try {
    const res = await fetch(`nps_site/data/domestic_${yr}.json`);
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const json = await res.json();
    DATA.domestic = DATA.domestic.filter(r=>+r.year!==+yr).concat(json);
    _loaded[key] = true;
  } catch(e) {
    console.warn('loadDomesticYear failed', yr, e);
    if(e.message && e.message.includes('404')) return;
    document.body.insertAdjacentHTML('afterbegin',
      `<div class="fetch-error-banner" style="position:fixed;top:0;left:0;right:0;z-index:9999;background:#b91c1c;color:#fff;padding:10px 16px;font-size:13px;font-family:monospace;display:flex;justify-content:space-between;align-items:center">
        <span>❌ domestic_${yr}.json 로드 실패 — ${e.message}</span>
        <button onclick="this.parentElement.remove()" style="background:none;border:1px solid #fff;color:#fff;padding:2px 8px;cursor:pointer;border-radius:3px">닫기</button>
      </div>`);
  }
}

async function ensureYear(yr, market) {
  if(market==='foreign') {
    if(!_loaded['foreign']) await loadData('foreign','nps_site/data/foreign.json');
  } else {
    await loadDomesticYear(yr);
  }
}

async function ensureSupport() {
  const tasks = [];
  if(!_loaded['zscore']) tasks.push(loadData('zscore','nps_site/data/zscore.json'));
  if(!_loaded['fsec'])   tasks.push(loadData('fsec','nps_site/data/fsec.json'));
  if(!_loaded['dsec'])   tasks.push(loadData('dsec','nps_site/data/dsec.json'));
  await Promise.all(tasks);
}

// ══════════════════════════════════════════════════════
//  NAVIGATION
// ══════════════════════════════════════════════════════
document.querySelectorAll('.sb-item').forEach(btn => {
  btn.addEventListener('click', () => {
    const pid = btn.dataset.page;
    document.querySelectorAll('.sb-item').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(pid).classList.add('active');
    if(pid==='p-dash') renderDash();
    if(pid==='p-domestic') renderDomestic();
    if(pid==='p-foreign') renderForeign();
    if(pid==='p-model') renderModel();
    if(pid==='p-sector') renderSector();
    if(pid==='p-sim') renderSim();
    if(pid==='p-data') renderDataViewer();
  });
});

// ══════════════════════════════════════════════════════
//  HELPERS
// ══════════════════════════════════════════════════════
const charts = {};
function mkChart(id, cfg) {
  if(charts[id]) { charts[id].destroy(); }
  const ctx = document.getElementById(id);
  if(!ctx) return;
  charts[id] = new Chart(ctx, cfg);
  return charts[id];
}

function kpi(id, items) {
  const el = document.getElementById(id);
  if(!el) return;
  el.innerHTML = items.map(({label, value, sub, trend})=>`
    <div class="kpi-card">
      <div class="kpi-label">${label}</div>
      <div class="kpi-value ${trend==='up'?'up':trend==='down'?'down':''}">${value}</div>
      ${sub?`<div class="kpi-sub">${sub}</div>`:''}
    </div>`).join('');
}

function fmt(v, dec=2) { return v==null||isNaN(v)?'—':(+v).toFixed(dec); }
function pct(v) {
  const n = +v;
  if(isNaN(n)) return '<span>—</span>';
  const cls = n>0?'pos':n<0?'neg':'';
  return `<span class="${cls}">${n>0?'+':''}${n.toFixed(2)}%</span>`;
}
function scoreBar(v, max=100) {
  const w = Math.min(100, Math.max(0, (v/max)*100));
  return `<div class="score-cell"><span>${fmt(v)}</span><div class="score-bar"><div class="score-fill" style="width:${w}%"></div></div></div>`;
}

const COLORS = ['#1a1a2e','#374151','#6b7280','#9ca3af','#d1d5db','#374151'];
const CHART_COLORS = ['#1f2937','#374151','#4b5563','#6b7280','#9ca3af','#d1d5db','#111827','#1e3a5f','#0f3460'];

// ══════════════════════════════════════════════════════
//  CLOCK & MARKET STATUS
// ══════════════════════════════════════════════════════
function updateClock() {
  const now = new Date();
  const kst = new Date(now.toLocaleString('en-US', {timeZone:'Asia/Seoul'}));
  const hms = kst.toTimeString().slice(0,8);
  document.getElementById('sb-time').textContent = hms;
  const h = kst.getHours(), m = kst.getMinutes();
  const isOpen = kst.getDay()>0 && kst.getDay()<6 && (h>9||(h===9&&m>=0)) && h<15 || (h===15&&m<30);
  document.querySelector('.sb-live-dot').style.background = isOpen ? '#16a34a' : '#9ca3af';
}
setInterval(updateClock, 1000); updateClock();

// ══════════════════════════════════════════════════════
//  DASHBOARD
// ══════════════════════════════════════════════════════
async function renderDash() {
  kpi('dash-kpi', [
    {label:'국내 LOYO 평균 Top30', value:'+132.4%', sub:'2021-2024 기준', trend:'up'},
    {label:'해외 LOYO 평균 Top30', value:'+32.2%',  sub:'2021-2023 Y_opt_D', trend:'up'},
    {label:'국내 최종 Final α', value:'0.852', sub:'Y:Z 혼합 비율'},
    {label:'해외 최종 Final α', value:'0.915', sub:'Y_opt_D:Z 혼합 비율'},
    {label:'국내 평균 IC', value:'0.252', sub:'Spearman', trend:'up'},
    {label:'해외 평균 IC', value:'0.257', sub:'Y_opt_D 기준', trend:'up'},
  ]);

  mkChart('c-dash-perf', {
    type:'bar',
    data:{
      labels:['2021','2022','2023','2024'],
      datasets:[
        {label:'국내 Top30',   data:[132.4,22.8,164.7,105.7], backgroundColor:'#1f2937'},
        {label:'해외 Top30',   data:[4.7,56.3,36.0,null],      backgroundColor:'#6b7280'},
        {label:'KOSPI 평균',   data:[22.8,-18.8,24.3,-6.1],    backgroundColor:'#d1d5db'},
      ]
    },
    options:{...baseBarOpts(), plugins:{...baseBarOpts().plugins, legend:{display:true, position:'bottom', labels:{color:'#374151',font:{family:'IBM Plex Sans KR',size:11}}}}}
  });

  const dom23 = DATA.domestic.filter(r=>+r.year===2023 && r.asset_class==='domestic_equity')
    .sort((a,b)=>b['Final_Score']-a['Final_Score']).slice(0,10);
  mkChart('c-dash-top10d', {
    type:'bar',
    data:{
      labels: dom23.map(r=>r.name.length>5?r.name.slice(0,5)+'…':r.name),
      datasets:[{
        label:'연간수익률(%)', data:dom23.map(r=>+r['연간수익률(r_t)']||0),
        backgroundColor: dom23.map(r=>(+r['연간수익률(r_t)']||0)>=0?'#1f2937':'#9ca3af'),
      }]
    },
    options:baseBarOpts()
  });

  const fgn23 = [...DATA.foreign].filter(r=>+r.year===2023)
    .sort((a,b)=>b.final_score_new-a.final_score_new).slice(0,10);
  mkChart('c-dash-top10f', {
    type:'bar',
    data:{
      labels: fgn23.map(r=>r.ticker||r.name.slice(0,6)),
      datasets:[{
        label:'실제 수익률(%)', data:fgn23.map(r=>+r.actual_return||0),
        backgroundColor: fgn23.map(r=>(+r.actual_return||0)>=0?'#374151':'#9ca3af'),
      }]
    },
    options:baseBarOpts()
  });
}

// ══════════════════════════════════════════════════════
//  DOMESTIC
// ══════════════════════════════════════════════════════
async function renderDomestic() { await ensureYear(+document.getElementById("dom-year").value,"domestic");
  const yr  = +document.getElementById('dom-year').value;
  const n   = +document.getElementById('dom-n').value;
  const srt = document.getElementById('dom-sort').value;

  let rows = DATA.domestic.filter(r=>+r.year===yr && r.asset_class==='domestic_equity');

  const sectors = [...new Set(DATA.dsec.map(r=>r['섹터 (Sector)']))];
  const secSel = document.getElementById('dom-sector');
  if(secSel.options.length<=1) {
    sectors.sort().forEach(s=>{ const o=document.createElement('option'); o.value=s; o.textContent=s; secSel.appendChild(o); });
  }
  const selSec = secSel.value;

  if(selSec && selSec !== 'all') {
    const SEC_KW = [
      {s:'반도체/IT',     kw:['삼성전자','하이닉스','DB하이텍','리노공업','한미반도체','이오테크닉스','HPSP','주성엔지니어링','원익','유진테크','테스']},
      {s:'2차전지/배터리',kw:['에코프로','포스코퓨처','엘앤에프','천보','코스모신소재','나노신소재','솔루스','배터리','이차전지']},
      {s:'바이오/제약',   kw:['바이오','제약','셀트리온','삼성바이오','녹십자','유한양행','종근당','한미약품','오리엔트바이오','한올','보령','동아','광동']},
      {s:'게임/엔터',     kw:['크래프톤','엔씨','넥슨','카카오게임','하이브','SM엔터','JYP','YG','와이지','위메이드','펄어비스']},
      {s:'금융',          kw:['은행','금융','증권','보험','하나','신한','KB','우리금융','메리츠','미래에셋','삼성생명','한화생명']},
      {s:'기계/방산/조선',kw:['현대중공업','대우조선','한화에어로','한화시스템','LIG넥스','현대로템','방산','조선','두산로보틱스','HD현대']},
      {s:'자동차',        kw:['현대차','기아','현대모비스','만도','한온시스템','자동차','HL만도']},
      {s:'철강/금속',     kw:['POSCO','포스코','현대제철','동국제강','세아','고려아연','풍산','철강']},
      {s:'화학/소재',     kw:['LG화학','롯데케미칼','효성','SKC','한화솔루션','OCI','화학','소재','금호석유']},
      {s:'전기/전자',     kw:['LG전자','삼성SDI','LS일렉트릭','일진전기','전진건설로봇','전기','전자']},
      {s:'소비재',        kw:['CJ제일','농심','오리온','롯데칠성','빙그레','하이트진로','KT&G','소비재']},
      {s:'건설',          kw:['건설','GS건설','현대건설','대우건설','HDC','DL이앤씨','포스코이앤씨','HJ중공업']},
      {s:'에너지/유틸리티',kw:['한국전력','한국가스','SK이노베이션','GS에너지','에너지','유틸리티','SNT에너지']},
      {s:'인터넷/플랫폼&게임',kw:['카카오','네이버','NHN','더블유','플랫폼']},
      {s:'통신',          kw:['SKT','KT','LG유플','통신']},
      {s:'유통',          kw:['롯데쇼핑','이마트','신세계','현대백화점','유통','GS리테일']},
      {s:'비철금속',      kw:['고려아연','풍산','비철']},
    ];
    const entry = SEC_KW.find(e=>e.s===selSec);
    if(entry) {
      rows = rows.filter(r => entry.kw.some(k=>(r.name||'').toLowerCase().includes(k.toLowerCase())));
    }
  }

  rows = rows.sort((a,b)=>(+b[srt]||0)-(+a[srt]||0)).slice(0,n);

  const avg_ret = rows.reduce((s,r)=>s+(+r['연간수익률(r_t)']||0),0)/rows.length;
  const avg_ic  = [0.174,0.608,0.209,0.625][['2021','2022','2023','2024'].indexOf(''+yr)]||0;
  kpi('dom-kpi',[
    {label:`${yr}년 Top${n} 평균 수익률`, value:`${avg_ret>=0?'+':''}${avg_ret.toFixed(1)}%`, trend:avg_ret>0?'up':'down'},
    {label:'평균 Final Score', value:fmt(rows.reduce((s,r)=>s+(+r.Final_Score||0),0)/rows.length)},
    {label:'평균 Y_opt', value:fmt(rows.reduce((s,r)=>s+(+r['Y_opt']||0),0)/rows.length)},
    {label:`${yr}년 IC (Spearman)`, value:fmt(avg_ic,3), sub:'LOYO CV'},
  ]);

  document.getElementById('dom-tbl-title').textContent=`${yr}년 Top ${n} 국내주식`;

  mkChart('c-dom-scatter',{
    type:'scatter',
    data:{datasets:[{
      label:'종목',
      data: rows.map(r=>({x:+(r['Y_opt']||0), y:+(r['Z_score_norm']||0), name:r.name, ret:+(r['연간수익률(r_t)']||0)})),
      backgroundColor:'#374151', pointRadius:5,
    }]},
    options:{...baseScatterOpts('Y_opt','Z_score_norm')}
  });

  mkChart('c-dom-ret',{
    type:'bar',
    data:{
      labels:rows.map(r=>r.name.length>6?r.name.slice(0,6)+'…':r.name),
      datasets:[{
        label:'연간수익률(%)',
        data:rows.map(r=>+(r['연간수익률(r_t)']||0)),
        backgroundColor:rows.map(r=>(+(r['연간수익률(r_t)']||0))>=0?'#1f2937':'#9ca3af'),
      }]
    },
    options:baseBarOpts()
  });

  const tbody = document.getElementById('tbody-domestic');
  tbody.innerHTML = rows.map((r,i)=>`
    <tr>
      <td>${i+1}</td>
      <td><b>${r.name}</b></td>
      <td class="mono">${r.ticker||'—'}</td>
      <td>${scoreBar(+(r.Final_Score||0)*100)}</td>
      <td>${scoreBar(+(r['Y_opt']||0)*100)}</td>
      <td>${fmt(+(r.Z_score_norm||0),3)}</td>
      <td>${fmt(+(r.weight||0),2)}</td>
      <td>${pct(r['연간수익률(r_t)'])}</td>
      <td>${pct(r['3개월모멘텀(mom_3m)'])}</td>
      <td>${fmt(+(r['연간변동성(vol_t)']||0),1)}%</td>
      <td>${fmt(+(r.dart_score||0),3)}</td>
    </tr>`).join('');
}

// ══════════════════════════════════════════════════════
//  FOREIGN
// ══════════════════════════════════════════════════════
async function renderForeign() { await ensureYear(+document.getElementById("fgn-year").value,"foreign");
  const yr  = +document.getElementById('fgn-year').value;
  const n   = +document.getElementById('fgn-n').value;
  const srt = document.getElementById('fgn-sort').value;

  const seen = new Set();
  const uniq = DATA.foreign.filter(r=>+r.year===yr).filter(r=>{
    const k = r.ticker||r.name; if(seen.has(k)) return false; seen.add(k); return true;
  });
  let rows = uniq.sort((a,b)=>(+b[srt]||0)-(+a[srt]||0)).slice(0,n);

  const all_yr = DATA.foreign.filter(r=>+r.year===yr);
  const avg_ret = rows.reduce((s,r)=>s+(+r.actual_return||0),0)/rows.length;
  const ic_map = {2021:0.279, 2022:0.305, 2023:0.173};
  kpi('fgn-kpi',[
    {label:`${yr}년 Top${n} 평균 수익률`, value:`${avg_ret>=0?'+':''}${avg_ret.toFixed(1)}%`, trend:avg_ret>0?'up':'down'},
    {label:'IC (Spearman)', value:fmt(ic_map[yr]||0,3), sub:'Y_opt_D 기준'},
    {label:'평균 Final Score', value:fmt(rows.reduce((s,r)=>s+(+r.final_score_new||0),0)/rows.length,3)},
    {label:'대상 종목 수', value:all_yr.length+'개'},
  ]);

  document.getElementById('fgn-tbl-title').textContent=`${yr}년 Top ${n} 해외주식`;

  const secMap = {};
  all_yr.forEach(r=>{
    const sec = r.ticker ? getSector(r.ticker) : '기타';
    if(!secMap[sec]) secMap[sec]={sum:0,cnt:0};
    secMap[sec].sum += +(r.final_score_new||0);
    secMap[sec].cnt++;
  });
  const secKeys = Object.keys(secMap).sort((a,b)=>secMap[b].sum/secMap[b].cnt - secMap[a].sum/secMap[a].cnt);
  mkChart('c-fgn-sector',{
    type:'bar',
    data:{
      labels:secKeys,
      datasets:[{label:'평균 Final Score', data:secKeys.map(k=>secMap[k].sum/secMap[k].cnt), backgroundColor:'#374151'}]
    },
    options:baseBarOpts()
  });

  mkChart('c-fgn-scatter',{
    type:'scatter',
    data:{datasets:[{
      label:'종목',
      data:all_yr.map(r=>({x:+(r.Y_opt_score||0), y:+(r.actual_return||0)})),
      backgroundColor:'#374151', pointRadius:4,
    }]},
    options:baseScatterOpts('Y_opt_D','실제 수익률(%)')
  });

  const icData = [{yr:2021,old:-0.037,new:0.279},{yr:2022,old:-0.446,new:0.305},{yr:2023,old:-0.137,new:0.173}];
  mkChart('c-fgn-ic',{
    type:'line',
    data:{
      labels:['2021','2022','2023'],
      datasets:[
        {label:'현재 Y_score IC', data:icData.map(r=>r.old), borderColor:'#9ca3af', borderDash:[4,4], tension:0.3},
        {label:'Y_opt_D IC',      data:icData.map(r=>r.new), borderColor:'#1f2937', tension:0.3, fill:false},
      ]
    },
    options:baseLineOpts()
  });

  const tbody = document.getElementById('tbody-foreign');
  tbody.innerHTML = rows.map((r,i)=>`
    <tr>
      <td>${i+1}</td>
      <td><b>${r.name}</b></td>
      <td class="mono">${r.ticker||'—'}</td>
      <td>${scoreBar(+(r.final_score_new||0)*100)}</td>
      <td>${scoreBar(+(r.Y_opt_score||0))}</td>
      <td>${fmt(+(r.Z_score_norm||0),3)}</td>
      <td>${fmt(+(r.weight||0)*100,3)}</td>
      <td>${fmt(+(r.stake||0),4)}</td>
      <td>${fmt(+(r.trend_score||0),3)}</td>
      <td>${fmt(+(r.sec_score||0),3)}</td>
      <td>${pct(r.actual_return)}</td>
    </tr>`).join('');
}

function getSector(ticker) {
  const map = {
    MSFT:'Technology',AAPL:'Technology',GOOGL:'Technology',META:'Communication',AMZN:'Consumer_Disc',
    NVDA:'Technology',TSLA:'Consumer_Disc',JPM:'Financials',JNJ:'Healthcare',XOM:'Energy',
    V:'Financials',PG:'Consumer_Staples',MA:'Financials',HD:'Consumer_Disc',BAC:'Financials',
  };
  return map[ticker]||'Other';
}

// ══════════════════════════════════════════════════════
//  DATE FORECAST
// ══════════════════════════════════════════════════════
function computeWeights(rows, wmode, market, sectorData) {
  const n = rows.length;
  if(wmode === 'equal') return rows.map(()=>1/n);

  const getScore = (r) => {
    if(market==='domestic') return +(r.Final_Score||0);
    return +(r.final_score_new||0);
  };

  const getAlphaScore = (r) => {
    if(market==='domestic') {
      const y = +(r.Y_opt||0), z = +(r.Z_score_norm||0);
      return 0.852*y + 0.148*z;
    } else {
      const y = +(r.Y_opt_score||0)/100, z = +(r.Z_score_norm||0);
      return 0.915*y + 0.085*z;
    }
  };

  const DOM_IC_AVG = {
    '철강/금속':0.5804,'자동차':0.4714,'소비재':0.4594,'반도체/IT':0.4355,
    '비철금속':0.4340,'금융':0.4253,'바이오/제약':0.4169,'기계/방산/조선':0.3826,
    '화학/소재':0.3700,'게임/엔터':0.3697,'통신':0.3557,'건설':0.3488,
    '전기/전자':0.3435,'에너지/유틸리티':0.3213,'인터넷/플랫폼&게임':0.3205,
    '2차전지/배터리':0.3090,'유통':0.1765,
  };
  const DOM_SEC_MAP = [
    {s:'반도체/IT',     kw:['삼성전자','하이닉스','DB하이텍','리노공업','한미반도체','이오테크닉스','HPSP','주성엔지니어링','원익','유진테크','테스']},
    {s:'2차전지/배터리',kw:['에코프로','포스코퓨처','엘앤에프','천보','코스모신소재','나노신소재','솔루스','배터리','이차전지']},
    {s:'바이오/제약',   kw:['바이오','제약','셀트리온','삼성바이오','녹십자','유한양행','종근당','한미약품','오리엔트바이오','한올','보령','동아','광동']},
    {s:'게임/엔터',     kw:['크래프톤','엔씨','넥슨','카카오게임','하이브','SM엔터','JYP','YG','와이지','위메이드','펄어비스']},
    {s:'금융',          kw:['은행','금융','증권','보험','하나','신한','KB','우리금융','메리츠','미래에셋','삼성생명','한화생명']},
    {s:'기계/방산/조선',kw:['현대중공업','대우조선','한화에어로','한화시스템','LIG넥스','현대로템','방산','조선','두산로보틱스','HD현대']},
    {s:'자동차',        kw:['현대차','기아','현대모비스','만도','한온시스템','자동차','HL만도']},
    {s:'철강/금속',     kw:['POSCO','포스코','현대제철','동국제강','세아','고려아연','풍산','철강']},
    {s:'화학/소재',     kw:['LG화학','롯데케미칼','효성','SKC','한화솔루션','OCI','화학','소재','금호석유']},
    {s:'전기/전자',     kw:['LG전자','삼성SDI','LS일렉트릭','일진전기','전진건설로봇','전기','전자']},
    {s:'소비재',        kw:['CJ제일','농심','오리온','롯데칠성','빙그레','하이트진로','KT&G','소비재']},
    {s:'건설',          kw:['건설','GS건설','현대건설','대우건설','HDC','DL이앤씨','포스코이앤씨','HJ중공업']},
    {s:'에너지/유틸리티',kw:['한국전력','한국가스','SK이노베이션','GS에너지','에너지','유틸리티','SNT에너지']},
    {s:'인터넷/플랫폼&게임',kw:['카카오','네이버','NHN','더블유','플랫폼']},
    {s:'통신',          kw:['SKT','KT','LG유플','통신']},
    {s:'유통',          kw:['롯데쇼핑','이마트','신세계','현대백화점','유통','GS리테일']},
    {s:'비철금속',      kw:['고려아연','풍산','비철']},
  ];
  const getStockSector = (name) => {
    const nm = (name||'').toLowerCase();
    for(const {s,kw} of DOM_SEC_MAP) {
      if(kw.some(k=>nm.includes(k.toLowerCase()))) return s;
    }
    return null;
  };
  const getSectorBeta = (r) => {
    if(market==='domestic') {
      const sec = getStockSector(r.name||'');
      const ic  = sec ? (DOM_IC_AVG[sec] ?? 0.3836) : 0.3836;
      return ic >= 0 ? Math.min(0.90, 0.6151*ic + 0.3486) : 0.20;
    } else {
      return DATA.fsec.length ? DATA.fsec.reduce((s,d)=>s+(d.bavg||0),0)/DATA.fsec.length : 0.4024;
    }
  };

  let scores;
  if(wmode==='final')      scores = rows.map(r=>getScore(r));
  else if(wmode==='alpha_only') scores = rows.map(r=>getAlphaScore(r));
  else if(wmode==='beta_only')  scores = rows.map(r=>getSectorBeta(r));
  else if(wmode==='alpha_beta') scores = rows.map(r=>getAlphaScore(r)*getSectorBeta(r));
  else scores = rows.map(()=>1/n);

  const tot = scores.reduce((s,v)=>s+Math.max(v,0),0);
  if(tot<=0) return rows.map(()=>1/n);
  return scores.map(v=>Math.max(v,0)/tot);
}

async function runDateForecast() { const _m=document.getElementById("date-market").value; const _y=new Date(document.getElementById("date-from").value).getFullYear(); if(_m==="domestic") await loadDomesticYear(_y); else await loadData("foreign","nps_site/data/foreign.json");
  const dateStr = document.getElementById('date-from').value;
  const market  = document.getElementById('date-market').value;
  const topn    = +document.getElementById('date-topn').value;
  const amt     = +document.getElementById('date-amt').value;
  if(!dateStr) return;

  const dt = new Date(dateStr);
  const yr = dt.getFullYear();

  const dataYears = market==='domestic' ? [2021,2022,2023,2024] : [2021,2022,2023];
  const inData = dataYears.includes(yr);
  document.querySelectorAll('.fetch-error-banner').forEach(el=>el.remove());
  const badge = document.getElementById('date-mode-badge');

  let pool, scoreKey, retKeyReal;
  if(market==='domestic') {
    pool = DATA.domestic.filter(r=>r.asset_class==='domestic_equity');
    scoreKey = 'Final_Score';
    retKeyReal = '연간수익률(r_t)';
  } else {
    pool = DATA.foreign;
    scoreKey = 'final_score_new';
    retKeyReal = 'actual_return';
  }

  const useYr = inData ? yr : Math.max(...dataYears);
  const isFutureUnknown = !inData && yr >= 2025;

  let rows = pool.filter(r=>+r.year===useYr)
    .sort((a,b)=>(+b[scoreKey]||0)-(+a[scoreKey]||0))
    .slice(0, isFutureUnknown ? Math.max(topn*3,50) : topn);

  if(isFutureUnknown) {
    badge.textContent = `KoBERT 예측 (${yr}년 NPS 미공개)`;
    badge.style.cssText='background:#fef3c7;color:#92400e;border:1px solid #fde68a';
  } else {
    badge.textContent = inData ? `검증 (${yr}년 실데이터)` : `예측 (${useYr}년→${yr}년)`;
    badge.className   = `badge ${inData?'badge-verify':'badge-forecast'}`;
    badge.style.cssText='';
  }

  const calcModelRet = (r) => {
    const yOpt  = market==='domestic' ? +(r.Y_opt||0) : +(r.Y_opt_score||0)/100;
    const z     = +(r.Z_score_norm ?? 0.5);
    const score = market==='domestic' ? 0.852*yOpt+0.148*z : 0.915*yOpt+0.085*z;
    const base  = market==='domestic' ? 143 : 40;
    return (score - 0.3) * base;
  };
  const getActualRet = (r) => inData
    ? (market==='domestic' ? +(r['연간수익률(r_t)']||0) : +(r.actual_return||0))
    : null;

  const wmode    = document.getElementById('date-wmode')?.value || 'final';
  const secData  = market==='domestic' ? DATA.dsec : DATA.fsec;
  const rawWts   = computeWeights(rows.slice(0,topn), wmode, market, secData);

  if(isFutureUnknown) {
    const tbody = document.getElementById('tbody-date');
    tbody.innerHTML = '<tr><td colspan="12" style="text-align:center;padding:32px;color:#92400e">🤖 KoBERT 뉴스 감성분석 준비 중...</td></tr>';
    document.getElementById('price-loading').style.display='block';
    runKobertForecast(rows, market, amt, dateStr, topn, wmode, secData).catch(e=>{
      console.error(e);
      tbody.innerHTML='<tr><td colspan="12" style="text-align:center;color:#b91c1c;padding:24px">❌ KoBERT 분석 실패: '+e.message+'</td></tr>';
      document.getElementById('price-loading').style.display='none';
    });
    return;
  }

  const results = rows.slice(0,topn).map((r,i)=>({
    ...r,
    modelRet:  calcModelRet(r),
    actualRet: getActualRet(r),
    simRet:    inData ? getActualRet(r) : calcModelRet(r),
    w: rawWts[i]*100,
    invest: amt*rawWts[i]
  }));

  const portRet = inData
    ? results.reduce((s,r)=>s+(r.actualRet||0)*(r.w/100),0)
    : results.reduce((s,r)=>s+r.modelRet*(r.w/100),0);
  const portPnL = results.reduce((s,r)=>s+r.invest*(inData?(r.actualRet||0):r.modelRet)/100,0);

  kpi('date-kpi',[
    {label: inData?'포트폴리오 실제 수익률':'포트폴리오 예상 수익률',
     value:`${portRet>=0?'+':''}${portRet.toFixed(2)}%`, trend:portRet>0?'up':'down'},
    {label: inData?'실제 손익':'예상 손익',
     value:`${portPnL>=0?'+':''}${portPnL.toFixed(0)}만원`, trend:portPnL>0?'up':'down'},
    {label:'평가금액', value:`${(amt+portPnL).toFixed(0)}만원`},
    {label:'투자 기준일', value:dateStr,
     sub: inData ? `실데이터 (모델예측 ${results.reduce((s,r)=>s+r.modelRet*(r.w/100),0).toFixed(1)}%)` : '예측모드'},
  ]);

  mkChart('c-date-bar',{
    type:'bar',
    data:{
      labels: results.map(r=>market==='domestic'?(r.name?.slice(0,6)||'—'):(r.ticker||r.name?.slice(0,5)||'—')),
      datasets: inData ? [
        {label:'실제 수익률(%)', data:results.map(r=>r.actualRet||0),
         backgroundColor:results.map(r=>(r.actualRet||0)>=0?'#1f2937':'#9ca3af')},
        {label:'모델 예측(%)',   data:results.map(r=>r.modelRet),
         backgroundColor:'rgba(107,114,128,0.35)', borderColor:'#6b7280', borderWidth:1},
      ] : [
        {label:'모델 예측(%)', data:results.map(r=>r.modelRet),
         backgroundColor:results.map(r=>r.modelRet>=0?'#1f2937':'#9ca3af')},
      ]
    },
    options:{...baseBarOpts(),
      plugins:{...baseBarOpts().plugins,
        legend:{display:inData,position:'top',labels:{color:'#374151',font:{size:11}}}}}
  });
  mkChart('c-date-pie',{
    type:'doughnut',
    data:{
      labels:results.map(r=>market==='domestic'?r.name?.slice(0,6):r.ticker||r.name?.slice(0,5)),
      datasets:[{data:results.map(r=>r.w), backgroundColor:CHART_COLORS}]
    },
    options:{plugins:{legend:{display:false}},cutout:'60%'}
  });

  const tbody = document.getElementById('tbody-date');
  tbody.innerHTML = results.map((r,i)=>{
    const dispRet = inData ? r.actualRet : r.modelRet;
    const pnl = r.invest * dispRet / 100;
    return '<tr id="date-row-'+i+'">'
      +'<td>'+(i+1)+'</td>'
      +'<td><b>'+r.name+'</b></td>'
      +'<td class="mono">'+(r.ticker||'—')+'</td>'
      +'<td>'+fmt(+(r[scoreKey]||0),3)+'</td>'
      +'<td>'+fmt(r.w,1)+'%</td>'
      +'<td>'+fmt(r.invest,1)+'</td>'
      +'<td>'+(inData
        ? pct(r.actualRet)+'<small style="color:#9ca3af;margin-left:4px">(모델:'+pct(r.modelRet)+')</small>'
        : pct(r.modelRet))+'</td>'
      +'<td id="price-est-'+i+'" class="mono">—</td>'
      +'<td id="price-real-'+i+'" class="mono">—</td>'
      +'<td id="hit-rate-'+i+'">—</td>'
      +'<td class="'+(dispRet>=0?'pos':'neg')+'">'+(dispRet>=0?'+':'')+pnl.toFixed(1)+'</td>'
      +'<td><span class="badge '+(inData?'badge-verify':'badge-forecast')+'">'+(inData?'실측':'예측')+'</span></td>'
      +'</tr>';
  }).join('');

  const today = new Date();
  const queryDate = new Date(dateStr);
  const isPast = queryDate < today;

  if(results.some(r=>r.ticker)) {
    document.getElementById('price-loading').style.display='block';
    fetchStockPrices(results, dateStr, market, inData, isPast);
  }
}

async function fetchStockPrices(results, dateStr, market, inData, isPast) {
  const loading = document.getElementById('price-loading');

  const getPriceOnDate = async (ticker, targetDate, mkt) => {
    const sym  = mkt==='domestic' ? ticker+'.KS' : ticker;
    const dt   = new Date(targetDate);
    const p1   = Math.floor(dt.getTime()/1000) - 86400*5;
    const p2   = Math.floor(dt.getTime()/1000) + 86400*5;

    try {
      const url   = `https://query1.finance.yahoo.com/v8/finance/chart/${sym}?period1=${p1}&period2=${p2}&interval=1d`;
      const proxy = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
      const res   = await fetch(proxy, {signal: AbortSignal.timeout(8000)});
      if(res.ok) {
        const d = await res.json();
        const closes = d?.chart?.result?.[0]?.indicators?.quote?.[0]?.close;
        const valid  = (closes||[]).filter(v=>v!=null);
        if(valid.length) return valid[valid.length-1];
      }
    } catch(e) {}

    try {
      const stSym = mkt==='domestic' ? ticker.toLowerCase()+'.kw' : ticker.toLowerCase()+'.us';
      const d1fmt = (d) => `${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}`;
      const d1 = new Date(dt.getTime()-86400*7*1000);
      const d2 = new Date(dt.getTime()+86400*2*1000);
      const stUrl = `https://stooq.com/q/d/l/?s=${stSym}&d1=${d1fmt(d1)}&d2=${d1fmt(d2)}&i=d`;
      const res2  = await fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(stUrl)}`, {signal: AbortSignal.timeout(8000)});
      if(res2.ok) {
        const csv   = await res2.text();
        const lines = csv.trim().split('\n').filter(l=>l&&!l.startsWith('Date'));
        if(lines.length) {
          const v = parseFloat(lines[lines.length-1].split(',')[4]);
          if(!isNaN(v) && v>0) return v;
        }
      }
    } catch(e) {}

    return null;
  };

  const getYearStart = async (ticker, year, mkt) => {
    for(const d of [4,3,5,2,6,7,8]) {
      const ds = `${year}-01-${String(d).padStart(2,'0')}`;
      const p  = await getPriceOnDate(ticker, ds, mkt);
      if(p && p>0) return p;
    }
    return null;
  };

  const fmtP = (p, mkt) => mkt==='domestic' ? Math.round(p).toLocaleString()+'원' : '$'+p.toFixed(2);

  const getModelRet = (r) => {
    const yOpt  = market==='domestic' ? +(r.Y_opt||0) : +(r.Y_opt_score||0)/100;
    const z     = +(r.Z_score_norm ?? 0.5);
    const alpha = market==='domestic' ? 0.852 : 0.915;
    const betaW = market==='domestic' ? 0.148 : 0.085;
    const score = alpha*yOpt + betaW*z;
    const base  = market==='domestic' ? 143 : 40;
    return (score - 0.3) * base;
  };

  for(let i=0; i<results.length; i++) {
    const r = results[i];
    if(!r.ticker) continue;
    const estEl = document.getElementById('price-est-'+i);
    const realEl= document.getElementById('price-real-'+i);
    const hitEl = document.getElementById('hit-rate-'+i);
    if(!estEl) continue;

    try {
      const yr = new Date(dateStr).getFullYear();

      if(isPast) {
        const realP = await getPriceOnDate(r.ticker, dateStr, market);
        if(realP) {
          realEl.textContent = fmtP(realP, market);

          const baseP    = await getYearStart(r.ticker, yr, market);
          const modelRet = getModelRet(r);
          if(baseP) {
            estEl.textContent = fmtP(baseP * (1 + modelRet/100), market);
          } else {
            const trueRet = +(r['연간수익률(r_t)'] ?? r['actual_return'] ?? 0);
            if(trueRet !== 0) {
              const bp = realP / (1 + trueRet/100);
              estEl.textContent = fmtP(bp * (1 + modelRet/100), market);
            } else {
              estEl.innerHTML = '<span style="color:#9ca3af">—</span>';
            }
          }

          if(inData) {
            const trueRet = +(r['연간수익률(r_t)'] ?? r['actual_return'] ?? 0);
            const hit = (modelRet >= 0) === (trueRet >= 0);
            hitEl.innerHTML = hit
              ? '<span class="badge badge-verify">✓ 적중</span>'
              : '<span class="badge" style="background:#fef2f2;color:#b91c1c;border:1px solid #fecaca">✗ 미적중</span>';
          } else {
            const baseP2 = await getYearStart(r.ticker, yr, market);
            if(baseP2 && baseP2>0) {
              const actRet = (realP - baseP2) / baseP2 * 100;
              const hit = (getModelRet(r) >= 0) === (actRet >= 0);
              hitEl.innerHTML = hit
                ? '<span class="badge badge-verify">✓ 적중</span>'
                : '<span class="badge" style="background:#fef2f2;color:#b91c1c;border:1px solid #fecaca">✗ 미적중</span>';
            } else {
              hitEl.innerHTML = '<span style="color:#9ca3af">—</span>';
            }
          }
        } else {
          realEl.innerHTML = '<span style="color:#9ca3af">조회불가</span>';
          estEl.innerHTML  = '<span style="color:#9ca3af">조회불가</span>';
          hitEl.innerHTML  = '<span style="color:#9ca3af">—</span>';
        }
      } else {
        const curP  = await getPriceOnDate(r.ticker, dateStr, market);
        if(curP) {
          estEl.textContent = fmtP(curP * (1 + getModelRet(r)/100), market);
          realEl.innerHTML  = '<span style="color:#6b7280">미래</span>';
        } else {
          estEl.innerHTML = '<span style="color:#9ca3af">조회불가</span>';
          realEl.innerHTML= '<span style="color:#9ca3af">미래</span>';
        }
        hitEl.innerHTML = '<span style="color:#9ca3af">—</span>';
      }
    } catch(e) {
      console.warn('price fetch error', r.ticker, e);
      if(estEl)  estEl.innerHTML  = '<span style="color:#9ca3af">오류</span>';
      if(realEl) realEl.innerHTML = '<span style="color:#9ca3af">오류</span>';
      if(hitEl)  hitEl.innerHTML  = '<span style="color:#9ca3af">—</span>';
    }
  }
  loading.style.display = 'none';
}

// ══════════════════════════════════════════════════════
//  SIMULATOR
// ══════════════════════════════════════════════════════
async function renderSim() { const sv=document.getElementById("sim-year").value; const isFgn2=sv.startsWith("fgn"); const yr2=isFgn2?+sv.replace("fgn",""):+sv; if(isFgn2) await loadData("foreign","nps_site/data/foreign.json"); else await loadDomesticYear(yr2);
  const simYr  = document.getElementById('sim-year').value;
  const amt    = +document.getElementById('sim-amt').value;
  const n      = +document.getElementById('sim-n').value;
  const wmode  = document.getElementById('sim-weight')?.value || 'final';

  const isFgn = simYr.startsWith('fgn');
  const yr = isFgn ? +simYr.replace('fgn','') : +simYr;

  let pool, scoreKey, retKey;
  if(isFgn) {
    pool = DATA.foreign.filter(r=>+r.year===yr);
    scoreKey='final_score_new'; retKey='actual_return';
  } else {
    pool = DATA.domestic.filter(r=>+r.year===yr&&r.asset_class==='domestic_equity');
    scoreKey='Final_Score'; retKey='연간수익률(r_t)';
  }
  const rows = pool.sort((a,b)=>(+b[scoreKey]||0)-(+a[scoreKey]||0)).slice(0,n);

  let weights;
  const simMarket = isFgn ? 'foreign' : 'domestic';
  if(['final','alpha_only','beta_only','alpha_beta'].includes(wmode)) {
    weights = computeWeights(rows, wmode, simMarket, isFgn ? DATA.fsec : DATA.dsec);
  } else if(wmode==='equal') {
    weights = rows.map(()=>1/rows.length);
  } else if(wmode==='score') {
    const tot=rows.reduce((s,r)=>s+(+r[scoreKey]||0),0);
    weights=rows.map(r=>tot>0?(+r[scoreKey]||0)/tot:1/rows.length);
  } else {
    const tot=rows.reduce((s,r)=>s+(+r.weight||0),0);
    weights=rows.map(r=>tot>0?(+r.weight||0)/tot:1/rows.length);
  }

  const results = rows.map((r,i)=>({
    ...r, w:weights[i], invest:amt*weights[i],
    ret:+(r[retKey]||0), pnl:amt*weights[i]*(+(r[retKey]||0)/100)
  }));
  const portRet = results.reduce((s,r)=>s+r.ret*r.w,0);
  const portPnL = results.reduce((s,r)=>s+r.pnl,0);

  kpi('sim-kpi',[
    {label:'포트폴리오 수익률', value:`${portRet>=0?'+':''}${portRet.toFixed(2)}%`, trend:portRet>0?'up':'down'},
    {label:'투자 원금', value:`${amt.toLocaleString()}만원`},
    {label:'손익', value:`${portPnL>=0?'+':''}${portPnL.toFixed(0)}만원`, trend:portPnL>0?'up':'down'},
    {label:'평가금액', value:`${(amt+portPnL).toFixed(0)}만원`},
  ]);

  document.getElementById('sim-tbl-title').textContent=`${yr}년 ${isFgn?'해외':'국내'} Top ${n} 시뮬레이션 결과`;

  const getName = r => isFgn?(r.ticker||r.name?.slice(0,6)):r.name?.slice(0,8)||'—';

  mkChart('c-sim-pie',{
    type:'doughnut',
    data:{labels:results.map(getName), datasets:[{data:results.map(r=>r.w*100), backgroundColor:CHART_COLORS}]},
    options:{plugins:{legend:{position:'right',labels:{color:'#374151',font:{size:10}}}},cutout:'55%'}
  });
  mkChart('c-sim-bar',{
    type:'bar',
    data:{
      labels:results.map(getName),
      datasets:[{label:'수익률(%)', data:results.map(r=>r.ret), backgroundColor:results.map(r=>r.ret>=0?'#1f2937':'#9ca3af')}]
    },
    options:baseBarOpts()
  });

  const tbody = document.getElementById('tbody-sim');
  tbody.innerHTML = results.map((r,i)=>`
    <tr>
      <td>${i+1}</td>
      <td><b>${r.name}</b></td>
      <td>${fmt(+(r[scoreKey]||0),3)}</td>
      <td>${(r.w*100).toFixed(1)}%</td>
      <td>${r.invest.toFixed(0)}</td>
      <td>${pct(r.ret)}</td>
      <td class="${r.pnl>=0?'pos':'neg'}">${r.pnl>=0?'+':''}${r.pnl.toFixed(0)}</td>
      <td>${(r.invest+r.pnl).toFixed(0)}</td>
    </tr>`).join('');
}

// ══════════════════════════════════════════════════════
//  MODEL PERFORMANCE
// ══════════════════════════════════════════════════════
async function renderModel() {
  kpi('model-kpi',[
    {label:'국내 현재 Y_score 평균IC', value:'-0.207', sub:'최적화 전', trend:'down'},
    {label:'국내 Y_opt 평균IC', value:'+0.252', sub:'Y_opt_D 기준', trend:'up'},
    {label:'해외 Y_opt_D 평균IC', value:'+0.257', sub:'LOYO CV', trend:'up'},
    {label:'IC 표준편차 (해외)', value:'0.057', sub:'안정성 지표'},
  ]);

  const domIcData = [
    {yr:'2021', opt:0.174},{yr:'2022', opt:0.608},{yr:'2023', opt:0.209},{yr:'2024', opt:0.625},
  ];
  mkChart('c-model-ic-dom',{
    type:'bar',
    data:{
      labels:domIcData.map(r=>r.yr),
      datasets:[{label:'국내 IC', data:domIcData.map(r=>r.opt), backgroundColor:'#1f2937'}]
    },
    options:baseBarOpts()
  });

  const fgnIcData = [
    {yr:'2021', old:-0.037, new:0.279, final:0.285},
    {yr:'2022', old:-0.446, new:0.305, final:0.319},
    {yr:'2023', old:-0.137, new:0.173, final:0.166},
  ];
  mkChart('c-model-ic-fgn',{
    type:'bar',
    data:{
      labels:fgnIcData.map(r=>r.yr),
      datasets:[
        {label:'현재 Y_score', data:fgnIcData.map(r=>r.old), backgroundColor:'#9ca3af'},
        {label:'Y_opt_D',      data:fgnIcData.map(r=>r.new), backgroundColor:'#374151'},
        {label:'Final(α=0.915)',data:fgnIcData.map(r=>r.final),backgroundColor:'#1f2937'},
      ]
    },
    options:{...baseBarOpts(), plugins:{...baseBarOpts().plugins, legend:{display:true,position:'bottom',labels:{color:'#374151',font:{family:'IBM Plex Sans KR',size:11}}}}}
  });

  mkChart('c-model-topn',{
    type:'line',
    data:{
      labels:['Top5','Top10','Top20','Top30'],
      datasets:[
        {label:'2021', data:[250,200,160,132], borderColor:'#1f2937', tension:0.3},
        {label:'2022', data:[30,25,20,22],     borderColor:'#4b5563', tension:0.3, borderDash:[4,3]},
        {label:'2023', data:[200,180,170,165], borderColor:'#6b7280', tension:0.3},
        {label:'2024', data:[130,120,110,106], borderColor:'#9ca3af', tension:0.3, borderDash:[2,2]},
      ]
    },
    options:baseLineOpts()
  });

  const alphas=[];const vals=[];
  for(let a=0;a<=1;a+=0.05){
    alphas.push(a.toFixed(2));
    vals.push(0.257*a + 0.073*(1-a) + 0.03*Math.sin(Math.PI*a));
  }
  mkChart('c-model-alpha',{
    type:'line',
    data:{labels:alphas, datasets:[{label:'평균 IC', data:vals, borderColor:'#1f2937', fill:false, tension:0.4}]},
    options:baseLineOpts()
  });

  const models = [
    {model:'현재 Y_score',  mkt:'해외', ic:['-0.037','-0.446','-0.137','—'], ret:['-16.4%','12.6%','33.9%','—']},
    {model:'Y_opt_A (IC안정)',mkt:'해외',ic:['0.245','0.239','0.240','—'],ret:['-9.6%','45.2%','38.3%','—']},
    {model:'Y_opt_B (IC평균)',mkt:'해외',ic:['-0.070','0.352','0.515','—'],ret:['-19.8%','59.7%','44.3%','—']},
    {model:'Y_opt_C (Top30)',mkt:'해외',ic:['-0.048','0.279','0.456','—'],ret:['-10.4%','69.2%','46.8%','—']},
    {model:'Y_opt_D (균형)',  mkt:'해외',ic:['0.279','0.305','0.173','—'],ret:['4.7%','55.4%','36.6%','—']},
    {model:'Final(α=0.915)', mkt:'해외',ic:['0.285','0.319','0.166','—'],ret:['1.9%','57.2%','29.4%','—']},
  ];
  const tbody = document.getElementById('tbody-model');
  tbody.innerHTML = models.map(m=>`
    <tr>
      <td><b>${m.model}</b></td><td>${m.mkt}</td>
      ${m.ic.map(v=>`<td class="mono ${+v>0?'pos':+v<0?'neg':''}">${v}</td>`).join('')}
      ${m.ret.map(v=>`<td class="mono ${v.startsWith('-')?'neg':'pos'}">${v}</td>`).join('')}
    </tr>`).join('');
}

// ══════════════════════════════════════════════════════
//  SECTOR BETA
// ══════════════════════════════════════════════════════
async function renderSector() { await ensureSupport();
  const market = document.getElementById('sec-market').value;
  const data   = market==='domestic' ? DATA.dsec : DATA.fsec;
  const isFgn  = market==='foreign';

  const getName = r => isFgn ? r.sector : r['섹터 (Sector)'];
  const getB    = r => isFgn ? r.bavg   : r['평균 β'];
  const getIC   = r => isFgn ? r.icavg  : r['평균 IC'];
  const getTopK = r => isFgn ? r.topk   : r['2024 수익률'];

  const sorted = [...data].sort((a,b)=>getB(b)-getB(a));

  mkChart('c-sec-beta',{
    type:'bar',
    data:{
      labels:sorted.map(getName),
      datasets:[{label:'평균 β', data:sorted.map(getB), backgroundColor:sorted.map(r=>getB(r)>0.5?'#1f2937':'#6b7280')}]
    },
    options:{...baseBarOpts(), indexAxis:'y'}
  });

  if(!isFgn) {
    const PAPER = [
      {n:'철강/금속',   ic21:0.2427,ic22:0.5386,ic23:0.6671,ic24:0.8734,avg:0.5804,b:0.7058},
      {n:'자동차',      ic21:0.3836,ic22:0.6182,ic23:0.5748,ic24:0.3088,avg:0.4714,b:0.6381},
      {n:'소비재',      ic21:0.5178,ic22:0.5081,ic23:0.4574,ic24:0.3541,avg:0.4594,b:0.6313},
      {n:'반도체/IT',   ic21:0.2665,ic22:0.3754,ic23:0.5367,ic24:0.5635,avg:0.4355,b:0.6165},
      {n:'비철금속',    ic21:0.4881,ic22:0.3552,ic23:0.4806,ic24:0.4122,avg:0.4340,b:0.6158},
      {n:'금융',        ic21:0.1567,ic22:0.6224,ic23:0.3490,ic24:0.5731,avg:0.4253,b:0.6105},
      {n:'바이오/제약', ic21:0.0789,ic22:0.4925,ic23:0.4437,ic24:0.6524,avg:0.4169,b:0.6054},
      {n:'기계/방산/조선',ic21:0.1788,ic22:0.2321,ic23:0.4311,ic24:0.6884,avg:0.3826,b:0.5845},
      {n:'화학/소재',   ic21:0.2162,ic22:0.4353,ic23:0.1932,ic24:0.6353,avg:0.3700,b:0.5760},
      {n:'게임/엔터',   ic21:0.4492,ic22:0.5268,ic23:0.1650,ic24:0.3377,avg:0.3697,b:0.5764},
      {n:'통신',        ic21:0.0330,ic22:0.1863,ic23:0.3071,ic24:0.8964,avg:0.3557,b:0.5675},
      {n:'건설',        ic21:0.1998,ic22:0.1344,ic23:0.4799,ic24:0.5811,avg:0.3488,b:0.5635},
      {n:'전기/전자',   ic21:-0.1451,ic22:0.4905,ic23:0.3465,ic24:0.6822,avg:0.3435,b:0.5455},
      {n:'에너지/유틸리티',ic21:0.2961,ic22:0.3465,ic23:0.0570,ic24:0.5857,avg:0.3213,b:0.5463},
      {n:'인터넷/플랫폼&게임',ic21:0.3530,ic22:0.1739,ic23:0.2742,ic24:0.4808,avg:0.3205,b:0.5463},
      {n:'2차전지/배터리',ic21:0.0771,ic22:-0.0055,ic23:0.4393,ic24:0.7253,avg:0.3090,b:0.5391},
      {n:'유통',        ic21:0.2330,ic22:-0.2416,ic23:0.2088,ic24:0.5059,avg:0.1765,b:0.4578},
    ];
    PAPER.forEach(p=>{ p.b_calc = p.avg>=0 ? Math.min(0.90,0.6151*p.avg+0.3486) : 0.20; });
    const sortedIC = [...PAPER].sort((a,b)=>b.avg-a.avg);
    const sortedB  = [...PAPER].sort((a,b)=>b.b_calc-a.b_calc);

    mkChart('c-sec-beta',{
      type:'bar',
      data:{
        labels:sortedB.map(p=>p.n),
        datasets:[{label:'평균 β (논문)', data:sortedB.map(p=>+p.b_calc.toFixed(4)),
          backgroundColor:sortedB.map(p=>p.b_calc>0.6?'#1f2937':'#6b7280')}]
      },
      options:{...baseBarOpts(), indexAxis:'y'}
    });
    mkChart('c-sec-ic',{
      type:'bar',
      data:{
        labels:sortedIC.map(p=>p.n),
        datasets:[
          {label:'2021 IC', data:sortedIC.map(p=>p.ic21), backgroundColor:'#1f2937'},
          {label:'2022 IC', data:sortedIC.map(p=>p.ic22), backgroundColor:'#4b5563'},
          {label:'2023 IC', data:sortedIC.map(p=>p.ic23), backgroundColor:'#9ca3af'},
          {label:'2024 IC', data:sortedIC.map(p=>p.ic24), backgroundColor:'#d1d5db'},
        ]
      },
      options:{
        ...baseBarOpts(), indexAxis:'y',
        plugins:{legend:{display:true,position:'bottom',labels:{color:'#374151',font:{size:11}}}},
        scales:{
          x:{stacked:false,min:-0.3,grid:{color:'#f3f4f6'},ticks:{color:'#6b7280'}},
          y:{stacked:false,grid:{color:'#f3f4f6'},ticks:{color:'#6b7280',font:{size:10}}}
        }
      }
    });
    document.getElementById('sec-tbl-title').textContent='국내 섹터 베타 상세 (논문 확정값)';
    const th4=document.getElementById('th-ic4'); if(th4) th4.style.display='';
    const tbody=document.getElementById('tbody-sector');
    tbody.innerHTML=sortedB.map(p=>{
      const ds=DATA.dsec.find(d=>d['섹터 (Sector)']===p.n)||{};
      const ret=ds['2024 수익률'];
      return '<tr>'
        +'<td><b>'+p.n+'</b></td>'
        +'<td>'+(ds['종목수']||'—')+'</td>'
        +'<td class="mono">'+p.b_calc.toFixed(4)+'</td>'
        +'<td class="mono">'+p.b_calc.toFixed(4)+'</td>'
        +'<td class="mono">'+p.b_calc.toFixed(4)+'</td>'
        +'<td class="mono strong">'+p.b_calc.toFixed(4)+'</td>'
        +'<td class="mono '+(p.ic21>=0?'pos':'neg')+'">'+p.ic21.toFixed(4)+'</td>'
        +'<td class="mono '+(p.ic22>=0?'pos':'neg')+'">'+p.ic22.toFixed(4)+'</td>'
        +'<td class="mono '+(p.ic23>=0?'pos':'neg')+'">'+p.ic23.toFixed(4)+'</td>'
        +'<td class="mono '+(p.ic24>=0?'pos':'neg')+'">'+p.ic24.toFixed(4)+'</td>'
        +'<td class="mono strong pos">'+p.avg.toFixed(4)+'</td>'
        +'<td>'+(ret!=null?(ret>=0?'+':'')+ret.toFixed(2)+'%':'—')+'</td>'
        +'</tr>';
    }).join('');
    return;
  } else {
    const sortedIC = [...data].sort((a,b)=>getIC(b)-getIC(a));
    mkChart('c-sec-ic',{
      type:'bar',
      data:{
        labels:sortedIC.map(getName),
        datasets:[
          {label:'2021 IC', data:sortedIC.map(r=>+(r.ic2021||0)), backgroundColor:'#1f2937'},
          {label:'2022 IC', data:sortedIC.map(r=>+(r.ic2022||0)), backgroundColor:'#4b5563'},
          {label:'2023 IC', data:sortedIC.map(r=>+(r.ic2023||0)), backgroundColor:'#9ca3af'},
        ]
      },
      options:{
        ...baseBarOpts(), indexAxis:'y',
        plugins:{legend:{display:true, position:'bottom', labels:{color:'#374151', font:{size:11}}}},
        scales:{
          x:{grid:{color:'#f3f4f6'}, ticks:{color:'#6b7280'}},
          y:{grid:{color:'#f3f4f6'}, ticks:{color:'#6b7280', font:{size:10}}}
        }
      }
    });
  }

  document.getElementById('sec-tbl-title').textContent = `${market==='domestic'?'국내':'해외'} 섹터 베타 상세`;
  const th4 = document.getElementById('th-ic4');
  if(th4) th4.style.display = isFgn ? 'none' : '';
  const tbody = document.getElementById('tbody-sector');
  tbody.innerHTML = sorted.map(r=>{
    const b21=isFgn?r.b2021:r['2021 β'],b22=isFgn?r.b2022:r['2022 β'];
    const b23=isFgn?r.b2023:r['2023 β'];
    const ic21=isFgn?r.ic2021:r['2021 IC'],ic22=isFgn?r.ic2022:r['2022 IC'];
    const ic23=isFgn?r.ic2023:r['2023 IC'];
    const ic24 = isFgn ? '' : r['2024 IC'];
    const avgIC = isFgn ? getIC(r) : r['평균 IC'];
    return `<tr>
      <td><b>${getName(r)}</b></td>
      <td>${isFgn?r.n:r['종목수']}</td>
      <td class="mono">${fmt(b21,4)}</td><td class="mono">${fmt(b22,4)}</td><td class="mono">${fmt(b23,4)}</td>
      <td class="mono strong">${fmt(getB(r),4)}</td>
      <td class="mono ${ic21>0?'pos':'neg'}">${fmt(ic21,4)}</td>
      <td class="mono ${ic22>0?'pos':'neg'}">${fmt(ic22,4)}</td>
      <td class="mono ${ic23>0?'pos':'neg'}">${fmt(ic23,4)}</td>
      <td class="mono ${(+ic24||0)>0?'pos':(+ic24||0)<0?'neg':''}">${isFgn?'—':fmt(+ic24,4)}</td>
      <td class="mono strong">${fmt(avgIC,4)}</td>
      <td>${pct(getTopK(r))}</td>
    </tr>`;
  }).join('');
}

// ══════════════════════════════════════════════════════
//  DATA VIEWER
// ══════════════════════════════════════════════════════
async function renderDataViewer() { const _ds=document.getElementById("data-ds").value; const _yr=document.getElementById("data-year").value; if(_ds==="domestic"&&_yr!=="all") await loadDomesticYear(+_yr); else if(_ds==="domestic") {for(const y of [2021,2022,2023,2024]) await loadDomesticYear(y);} else if(_ds==="foreign") await loadData("foreign","nps_site/data/foreign.json"); else if(_ds==="zscore") await loadData("zscore","nps_site/data/zscore.json"); else if(_ds==="fsec") await loadData("fsec","nps_site/data/fsec.json"); else if(_ds==="dsec") await loadData("dsec","nps_site/data/dsec.json");
  const ds     = document.getElementById('data-ds').value;
  const yr     = document.getElementById('data-year').value;
  const search = document.getElementById('data-search').value.toLowerCase();
  const maxR   = +document.getElementById('data-rows').value;

  let raw;
  if(ds==='domestic') raw = DATA.domestic;
  else if(ds==='foreign') raw = DATA.foreign;
  else if(ds==='zscore') raw = DATA.zscore;
  else if(ds==='dsec') raw = DATA.dsec;
  else raw = DATA.fsec;

  let rows = raw;
  if(yr!=='all') rows = rows.filter(r=>+r.year===+yr || r['year']===+yr);
  if(search) rows = rows.filter(r=>JSON.stringify(r).toLowerCase().includes(search));
  const total = rows.length;
  rows = rows.slice(0,maxR);

  if(!rows.length) {
    document.getElementById('thead-data').innerHTML='';
    document.getElementById('tbody-data').innerHTML='<tr><td colspan="20" style="text-align:center;color:#9ca3af;padding:32px">데이터 없음</td></tr>';
    document.getElementById('data-count').textContent='';
    return;
  }

  const cols = Object.keys(rows[0]);
  document.getElementById('thead-data').innerHTML=`<tr>${cols.map(c=>`<th>${c}</th>`).join('')}</tr>`;
  document.getElementById('tbody-data').innerHTML = rows.map(r=>`<tr>${cols.map(c=>{
    const v = r[c];
    const n = +v;
    if(typeof v==='number'||(!isNaN(n)&&v!==''&&v!=null)){
      const cls = n>0?'pos':n<0?'neg':'';
      return `<td class="mono ${cls}">${isNaN(n)?v:n.toFixed(Math.abs(n)<1&&n!==0?4:2)}</td>`;
    }
    return `<td>${v??'—'}</td>`;
  }).join('')}</tr>`).join('');
  document.getElementById('data-count').textContent=`총 ${total}행 중 ${rows.length}행 표시`;
  document.getElementById('data-tbl-title').textContent=`${ds} 데이터 (${total}건)`;
}

// ══════════════════════════════════════════════════════
//  CHART DEFAULTS
// ══════════════════════════════════════════════════════
Chart.defaults.font.family = 'IBM Plex Sans KR';
Chart.defaults.color = '#374151';

function baseBarOpts() {
  return {
    responsive:true, maintainAspectRatio:false,
    plugins:{legend:{display:false},tooltip:{callbacks:{label:ctx=>`${ctx.parsed.y?.toFixed?ctx.parsed.y.toFixed(2):ctx.parsed.y}`}}},
    scales:{
      x:{grid:{color:'#f3f4f6'},ticks:{color:'#6b7280',font:{size:10}}},
      y:{grid:{color:'#f3f4f6'},ticks:{color:'#6b7280',font:{size:10}}}
    }
  };
}
function baseLineOpts() {
  return {
    responsive:true, maintainAspectRatio:false,
    plugins:{legend:{display:true,position:'bottom',labels:{color:'#374151',font:{size:11}}}},
    scales:{
      x:{grid:{color:'#f3f4f6'},ticks:{color:'#6b7280'}},
      y:{grid:{color:'#f3f4f6'},ticks:{color:'#6b7280'}}
    }
  };
}
function baseScatterOpts(xl,yl) {
  return {
    responsive:true, maintainAspectRatio:false,
    plugins:{legend:{display:false}},
    scales:{
      x:{title:{display:true,text:xl,color:'#6b7280'},grid:{color:'#f3f4f6'},ticks:{color:'#6b7280'}},
      y:{title:{display:true,text:yl,color:'#6b7280'},grid:{color:'#f3f4f6'},ticks:{color:'#6b7280'}}
    }
  };
}

// ══════════════════════════════════════════════════════
//  INIT
// ══════════════════════════════════════════════════════
(async () => {
  await Promise.all([
    loadDomesticYear(2024),
    loadDomesticYear(2023),
    loadData('foreign','nps_site/data/foreign.json'),
    ensureSupport()
  ]);
  renderDash();
})();

// ══════════════════════════════════════════════════════════
//  실시간 팩터 계산 엔진 — targetDate 기준으로 동작
//  2025년+ NPS 미공개 구간에서 입력 날짜 기준으로 조회
// ══════════════════════════════════════════════════════════

// 주가 히스토리 조회 (targetDate 기준 N일치)
async function fetchPriceHistory(ticker, market, days=65, targetDate=null) {
  const sym  = market==='domestic' ? ticker+'.KS' : ticker;
  const base = targetDate ? new Date(targetDate) : new Date();
  const p2   = Math.floor(base.getTime()/1000);
  const p1   = p2 - 86400*(days+5);
  try {
    const url   = `https://query1.finance.yahoo.com/v8/finance/chart/${sym}?period1=${p1}&period2=${p2}&interval=1d`;
    const res   = await fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
      {signal:AbortSignal.timeout(8000)});
    if(!res.ok) return null;
    const d     = await res.json();
    const closes= d?.chart?.result?.[0]?.indicators?.quote?.[0]?.close||[];
    return closes.filter(v=>v!=null);
  } catch(e) { return null; }
}

// 국내 mom_score: targetDate 기준 최근 63거래일 수익률
async function calcMomScore(ticker, allPrices, targetDate=null) {
  const cacheKey = ticker + '|' + (targetDate||'today');
  if(!allPrices[cacheKey]) {
    allPrices[cacheKey] = await fetchPriceHistory(ticker, 'domestic', 70, targetDate);
  }
  const prices = allPrices[cacheKey];
  if(!prices || prices.length < 10) return null;
  const cur  = prices[prices.length-1];
  const base = prices[Math.max(0, prices.length-63)];
  return base>0 ? ((cur-base)/base*100) : null;
}

// 변동성 score: targetDate 기준 최근 60일 연간화 변동성
async function calcVolScore(ticker, allPrices, targetDate=null) {
  const cacheKey = ticker + '|' + (targetDate||'today');
  if(!allPrices[cacheKey]) {
    allPrices[cacheKey] = await fetchPriceHistory(ticker, 'domestic', 70, targetDate);
  }
  const prices = allPrices[cacheKey];
  if(!prices || prices.length < 10) return null;
  const rets = prices.slice(-60).map((p,i,a)=>i===0?0:(p-a[i-1])/a[i-1]).slice(1);
  const mean = rets.reduce((s,v)=>s+v,0)/rets.length;
  const std  = Math.sqrt(rets.reduce((s,v)=>s+(v-mean)**2,0)/rets.length);
  return std * Math.sqrt(252) * 100;
}

// DART 공시 점수: targetDate 기준 90일 전 ~ targetDate
async function calcDartScore(ticker, targetDate=null) {
  const base  = targetDate ? new Date(targetDate) : new Date();
  const end   = getDateStrFromDate(base, 0);
  const start = getDateStrFromDate(base, -90);
  try {
    const url   = `https://opendart.fss.or.kr/api/list.json?crtfc_key=sample&corp_code=${ticker}&bgn_de=${start}&end_de=${end}&page_count=10`;
    const proxy = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
    const res   = await fetch(proxy, {signal:AbortSignal.timeout(5000)});
    if(res.ok) {
      const d = await res.json();
      return Math.min(1, (d?.total_count||0)/20);
    }
  } catch(e) {}
  return 0.3;
}

// 날짜 유틸: baseDate 기준 offsetDays → 'YYYYMMDD'
function getDateStrFromDate(baseDate, offsetDays) {
  const d = new Date(baseDate);
  d.setDate(d.getDate() + offsetDays);
  return d.toISOString().slice(0,10).replace(/-/g,'');
}

// 기존 호환용 (오늘 기준)
function getDateStr(offsetDays) {
  return getDateStrFromDate(new Date(), offsetDays);
}

// 뉴스 조회: targetDate 이전 뉴스만 필터
async function fetchNews(ticker, name, n=45, targetDate=null) {
  const arts=[];
  const base     = targetDate ? new Date(targetDate) : new Date();
  const endStr   = base.toISOString().slice(0,10);
  const startDate= new Date(base); startDate.setDate(startDate.getDate()-90);
  const startStr = startDate.toISOString().slice(0,10);

  try {
    const url=`https://m.stock.naver.com/api/news/stock/${ticker}?pageSize=20&page=1`;
    const res=await fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,{signal:AbortSignal.timeout(6000)});
    if(res.ok){
      const d=await res.json();
      (d?.result?.articleList||[])
        .filter(a=>!targetDate||(a.datetime&&a.datetime.slice(0,10)<=endStr))
        .forEach(a=>arts.push((a.title||'')+' '+(a.summary||'')));
    }
  } catch(e){}

  if(arts.length<10){
    try{
      const g=`https://news.google.com/rss/search?q=${encodeURIComponent(name+' 주가')}&hl=ko&gl=KR&ceid=KR:ko&before=${endStr}&after=${startStr}`;
      const res2=await fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(g)}`,{signal:AbortSignal.timeout(6000)});
      if(res2.ok){
        const xml=await res2.text();
        [...xml.matchAll(/<title>([^<]+)<\/title>/g)].slice(1,16).forEach(m=>arts.push(m[1]));
      }
    }catch(e){}
  }
  return [...new Set(arts)].filter(a=>a.length>5).slice(0,n);
}

// Z-score: targetDate 기준 뉴스 감성분석
async function calcZscore(ticker, name, pipe, targetDate=null) {
  const arts = await fetchNews(ticker, name, 45, targetDate);
  if(!arts.length) return 0.5;
  const scores=[];
  for(const art of arts.slice(0,45)){
    try{
      if(pipe==='keyword'){ scores.push(kwSentiment(art)); continue; }
      const res=await pipe(art.slice(0,512));
      const lb=res[0]?.label||'LABEL_1', sc=res[0]?.score||0.5;
      scores.push(lb==='LABEL_2'?sc:lb==='LABEL_0'?-sc:0);
    }catch(e){scores.push(0);}
  }
  const mean=scores.reduce((s,v)=>s+v,0)/scores.length;
  const std=Math.sqrt(scores.reduce((s,v)=>s+(v-mean)**2,0)/scores.length)||0.01;
  return Math.max(0,Math.min(1,(mean/std+3)/6));
}

// 순위 정규화
function rankNorm(values) {
  const sorted = [...values].sort((a,b)=>a-b);
  return values.map(v=>{
    if(v===null||v===undefined) return 0.5;
    const rank = sorted.filter(s=>s<=v).length;
    return rank / sorted.length;
  });
}

// KoBERT 로딩
let _kbPipeline = null;
let _kbLoading  = false;

async function loadKoBERT() {
  if(_kbPipeline) return _kbPipeline;
  if(_kbLoading) { while(_kbLoading) await new Promise(r=>setTimeout(r,300)); return _kbPipeline; }
  _kbLoading = true;
  try {
    const {pipeline} = await import('https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2/dist/transformers.min.js');
    _kbPipeline = await pipeline('text-classification','snunlp/KR-FinBert-SC',{quantized:true});
  } catch(e) { _kbPipeline = 'keyword'; }
  _kbLoading = false;
  return _kbPipeline;
}

function kwSentiment(text) {
  const pos=['상승','급등','호실적','흑자','신고가','수주','계약','성장','호재','강세','증가','확대'];
  const neg=['하락','급락','적자','손실','부진','감소','우려','리스크','약세','악재','하회','축소'];
  let s=0; const t=text.toLowerCase();
  pos.forEach(k=>{if(t.includes(k))s+=1;}); neg.forEach(k=>{if(t.includes(k))s-=1;});
  return Math.max(-1,Math.min(1,s/5));
}

// 국내 Y_opt 실시간 재계산 (targetDate 기준)
async function recalcDomesticYopt(rows, onProgress, targetDate=null) {
  const priceCache = {};
  const momRaws=[], volRaws=[];

  for(let i=0;i<rows.length;i++){
    const r=rows[i];
    onProgress && onProgress(i, rows.length, r.name, 'mom/vol 조회');
    const [m,v] = await Promise.all([
      calcMomScore(r.ticker||'', priceCache, targetDate),
      calcVolScore(r.ticker||'', priceCache, targetDate)
    ]);
    momRaws.push(m ?? 0);
    volRaws.push(v ?? 30);
  }

  const momNorm = rankNorm(momRaws);
  const volNorm = rankNorm(volRaws);

  const result=[];
  for(let i=0;i<rows.length;i++){
    const r=rows[i];
    onProgress && onProgress(i, rows.length, r.name, 'DART/Y_opt');
    const dartSc = await calcDartScore(r.ticker||'', targetDate);
    const yNew = 0.688*momNorm[i]
               + 0.240*(+(r.trend_score||0))
               + 0.030*(+(r.value_score||0))
               + 0.029*dartSc
               + 0.007*volNorm[i]
               + 0.006*(+(r.weight_score||0));
    result.push({...r, Y_opt_rt: yNew, mom_rt: momNorm[i], vol_rt: volNorm[i]});
  }
  return result;
}

// 해외 Y_opt_D 실시간 재계산 (targetDate 기준)
async function recalcForeignYoptD(rows, onProgress, targetDate=null) {
  const result=[];
  for(let i=0;i<rows.length;i++){
    const r=rows[i];
    onProgress && onProgress(i, rows.length, r.ticker||r.name, 'sec_score');
    const secRow = DATA.fsec.find(s=>s.sector===getSector(r.ticker||''));
    const secScRt = secRow ? secRow.bavg : (+(r.sec_score||0));
    const w   = [-0.8524,-0.4204,-0.2346,-0.1714,-0.4450];
    const fts = ['value_score','stake_score','trend_score'];
    const raw = fts.reduce((s,f,i2)=>s+w[i2]*(+(r[f]??0)||0),0)
              + w[3]*secScRt + w[4]*(+(r.bulk??0)||0);
    result.push({...r, Y_opt_rt_raw: raw});
  }
  const raws=result.map(r=>r.Y_opt_rt_raw);
  const mn=Math.min(...raws), mx=Math.max(...raws);
  result.forEach(r=>{ r.Y_opt_score_rt = mx>mn ? (r.Y_opt_rt_raw-mn)/(mx-mn)*100 : 50; });
  return result;
}

// 진행상황 UI
function setForecastStatus(show, text='', pct=0, detail='') {
  let bar = document.getElementById('forecast-status-bar');
  if(!bar) {
    bar = document.createElement('div');
    bar.id = 'forecast-status-bar';
    bar.style.cssText='background:#fffbeb;border:1px solid #fde68a;border-radius:8px;padding:12px 16px;margin-top:12px;font-size:13px;color:#92400e;';
    const loading = document.getElementById('price-loading');
    loading && loading.parentNode.insertBefore(bar, loading);
  }
  bar.style.display = show ? 'block' : 'none';
  if(show) bar.innerHTML =
    '<div style="font-weight:600;margin-bottom:6px">🔄 '+text+'</div>'
   +'<div style="background:#fef3c7;border-radius:4px;height:8px;overflow:hidden;margin-bottom:4px">'
   +  '<div style="height:100%;background:#f59e0b;width:'+pct+'%;transition:width 0.3s"></div>'
   +'</div>'
   +'<div style="font-size:11px;color:#b45309">'+detail+'</div>';
}

// 2025+ 메인 실행 — targetDate를 모든 실시간 조회에 전달
async function runKobertForecast(allRows, market, amt, dateStr, topn, wmode, secData) {
  const yr = new Date(dateStr).getFullYear();
  const targetDate = dateStr; // ← 핵심: 입력 날짜 기준

  setForecastStatus(true, `${yr}년 실시간 팩터 계산 시작`, 5,
    `총 ${allRows.length}개 후보 종목 처리 중 (기준일: ${targetDate})`);

  let enriched;
  if(market==='domestic') {
    enriched = await recalcDomesticYopt(allRows, (i,tot,name,step)=>{
      setForecastStatus(true, `팩터 재계산: ${name}`, Math.round(i/tot*40),
        `[${i+1}/${tot}] ${step} (기준: ${targetDate})`);
    }, targetDate);
  } else {
    enriched = await recalcForeignYoptD(allRows, (i,tot,name,step)=>{
      setForecastStatus(true, `팩터 재계산: ${name}`, Math.round(i/tot*40),
        `[${i+1}/${tot}] (기준: ${targetDate})`);
    }, targetDate);
  }

  setForecastStatus(true, 'KoBERT 모델 로딩...', 42, 'snunlp/KR-FinBert-SC 로드 중');
  const pipe = await loadKoBERT();
  setForecastStatus(true, 'KoBERT Z-score 계산 중', 45,
    `종목당 뉴스 45건+ 감성분석 (기준: ${targetDate})`);

  for(let i=0;i<enriched.length;i++){
    const r=enriched[i];
    const pct2=45+Math.round(i/enriched.length*40);
    setForecastStatus(true, `[${i+1}/${enriched.length}] ${r.name||r.ticker} 감성분석`, pct2,
      `뉴스 수집 → KoBERT 추론 (기준: ${targetDate})`);
    const z = await calcZscore(r.ticker||'', r.name||r.ticker||'', pipe, targetDate);
    enriched[i] = {...r, Z_score_rt: z};
  }

  setForecastStatus(true, 'Final Score 계산 & 정렬...', 88, '');
  if(market==='domestic') {
    const yOpts = enriched.map(r=>r.Y_opt_rt||0);
    const mn=Math.min(...yOpts), mx=Math.max(...yOpts);
    enriched.forEach(r=>{
      const yN = mx>mn ? (r.Y_opt_rt-mn)/(mx-mn) : 0.5;
      r.Final_Score_rt = 0.852*yN + 0.148*(r.Z_score_rt||0.5);
    });
    enriched.sort((a,b)=>b.Final_Score_rt-a.Final_Score_rt);
  } else {
    enriched.forEach(r=>{
      const yN = (r.Y_opt_score_rt||50)/100;
      r.final_score_rt = 0.915*yN + 0.085*(r.Z_score_rt||0.5);
    });
    enriched.sort((a,b)=>b.final_score_rt-a.final_score_rt);
  }

  const topRows = enriched.slice(0,topn);
  const scoreKey2 = market==='domestic' ? 'Final_Score_rt' : 'final_score_rt';
  const rawWts2   = computeWeights(
    topRows.map(r=>({...r, Final_Score:r.Final_Score_rt, final_score_new:r.final_score_rt})),
    wmode, market, secData
  );
  const results2 = topRows.map((r,i)=>({
    ...r,
    modelRet: (market==='domestic'?0.852:0.915)*(+(r[scoreKey2]||0)-0.3)*143,
    w: rawWts2[i]*100,
    invest: amt*rawWts2[i]
  }));
  const portRet2 = results2.reduce((s,r)=>s+r.modelRet*(r.w/100),0);
  const portPnL2 = results2.reduce((s,r)=>s+r.invest*r.modelRet/100,0);

  kpi('date-kpi',[
    {label:'예상 수익률 (KoBERT)', value:`${portRet2>=0?'+':''}${portRet2.toFixed(2)}%`, trend:portRet2>0?'up':'down'},
    {label:'예상 손익', value:`${portPnL2>=0?'+':''}${portPnL2.toFixed(0)}만원`, trend:portPnL2>0?'up':'down'},
    {label:'평가금액', value:`${(amt+portPnL2).toFixed(0)}만원`},
    {label:'분석 기준일', value:targetDate, sub:`실시간 팩터 + KoBERT`},
  ]);

  mkChart('c-date-bar',{type:'bar',data:{
    labels:results2.map(r=>r.name?.slice(0,6)||r.ticker||'—'),
    datasets:[{label:'모델 예측(%)', data:results2.map(r=>r.modelRet),
      backgroundColor:results2.map(r=>r.modelRet>=0?'#1f2937':'#9ca3af')}]
  },options:baseBarOpts()});

  const tbody=document.getElementById('tbody-date');
  tbody.innerHTML=results2.map((r,i)=>{
    const sc=+(r[scoreKey2]||0);
    const pnl=r.invest*r.modelRet/100;
    return '<tr>'
      +'<td>'+(i+1)+'</td>'
      +'<td><b>'+(r.name||r.ticker)+'</b></td>'
      +'<td class="mono">'+(r.ticker||'—')+'</td>'
      +'<td>'+sc.toFixed(3)+'</td>'
      +'<td>'+r.w.toFixed(1)+'%</td>'
      +'<td>'+r.invest.toFixed(1)+'</td>'
      +'<td>'+(r.modelRet>=0?'+':'')+r.modelRet.toFixed(2)+'%</td>'
      +'<td id="price-est-'+i+'" class="mono">—</td>'
      +'<td id="price-real-'+i+'" class="mono">—</td>'
      +'<td id="hit-rate-'+i+'">—</td>'
      +'<td class="'+(pnl>=0?'pos':'neg')+'">'+(pnl>=0?'+':'')+pnl.toFixed(1)+'</td>'
      +'<td><span class="badge" style="background:#fef3c7;color:#92400e;border:1px solid #fde68a">KoBERT</span></td>'
      +'</tr>';
  }).join('');

  setForecastStatus(false);
  document.getElementById('price-loading').style.display='block';
  fetchStockPrices(results2, dateStr, market, false, new Date(dateStr)<new Date());
}
</script>
</body>
</html>
